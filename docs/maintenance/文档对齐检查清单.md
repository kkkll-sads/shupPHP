# 文档对齐检查清单

## 代理佣金系统文档对齐状态

> 更新时间：2025-12-27  
> 检查范围：所有涉及代理佣金和财务流向的文档

---

## 对齐检查表

| 文档名称 | 佣金字段 | 直推10% | 间推5% | 团队奖 | 同级奖10% | 详细说明 | 对齐状态 |
|---------|---------|---------|--------|--------|----------|---------|---------|
| **财务架构与资金流向分析.md** | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ 完整 | ✅ v5 |
| **代理佣金系统说明.md** | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ 专项 | ✅ 最新 |
| **money字段快速参考.md** | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ 代码示例 | ✅ 已更新 |
| **寄售业务逻辑说明.md** | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ 场景+退款 | ✅ 已更新 |
| **money字段架构调整说明.md** | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ 简要说明 | ✅ 已更新 |
| **更新日志_20251227.md** | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ 完整记录 | ✅ 21项修改 |

---

## 统一标准

### 1. 佣金发放字段
**统一使用：** `withdrawable_money`（可提现余额）

**禁止使用：** ~~`money`~~（总资产是派生值，不可直接写入）

### 2. 佣金类型与比例

| 佣金类型 | 默认比例 | 配置键 | 发放对象 | 发放字段 |
|---------|---------|--------|---------|---------|
| 直推佣金 | 10% | `agent_direct_rate` | 直接邀请人 | `withdrawable_money` |
| 间推佣金 | 5% | `agent_indirect_rate` | 二级邀请人 | `withdrawable_money` |
| 1级代理团队奖 | 9% | `agent_team_level1` | 1级代理 | `withdrawable_money` |
| 2级代理团队奖 | 3%（累计12%） | `agent_team_level2` | 2级代理 | `withdrawable_money` |
| 3级代理团队奖 | 3%（累计15%） | `agent_team_level3` | 3级代理 | `withdrawable_money` |
| 4级代理团队奖 | 3%（累计18%） | `agent_team_level4` | 4级代理 | `withdrawable_money` |
| 5级代理团队奖 | 3%（累计21%） | `agent_team_level5` | 5级代理 | `withdrawable_money` |
| 同级奖 | 10% | `agent_same_level_rate` | 同级代理 | `withdrawable_money` |

### 3. 团队奖分配规则

**正常情况（累计级差制）：**
- 按代理等级从低到高分配
- 每级代理拿级差部分（当前级累计 - 上级累计）
- 例如：2级代理拿 12% - 9% = 3%

**同级特殊处理：**
- 如果上级代理和下级代理是同一等级（user_type相同）
- 上级代理不按级差计算，改拿固定10%的同级奖
- 示例：两个1级代理，第二个拿10%同级奖而非0%

### 4. 佣金计算基数

**统一标准：** 卖家获得的利润（`$profit`）

**计算公式：**
```
利润 = 成交价 - 买入价
直推佣金 = 利润 × 10%
间推佣金 = 利润 × 5%
团队奖 = 利润 × 级差比例（或同级奖比例）
```

### 5. 统一话术

**业务员版本：**
> "代理佣金有三种：直推拿10%、间推拿5%、团队奖按级差分配。特殊情况：如果上级和下级是同一等级的代理，上级拿固定10%的同级奖。所有佣金都是从卖家的利润中抽取，全额进可提现余额。"

**技术文档版本：**
> 代理佣金系统采用累计制+同级特殊处理：正常按级差分配（1-5级：9%/12%/15%/18%/21%），同级代理拿固定10%。所有佣金全额发放到 `withdrawable_money` 字段。

---

## 核心原则

### ✅ 必须遵守的规则

1. **佣金发放字段**
   - ✅ 使用 `withdrawable_money`
   - ❌ 禁止使用 `money`

2. **佣金全额到账**
   - ✅ 佣金100%进可提现余额
   - ❌ 不切分到其他字段

3. **佣金来源明确**
   - ✅ 从卖家的利润中抽取
   - ❌ 不影响卖家本金和利润分配

4. **同级特殊处理**
   - ✅ 同级代理拿固定10%
   - ❌ 不按0%级差计算

5. **money字段只读**
   - ✅ money由四字段自动计算
   - ❌ 不直接写入money字段

### ⚠️ 常见错误

```php
// ❌ 错误：直接写入money
$agent->money += $commission;

// ✅ 正确：写入withdrawable_money
$agent->withdrawable_money += $commission;
```

```php
// ❌ 错误：佣金切分
$agent->withdrawable_money += $commission * 0.5;
$agent->score += $commission * 0.5;

// ✅ 正确：佣金全额到账
$agent->withdrawable_money += $commission;
```

---

## 文档更新历史

### 2025-12-27
- ✅ 更新5份核心文档
- ✅ 统一佣金发放字段为 `withdrawable_money`
- ✅ 补充代理佣金详细说明（三种类型+同级特殊处理）
- ✅ 新增业务员话术和代码示例
- ✅ 更新后台配置界面（新增同级奖配置项）
- ✅ 完成代码实现（CollectionItem.php、CollectionMatching.php）

---

## 验证清单

开发新功能或修改现有功能时，请确认：

- [ ] 涉及代理佣金的代码是否写入 `withdrawable_money`？
- [ ] 是否直接写入了 `money` 字段？（应禁止）
- [ ] 佣金是否全额到账（100%）？
- [ ] 是否正确处理了同级特殊情况？
- [ ] 日志记录是否正确（`user_money_log` 和 `user_activity_log`）？
- [ ] 是否在事务中执行？
- [ ] 相关文档是否需要更新？

---

## 相关文档链接

1. [财务架构与资金流向分析.md](./财务架构与资金流向分析.md) - 业务员版本
2. [代理佣金系统说明.md](./代理佣金系统说明.md) - 技术详细文档
3. [money字段快速参考.md](./money字段快速参考.md) - 开发快速参考
4. [寄售业务逻辑说明.md](./寄售业务逻辑说明.md) - 寄售流程说明
5. [money字段架构调整说明.md](./money字段架构调整说明.md) - 架构调整说明
6. [更新日志_20251227.md](./更新日志_20251227.md) - 详细修改记录

---

## 联系与反馈

如发现文档不一致或有疑问，请及时反馈并更新此检查清单。

**最后更新：** 2025-12-27  
**文档版本：** v1.1  
**对齐状态：** ✅ 全部对齐（含退款规则）

