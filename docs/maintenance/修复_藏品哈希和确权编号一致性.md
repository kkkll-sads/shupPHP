# 修复：藏品哈希和确权编号一致性

**修复日期：** 2026-01-02  
**问题类型：** 代码一致性修复  
**严重程度：** 高

---

## 一、问题描述

根据一致性检查报告，发现以下问题：

1. **模型字段名不一致**：模型事件中使用 `fingerprint` 属性，但数据库字段是 `tx_hash`
2. **哈希生成方式不一致**：AssetPackage 基于确权编号生成，模型事件随机生成
3. **控制器字段引用错误**：部分控制器仍使用 `fingerprint` 字段名

---

## 二、修复内容

### 2.1 修复模型字段名（`app/admin/model/CollectionItem.php`）

**修复前：**
```php
// 模型事件中使用 fingerprint（数据库字段不存在）
if (empty($item->fingerprint)) {
    $item->fingerprint = self::generateFingerprint();
}
```

**修复后：**
```php
// 使用正确的数据库字段名 tx_hash
if (empty($item->tx_hash)) {
    // 如果已有确权编号，基于确权编号生成哈希（与AssetPackage保持一致）
    if (!empty($item->asset_code)) {
        $item->tx_hash = self::generateFingerprintFromAssetCode($item->asset_code);
    } else {
        $item->tx_hash = self::generateFingerprint();
    }
}
```

**新增方法：**
```php
/**
 * 基于确权编号生成存证指纹（与AssetPackage生成方式保持一致）
 * 格式：0x + MD5(asset_code) 的32位十六进制
 */
protected static function generateFingerprintFromAssetCode(string $assetCode): string
{
    return '0x' . md5($assetCode);
}
```

### 2.2 修复控制器字段引用

#### 修复 `app/admin/controller/collection/Item.php`

**修复前：**
```php
$itemData['fingerprint'] = $this->generateFingerprint();
// ...
'fingerprint' => $item->fingerprint ?? '',
```

**修复后：**
```php
// 如果已有确权编号，基于确权编号生成；否则使用随机生成
if (!empty($itemData['asset_code'])) {
    $itemData['tx_hash'] = '0x' . md5($itemData['asset_code']);
} else {
    $itemData['tx_hash'] = $this->generateFingerprint();
}
// ...
'tx_hash' => $item->tx_hash ?? '',
```

#### 修复 `app/admin/controller/collection/UserCollection.php`

**修复前：**
```php
'ci.fingerprint',
```

**修复后：**
```php
'ci.tx_hash',
```

### 2.3 更新 PHPDoc 注释

**修复前：**
```php
/**
 * @property string|null $fingerprint
 */
```

**修复后：**
```php
/**
 * @property string|null $tx_hash 存证指纹（数据库字段名）
 */
```

---

## 三、哈希生成策略

### 3.1 统一策略

修复后，哈希生成采用以下统一策略：

1. **优先基于确权编号生成**：如果 `asset_code` 存在，使用 `MD5(asset_code)` 生成哈希
2. **兜底随机生成**：如果 `asset_code` 不存在，使用随机字节生成哈希

### 3.2 生成方式对比

| 位置 | 修复前 | 修复后 |
|------|--------|--------|
| AssetPackage | `MD5(asset_code + timestamp + seq + random)` | 保持不变（已有确权编号） |
| 模型事件 | 随机生成 | `MD5(asset_code)` 或随机生成 |
| Item控制器 | 随机生成 | `MD5(asset_code)` 或随机生成 |

**注意：** AssetPackage 中的哈希生成方式保持不变，因为它包含了额外的随机因子（timestamp + seq + random），这样生成的哈希更安全。模型事件中使用简单的 `MD5(asset_code)` 是为了保持一致性和可追溯性。

---

## 四、影响范围

### 4.1 修复的文件

1. `app/admin/model/CollectionItem.php` - 模型事件和字段定义
2. `app/admin/controller/collection/Item.php` - 控制器字段引用
3. `app/admin/controller/collection/UserCollection.php` - 查询字段引用

### 4.2 向后兼容性

- ✅ 数据库字段名 `tx_hash` 保持不变
- ✅ 现有数据不受影响（所有记录的 `tx_hash` 都有值）
- ✅ API 接口使用 `tx_hash` 字段，不受影响

---

## 五、测试建议

### 5.1 功能测试

1. **测试模型事件**：创建新藏品，验证 `tx_hash` 是否被正确设置
2. **测试控制器**：通过后台管理界面创建藏品，验证哈希生成
3. **测试API接口**：验证 API 返回的哈希值是否正确

### 5.2 数据验证

```sql
-- 检查是否有 tx_hash 为空的记录（应该为0）
SELECT COUNT(*) FROM ba_collection_item WHERE tx_hash IS NULL OR tx_hash = '';

-- 检查新创建的记录是否有正确的 tx_hash
SELECT id, asset_code, tx_hash, 
       CASE 
           WHEN tx_hash = CONCAT('0x', MD5(asset_code)) THEN 'based_on_asset_code'
           ELSE 'random'
       END as hash_type
FROM ba_collection_item 
WHERE create_time > UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 1 DAY))
ORDER BY id DESC
LIMIT 10;
```

---

## 六、相关文档

- 一致性检查报告：`docs/analysis/藏品哈希和确权编号一致性检查报告.md`
- 数据库字段说明：`docs/database/藏品相关字段完整列表.md`

---

**修复完成时间：** 2026-01-02  
**修复人员：** AI Assistant  
**验证状态：** ✅ 语法检查通过

<<<<<<< HEAD
=======

>>>>>>> 392e607a6782491114a0aee7408a7d620ecf394f

