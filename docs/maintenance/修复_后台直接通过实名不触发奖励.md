# 修复：后台用户管理直接通过实名认证不触发邀请奖励

**日期**：2025-12-27  
**问题类型**：Bug修复  
**严重程度**：中等

---

## 一、问题描述

### 1.1 用户反馈
用户反馈："推荐用户实名赠送奖励现在是人脸核身通过后才赠送吗？我在后台用户管理直接通过的用户没有赠送"

### 1.2 问题现象
- 通过**实名认证管理页面**审核通过 → ✅ 邀请人收到奖励
- 通过**后台用户管理页面**直接修改实名状态为"已通过" → ❌ 邀请人**没有**收到奖励

### 1.3 影响范围
- 影响时间：2025-12-27之前所有通过后台用户管理页面直接通过实名认证的用户
- 影响人数：需要查询数据库确定

---

## 二、问题根源

### 2.1 代码逻辑分析

#### 正确的流程（实名认证管理页面）
```
后台管理 → 实名认证管理 → 审核通过按钮
    ↓
app/admin/controller/user/RealName.php::approve()
    ↓
更新 real_name_status = 2
    ↓
调用 handleInviteReward() ✅ 发放邀请奖励
```

#### 有问题的流程（后台用户管理页面）
```
后台管理 → 用户管理 → 编辑用户 → 修改实名状态为"已通过"
    ↓
app/admin/controller/user/User.php::edit()
    ↓
更新 real_name_status = 2
    ↓
❌ 没有调用 handleInviteReward()
    ↓
邀请人没有收到奖励
```

### 2.2 代码证据

**前端用户编辑表单**：`web/src/views/backend/user/user/popupForm.vue`
```vue
<FormItem
    label="实名状态"
    v-model="baTable.form.items!.real_name_status"
    type="radio"
    :input-attr="{
        border: true,
        content: { 0: '未实名', 1: '待审核', 2: '已通过', 3: '已拒绝' },
    }"
/>
```

**后端 User.php 的 edit() 方法**：
- ✅ 可以修改 `real_name_status` 字段
- ❌ 但没有检测状态变更并触发邀请奖励

---

## 三、解决方案

### 3.1 代码修改

**文件**：`app/admin/controller/user/User.php`  
**方法**：`edit()`  
**位置**：第301行之前

**新增代码**：
```php
// 🆕 检查实名状态变更，触发邀请奖励
if (isset($data['real_name_status'])) {
    $oldRealNameStatus = (int)($row['real_name_status'] ?? 0);
    $newRealNameStatus = (int)$data['real_name_status'];
    
    // 如果实名状态从非"已通过"变为"已通过"（2），触发邀请奖励
    if ($oldRealNameStatus != 2 && $newRealNameStatus == 2) {
        $inviterId = (int)($row['inviter_id'] ?? 0);
        if ($inviterId > 0) {
            try {
                // 调用邀请奖励逻辑
                $listener = new \app\listener\UserRegisterSuccess();
                $listener->handleInviteReward($inviterId, $id);
                
                \think\facade\Log::info("后台用户管理修改实名状态触发邀请奖励成功：被邀请人ID={$id}, 邀请人ID={$inviterId}");
            } catch (\Throwable $e) {
                // 邀请奖励发放失败不影响实名审核结果
                \think\facade\Log::error("后台用户管理修改实名状态触发邀请奖励失败：被邀请人ID={$id}, 邀请人ID={$inviterId}, 错误：" . $e->getMessage());
            }
        }
    }
}
```

### 3.2 修复逻辑

#### 触发条件
1. `real_name_status` 字段有变更
2. 旧状态 ≠ 2（已通过）
3. 新状态 = 2（已通过）
4. 用户有邀请人（`inviter_id > 0`）

#### 执行流程
```
检测到实名状态变更
    ↓
判断：旧状态 ≠ 2 且 新状态 = 2？
    ↓ 是
检查是否有邀请人
    ↓ 有
调用 handleInviteReward()
    ↓
发放邀请奖励
    ↓
记录日志（成功/失败）
```

#### 安全机制
- ✅ 使用 try-catch 包裹，奖励发放失败不影响实名审核
- ✅ 记录详细日志，便于追踪问题
- ✅ 调用的是已有的 `handleInviteReward()` 方法，内部有防重复发放机制

---

## 四、历史数据修复

### 4.1 补发命令

**命令**：`php think repair:invite-reward`  
**文件**：`app/command/RepairInviteReward.php`

**功能**：
- 查找所有已实名认证（`real_name_status = 2`）的用户
- 检查其邀请人是否收到了邀请奖励
- 如果没有，则补发奖励

### 4.2 使用方法

#### 查看待修复数据
```bash
cd /opt/sqzx
php think repair:invite-reward
```

**示例输出**：
```
[2025-12-27 21:30:00] 开始检查需要补发邀请奖励的用户...
找到 5 个需要补发邀请奖励的用户：
  ✓ 用户 user001(ID:18) ← 邀请 user002(ID:20) 奖励补发成功
  ✓ 用户 user003(ID:22) ← 邀请 user004(ID:25) 奖励补发成功
  ✓ 用户 user005(ID:30) ← 邀请 user006(ID:35) 奖励补发成功
  ✗ 用户 user007(ID:40) ← 邀请 user008(ID:45) 奖励补发失败: 用户余额不足
  ✓ 用户 user009(ID:50) ← 邀请 user010(ID:55) 奖励补发成功

补发完成！成功: 4, 失败: 1
```

### 4.3 查询SQL（确认受影响用户）

```sql
-- 查找已实名但邀请人未收到奖励的用户
SELECT 
    u.id as invited_user_id,
    u.username as invited_username,
    u.inviter_id,
    u2.username as inviter_username,
    u.real_name_status
FROM ba_user u
LEFT JOIN ba_user u2 ON u.inviter_id = u2.id
LEFT JOIN ba_user_activity_log ual ON 
    ual.user_id = u.inviter_id 
    AND ual.related_user_id = u.id 
    AND ual.action_type = 'invite_reward'
WHERE u.real_name_status = 2  -- 已实名
  AND u.inviter_id > 0        -- 有邀请人
  AND ual.id IS NULL          -- 邀请人未收到奖励
ORDER BY u.id ASC;
```

---

## 五、测试验证

### 5.1 功能测试

#### 测试1：后台用户管理页面修改实名状态
**步骤**：
1. 进入后台管理 → 用户管理
2. 选择一个未实名的用户（real_name_status = 0 或 1）
3. 点击"编辑"按钮
4. 修改"实名状态"为"已通过"
5. 保存

**预期结果**：
- ✅ 用户的 `real_name_status` 更新为 2
- ✅ 邀请人收到邀请奖励（如果有邀请人）
- ✅ 日志中记录：`后台用户管理修改实名状态触发邀请奖励成功`

#### 测试2：实名认证管理页面审核通过
**步骤**：
1. 进入后台管理 → 实名认证管理
2. 选择一个待审核的用户
3. 点击"审核通过"按钮

**预期结果**：
- ✅ 用户的 `real_name_status` 更新为 2
- ✅ 邀请人收到邀请奖励（如果有邀请人）

#### 测试3：修改其他字段，不触发奖励
**步骤**：
1. 进入后台管理 → 用户管理
2. 编辑一个已实名的用户（real_name_status = 2）
3. 修改昵称、手机号等其他字段
4. 保存

**预期结果**：
- ✅ 用户信息更新成功
- ✅ **不触发**邀请奖励（因为 real_name_status 没有变更）

#### 测试4：重复修改实名状态，防重复发放
**步骤**：
1. 修改用户实名状态：0 → 2（第一次）
2. 修改用户实名状态：2 → 1（改回）
3. 修改用户实名状态：1 → 2（第二次）

**预期结果**：
- ✅ 第一次触发邀请奖励
- ✅ 第二次**不触发**邀请奖励（`handleInviteReward()` 内部有防重复机制）

### 5.2 日志验证

#### 成功日志
```
[2025-12-27 21:30:00] INFO think.Log: 后台用户管理修改实名状态触发邀请奖励成功：被邀请人ID=20, 邀请人ID=18
```

#### 失败日志
```
[2025-12-27 21:30:00] ERROR think.Log: 后台用户管理修改实名状态触发邀请奖励失败：被邀请人ID=25, 邀请人ID=22, 错误：邀请奖励已发放过，不再重复发放。邀请人ID: 22, 被邀请用户ID: 25
```

---

## 六、注意事项

### 6.1 防重复发放机制
`handleInviteReward()` 方法内部有检查逻辑：
```php
// 检查是否已发放过邀请奖励
$existingReward = UserActivityLog::where('user_id', $inviterId)
    ->where('related_user_id', $newUserId)
    ->where('action_type', 'invite_reward')
    ->find();
if ($existingReward) {
    Log::info("邀请奖励已发放过，不再重复发放。邀请人ID: {$inviterId}, 被邀请用户ID: {$newUserId}");
    return;
}
```

### 6.2 两种审核方式对比

| 特性 | 实名认证管理 | 用户管理 |
|------|-------------|---------|
| 入口 | 实名认证管理页面 | 用户管理页面 |
| 审核方式 | 专用审核按钮 | 编辑表单 |
| 触发奖励 | ✅ 支持（修复前） | ✅ 支持（修复后） |
| 审核备注 | ✅ 支持 | ❌ 不支持 |
| 审核记录 | ✅ 记录审核人和时间 | ⚠️ 部分记录 |
| 建议使用 | ✅ 推荐 | ⚠️ 仅用于快速修正 |

### 6.3 最佳实践
- ✅ **推荐**：使用**实名认证管理页面**进行正式审核
- ⚠️ **备用**：使用**用户管理页面**仅用于快速修正错误

---

## 七、相关文档

| 文档名称 | 路径 | 说明 |
|---------|------|------|
| 邀请奖励改为实名后发放 | `docs/更新日志_邀请奖励改为实名后发放.md` | 原需求文档 |
| 用户管理控制器 | `app/admin/controller/user/User.php` | 本次修复的文件 |
| 实名认证控制器 | `app/admin/controller/user/RealName.php` | 正确实现 |
| 补发命令 | `app/command/RepairInviteReward.php` | 历史数据修复 |

---

## 八、版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| v1.0 | 2025-12-27 | 邀请奖励改为实名后发放 |
| v1.1 | 2025-12-27 | 修复后台用户管理直接通过实名不触发奖励的问题 |

---

**文档状态**：✅ 已完成  
**最后更新**：2025-12-27  
**作者**：系统管理员

