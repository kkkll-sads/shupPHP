# 修复：购买记录接口添加确权编号和MD5指纹

**日期**：2025-12-27  
**问题类型**：功能增强  
**严重程度**：中等

---

## 一、问题描述

### 1.1 用户反馈
用户在调用购买记录接口（`GET /api/collectionItem/purchaseRecords`）时，发现返回的数据中**没有确权编号（asset_code）和MD5指纹（fingerprint）**字段，无法验证藏品的真伪和唯一性。

### 1.2 接口返回示例（修复前）

**请求**：
```
GET /api/collectionItem/purchaseRecords?page=1&type=hold
```

**响应**（部分）：
```json
{
    "code": 1,
    "data": {
        "list": [
            {
                "order_id": 125,
                "item_id": 21,
                "item_title": "富春山居图",
                "price": 532,
                "user_collection_id": 83,
                // ❌ 缺少 asset_code 和 fingerprint
            }
        ]
    }
}
```

### 1.3 影响范围
- 用户无法验证藏品真伪
- 无法通过确权编号查询藏品详情
- 无法进行防伪溯源

---

## 二、问题根源

### 2.1 代码分析

**文件**：`app/api/controller/CollectionItem.php`  
**方法**：`purchaseRecords()`

#### 原始查询逻辑
```php
// 只查询了基本字段，没有包含 asset_code 和 fingerprint
$userCollections = Db::name('user_collection')
    ->whereIn('order_id', $orderIds)
    ->where('user_id', $userId)
    ->field('id, order_id, delivery_status, consignment_status, buy_time')
    ->select()
    ->toArray();
```

#### 返回数据构建
```php
foreach ($list as &$row) {
    // ... 
    $row['user_collection_id'] = isset($firstUc['id']) ? (int)$firstUc['id'] : 0;
    // ❌ 没有添加 asset_code 和 fingerprint
}
```

### 2.2 数据表关系

```
ba_collection_order (订单表)
    ↓ order_id
ba_collection_order_item (订单明细表)
    ↓ item_id
ba_user_collection (用户藏品表) ← asset_code, tx_hash 在这里
    ↓ item_id
ba_collection_item (藏品模板表) ← asset_code, fingerprint 也在这里
```

---

## 三、解决方案

### 3.1 修改内容

#### 修改1：扩展查询字段
```php
// 🆕 新增 asset_code, tx_hash, item_id 字段
$userCollections = Db::name('user_collection')
    ->whereIn('order_id', $orderIds)
    ->where('user_id', $userId)
    ->field('id, order_id, delivery_status, consignment_status, buy_time, asset_code, tx_hash, item_id')
    ->select()
    ->toArray();
```

#### 修改2：添加返回字段
```php
// 初始化字段
$row['asset_code'] = '';
$row['fingerprint'] = '';

if (!empty($orderCollections)) {
    $firstUc = current($orderCollections);
    
    // 🆕 从 user_collection 获取确权编号和指纹
    $row['asset_code'] = $firstUc['asset_code'] ?? '';
    $row['fingerprint'] = $firstUc['tx_hash'] ?? '';
    
    // 🆕 如果 user_collection 中没有，从 collection_item 表中获取
    if (empty($row['asset_code']) || empty($row['fingerprint'])) {
        $itemId = $firstUc['item_id'] ?? $row['item_id'];
        if ($itemId) {
            $itemInfo = Db::name('collection_item')
                ->where('id', $itemId)
                ->field('asset_code, fingerprint')
                ->find();
            if ($itemInfo) {
                if (empty($row['asset_code'])) {
                    $row['asset_code'] = $itemInfo['asset_code'] ?? '';
                }
                if (empty($row['fingerprint'])) {
                    $row['fingerprint'] = $itemInfo['fingerprint'] ?? '';
                }
            }
        }
    }
}
```

#### 修改3：更新API文档注解
```php
#[
    Apidoc\Title("购买记录列表"),
    Apidoc\Tag("藏品商城,我的订单"),
    Apidoc\Method("GET"),
    Apidoc\Url("/api/collectionItem/purchaseRecords"),
    Apidoc\Header(name: "batoken", type: "string", require: true, desc: "用户登录Token"),
    Apidoc\Query(name: "page", type: "int", require: false, desc: "页码", default: "1"),
    Apidoc\Query(name: "limit", type: "int", require: false, desc: "每页数量(最大50)", default: "10"),
    Apidoc\Returned("list[].asset_code", type: "string", desc: "确权编号"),
    Apidoc\Returned("list[].fingerprint", type: "string", desc: "MD5存证指纹"),
    Apidoc\Returned("list[].user_collection_id", type: "int", desc: "用户藏品ID"),
]
```

### 3.2 获取逻辑

#### 优先级
1. **优先**：从 `user_collection` 表获取（每个用户藏品的独立确权编号和指纹）
2. **备用**：如果 `user_collection` 没有，从 `collection_item` 表获取（藏品模板的确权编号和指纹）

#### 原因说明
- `user_collection.asset_code`：用户藏品的确权编号，创建时自动生成
- `user_collection.tx_hash`：用户藏品的MD5指纹，创建时自动生成
- `collection_item.asset_code`：藏品模板的确权编号（兜底）
- `collection_item.fingerprint`：藏品模板的MD5指纹（兜底）

---

## 四、修复后的效果

### 4.1 接口返回示例（修复后）

**请求**：
```
GET /api/collectionItem/purchaseRecords?page=1&type=hold
```

**响应**（部分）：
```json
{
    "code": 1,
    "data": {
        "list": [
            {
                "order_id": 125,
                "item_id": 21,
                "item_title": "富春山居图",
                "price": 532,
                "user_collection_id": 83,
                "asset_code": "37-DATA-0001-000083",
                "fingerprint": "0x1a2b3c4d5e6f7890abcdef1234567890"
            }
        ]
    }
}
```

### 4.2 字段说明

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `asset_code` | string | 确权编号（防伪溯源） | `37-DATA-0001-000083` |
| `fingerprint` | string | MD5存证指纹（唯一性验证） | `0x1a2b3c4d...` |
| `user_collection_id` | int | 用户藏品ID | `83` |

---

## 五、业务价值

### 5.1 用户端
- ✅ **防伪验证**：通过确权编号和MD5指纹验证藏品真伪
- ✅ **溯源查询**：可以通过 `/api/collectionItem/queryByCode` 接口查询藏品详情
- ✅ **唯一性确认**：每个藏品都有独立的确权编号和指纹

### 5.2 运营端
- ✅ **用户信任**：提供完整的防伪信息，增强用户信任
- ✅ **问题追溯**：出现问题时可以通过确权编号快速定位
- ✅ **数据完整性**：确保购买记录包含所有关键信息

---

## 六、测试验证

### 6.1 功能测试

#### 测试1：查询购买记录
**步骤**：
1. 登录用户
2. 调用 `GET /api/collectionItem/purchaseRecords?page=1`

**预期结果**：
- ✅ 返回购买记录列表
- ✅ 每条记录包含 `asset_code` 和 `fingerprint`
- ✅ 如果藏品已生成确权信息，则显示具体值
- ✅ 如果藏品未生成确权信息，则显示空字符串

#### 测试2：防伪验证
**步骤**：
1. 从购买记录中获取 `asset_code`
2. 调用 `GET /api/collectionItem/queryByCode?code={asset_code}`

**预期结果**：
- ✅ 能够查询到对应的藏品详情
- ✅ 藏品信息与购买记录一致

#### 测试3：空值处理
**步骤**：
1. 查询一个刚购买、尚未生成确权信息的藏品

**预期结果**：
- ✅ `asset_code` 和 `fingerprint` 为空字符串
- ✅ 不报错，正常返回其他字段

---

## 七、兼容性说明

### 7.1 向下兼容
- ✅ 新增字段，不影响现有字段
- ✅ 旧版本前端忽略新字段即可
- ✅ 新版本前端可以使用新字段

### 7.2 前端适配建议

#### 显示确权编号
```vue
<template>
  <div class="purchase-item">
    <div class="item-title">{{ item.item_title }}</div>
    <div class="item-code" v-if="item.asset_code">
      确权编号：{{ item.asset_code }}
    </div>
    <div class="item-fingerprint" v-if="item.fingerprint">
      存证指纹：{{ maskFingerprint(item.fingerprint) }}
    </div>
  </div>
</template>

<script setup>
const maskFingerprint = (fingerprint) => {
  if (!fingerprint || fingerprint.length <= 20) return fingerprint;
  return fingerprint.substring(0, 10) + '...' + fingerprint.substring(fingerprint.length - 10);
}
</script>
```

#### 点击查看详情
```javascript
const viewAssetDetail = (asset_code) => {
  if (!asset_code) {
    return ElMessage.warning('该藏品尚未生成确权编号');
  }
  
  // 调用防伪查询接口
  fetch(`/api/collectionItem/queryByCode?code=${encodeURIComponent(asset_code)}`)
    .then(res => res.json())
    .then(data => {
      if (data.code === 1) {
        // 显示藏品详情
        showAssetDetail(data.data);
      }
    });
}
```

---

## 八、注意事项

### 8.1 确权编号生成时机
- 藏品购买后，确权编号和MD5指纹会**自动生成**
- 如果查询时为空，可能是：
  1. 藏品刚购买，尚未生成
  2. 系统故障导致未生成
  3. 旧数据（购买时系统未实现该功能）

### 8.2 旧数据处理
对于旧数据（购买时未生成确权编号），建议：
1. 运行数据修复脚本，为所有用户藏品生成确权编号和指纹
2. 或在查询时动态生成并回写到数据库

### 8.3 性能考虑
- 如果 `user_collection` 中已有确权信息，无需额外查询
- 只有当 `user_collection` 中没有时，才会查询 `collection_item` 表
- 性能影响：每个订单额外查询1次（仅在缺少数据时）

---

## 九、相关接口

| 接口 | 说明 | 使用场景 |
|------|------|----------|
| `GET /api/collectionItem/purchaseRecords` | 购买记录列表 | 查看自己的购买记录 |
| `GET /api/collectionItem/queryByCode` | 通过确权编号查询藏品 | 防伪验证、溯源查询 |
| `GET /api/collectionItem/detail` | 藏品详情 | 查看藏品完整信息 |

---

## 十、相关文档

| 文档名称 | 路径 | 说明 |
|---------|------|------|
| 购买记录接口 | `app/api/controller/CollectionItem.php::purchaseRecords()` | 本次修复的接口 |
| 防伪查询接口 | `app/api/controller/CollectionItem.php::queryByCode()` | 配套使用的查询接口 |
| 防伪查询文档 | `docs/API接口_通过确权编号或MD5查询藏品.md` | 防伪查询功能说明 |

---

**文档状态**：✅ 已完成  
**最后更新**：2025-12-27  
**版本**：v1.0

