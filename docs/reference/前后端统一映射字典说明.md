# 前后端统一映射字典说明

## 概述

为了确保前后端状态码、枚举值、文本映射的一致性，系统提供了统一的映射字典。

**后端文件**：`app/common/library/StatusDict.php`  
**前端文件**：`web/src/utils/statusDict.ts`  
**API接口**：`GET /api/Common/statusDict`

---

## 一、后端使用

### 1. 引入类

```php
use app\common\library\StatusDict;
```

### 2. 获取状态文本

```php
// 方式1：使用工具方法
$text = StatusDict::getStatusText('consignment_status', 1);
// 返回：'寄售中'

// 方式2：直接获取映射数组
$map = StatusDict::getConsignmentStatusMap();
$text = $map[1] ?? '未知';
// 返回：'寄售中'
```

### 3. 在API中使用

```php
// 在API响应中添加状态文本
$item['consignment_status_text'] = StatusDict::getStatusText(
    'consignment_status', 
    $item['consignment_status']
);

// 或使用常量
$item['consignment_status_text'] = StatusDict::getConsignmentStatusMap()[
    StatusDict::CONSIGNMENT_STATUS_SELLING
] ?? '未知';
```

### 4. 获取所有映射字典

```php
// 获取所有映射字典（用于API返回）
$allMaps = StatusDict::getAllMaps();
```

---

## 二、前端使用

### 1. 引入模块

```typescript
import { 
  ConsignmentStatus, 
  ConsignmentStatusMap,
  getStatusText 
} from '@/utils/statusDict'
```

### 2. 获取状态文本

```typescript
// 方式1：使用工具方法
const text = getStatusText(ConsignmentStatusMap, ConsignmentStatus.SELLING)
// 返回：'寄售中'

// 方式2：直接使用映射对象
const text = ConsignmentStatusMap[ConsignmentStatus.SELLING]
// 返回：'寄售中'
```

### 3. 在组件中使用

```vue
<template>
  <el-tag :type="getTagType(item.consignment_status)">
    {{ getConsignmentStatusText(item.consignment_status) }}
  </el-tag>
</template>

<script setup lang="ts">
import { ConsignmentStatus, ConsignmentStatusMap, getStatusText } from '@/utils/statusDict'

function getConsignmentStatusText(status: number): string {
  return getStatusText(ConsignmentStatusMap, status as ConsignmentStatus)
}

function getTagType(status: number): string {
  switch (status) {
    case ConsignmentStatus.NONE:
      return 'info'
    case ConsignmentStatus.SELLING:
      return 'warning'
    case ConsignmentStatus.SOLD:
      return 'success'
    default:
      return 'info'
  }
}
</script>
```

### 4. 从API获取映射字典

```typescript
// 在应用启动时获取所有映射字典
import axios from 'axios'

async function loadStatusDicts() {
  const response = await axios.get('/api/Common/statusDict')
  const dicts = response.data.data.dicts
  // 使用 dicts 进行状态映射
}
```

---

## 三、映射字典列表

### 1. 藏品相关

| 类型 | 常量前缀 | 说明 |
|------|---------|------|
| `item_status` | `ITEM_STATUS_` | 藏品商品上架状态 |
| `consignment_status` | `CONSIGNMENT_STATUS_` | 用户藏品寄售状态 |
| `consignment_record_status` | `CONSIGNMENT_RECORD_STATUS_` | 寄售记录状态 |
| `mining_status` | `MINING_STATUS_` | 用户藏品矿机状态 |
| `delivery_status` | `DELIVERY_STATUS_` | 用户藏品提货状态 |

### 2. 订单相关

| 类型 | 常量前缀 | 说明 |
|------|---------|------|
| `order_status` | `ORDER_STATUS_` | 藏品订单状态 |
| `shop_order_status` | `SHOP_ORDER_STATUS_` | 商城订单状态 |
| `pay_type` | `PAY_TYPE_` | 支付方式 |

### 3. 撮合相关

| 类型 | 常量前缀 | 说明 |
|------|---------|------|
| `matching_status` | `MATCHING_STATUS_` | 撮合池状态 |
| `reservation_status` | `RESERVATION_STATUS_` | 盲盒预约状态 |

### 4. 场次相关

| 类型 | 常量前缀 | 说明 |
|------|---------|------|
| `session_status` | `SESSION_STATUS_` | 场次状态 |

### 5. 用户相关

| 类型 | 常量前缀 | 说明 |
|------|---------|------|
| `real_name_status` | `REAL_NAME_STATUS_` | 实名认证状态 |
| `user_status` | `USER_STATUS_` | 用户状态 |

### 6. 资金相关

| 类型 | 常量前缀 | 说明 |
|------|---------|------|
| `account_type` | `ACCOUNT_TYPE_` | 资金类型（账户类型） |
| `flow_direction` | `FLOW_DIRECTION_` | 资金流向 |

### 7. 其他

| 类型 | 常量前缀 | 说明 |
|------|---------|------|
| `coupon_status` | `COUPON_STATUS_` | 寄售券状态 |
| `asset_package_status` | `ASSET_PACKAGE_STATUS_` | 资产包状态 |
| `waive_type` | `WAIVE_TYPE_` | 寄售豁免类型 |
| `settle_status` | `SETTLE_STATUS_` | 结算状态 |

---

## 四、状态值定义

### 1. 藏品商品上架状态

| 值 | 常量 | 文本 |
|---|------|------|
| `'0'` | `ITEM_STATUS_OFFLINE` | 下架 |
| `'1'` | `ITEM_STATUS_ONLINE` | 上架 |

### 2. 用户藏品寄售状态

| 值 | 常量 | 文本 |
|---|------|------|
| `0` | `CONSIGNMENT_STATUS_NONE` | 未寄售 |
| `1` | `CONSIGNMENT_STATUS_SELLING` | 寄售中 |
| `2` | `CONSIGNMENT_STATUS_SOLD` | 已售出 |
| `3` | `CONSIGNMENT_STATUS_FAILED` | 寄售失败 |

### 3. 用户藏品矿机状态

| 值 | 常量 | 文本 |
|---|------|------|
| `0` | `MINING_STATUS_NORMAL` | 正常 |
| `1` | `MINING_STATUS_MINING` | 矿机运行中 |

### 4. 用户藏品提货状态

| 值 | 常量 | 文本 |
|---|------|------|
| `0` | `DELIVERY_STATUS_NOT_DELIVERED` | 未提货 |
| `1` | `DELIVERY_STATUS_DELIVERED` | 已提货 |

### 5. 订单状态

| 值 | 常量 | 文本 |
|---|------|------|
| `'pending'` | `ORDER_STATUS_PENDING` | 待支付 |
| `'paid'` | `ORDER_STATUS_PAID` | 已支付 |
| `'completed'` | `ORDER_STATUS_COMPLETED` | 已完成 |
| `'cancelled'` | `ORDER_STATUS_CANCELLED` | 已取消 |
| `'refunded'` | `ORDER_STATUS_REFUNDED` | 已退款 |

### 6. 支付方式

| 值 | 常量 | 文本 |
|---|------|------|
| `'money'` | `PAY_TYPE_MONEY` | 余额支付 |
| `'score'` | `PAY_TYPE_SCORE` | 消费金支付 |

### 7. 盲盒预约状态

| 值 | 常量 | 文本 |
|---|------|------|
| `0` | `RESERVATION_STATUS_PENDING` | 待撮合 |
| `1` | `RESERVATION_STATUS_MATCHED` | 已中签 |
| `2` | `RESERVATION_STATUS_FAILED` | 未中签 |
| `3` | `RESERVATION_STATUS_CANCELLED` | 已取消 |

### 8. 资金类型（账户类型）

| 值 | 常量 | 文本 |
|---|------|------|
| `'balance_available'` | `ACCOUNT_TYPE_BALANCE_AVAILABLE` | 专项金 |
| `'withdrawable_money'` | `ACCOUNT_TYPE_WITHDRAWABLE_MONEY` | 可提现金额 |
| `'service_fee_balance'` | `ACCOUNT_TYPE_SERVICE_FEE_BALANCE` | 确权金 |
| `'score'` | `ACCOUNT_TYPE_SCORE` | 消费金 |
| `'green_power'` | `ACCOUNT_TYPE_GREEN_POWER` | 绿色算力 |
| `'pending_activation_gold'` | `ACCOUNT_TYPE_PENDING_ACTIVATION_GOLD` | 待激活确权金 |

### 9. 实名认证状态

| 值 | 常量 | 文本 |
|---|------|------|
| `0` | `REAL_NAME_STATUS_NONE` | 未实名 |
| `1` | `REAL_NAME_STATUS_PENDING` | 待审核 |
| `2` | `REAL_NAME_STATUS_APPROVED` | 已通过 |
| `3` | `REAL_NAME_STATUS_REJECTED` | 已拒绝 |

### 10. 寄售券豁免类型

| 值 | 常量 | 文本 |
|---|------|------|
| `'none'` | `WAIVE_TYPE_NONE` | 正常扣券 |
| `'system_resend'` | `WAIVE_TYPE_SYSTEM_RESEND` | 系统重发 |
| `'free_attempt'` | `WAIVE_TYPE_FREE_ATTEMPT` | 免费次数 |

---

## 五、最佳实践

### 1. 后端

```php
// ✅ 推荐：使用 StatusDict 类
$item['consignment_status_text'] = StatusDict::getStatusText(
    'consignment_status', 
    $item['consignment_status']
);

// ❌ 不推荐：硬编码映射
$statusMap = [0 => '未寄售', 1 => '寄售中', 2 => '已售出'];
$item['consignment_status_text'] = $statusMap[$item['consignment_status']] ?? '未知';
```

### 2. 前端

```typescript
// ✅ 推荐：使用 statusDict.ts
import { ConsignmentStatusMap, getStatusText } from '@/utils/statusDict'
const text = getStatusText(ConsignmentStatusMap, status)

// ❌ 不推荐：硬编码映射
const statusMap: Record<number, string> = {
  0: '未寄售',
  1: '寄售中',
  2: '已售出'
}
const text = statusMap[status] ?? '未知'
```

### 3. 状态判断

```php
// ✅ 推荐：使用常量
if ($item['consignment_status'] == StatusDict::CONSIGNMENT_STATUS_SELLING) {
    // 处理寄售中逻辑
}

// ❌ 不推荐：硬编码数字
if ($item['consignment_status'] == 1) {
    // 处理寄售中逻辑
}
```

```typescript
// ✅ 推荐：使用枚举
if (item.consignment_status === ConsignmentStatus.SELLING) {
  // 处理寄售中逻辑
}

// ❌ 不推荐：硬编码数字
if (item.consignment_status === 1) {
  // 处理寄售中逻辑
}
```

---

## 六、API接口

### GET /api/Common/statusDict

**功能**：获取所有状态映射字典

**请求参数**：无

**响应示例**：
```json
{
  "code": 1,
  "message": "success",
  "data": {
    "dicts": {
      "item_status": {
        "0": "下架",
        "1": "上架"
      },
      "consignment_status": {
        "0": "未寄售",
        "1": "寄售中",
        "2": "已售出",
        "3": "寄售失败"
      },
      "mining_status": {
        "0": "正常",
        "1": "矿机运行中"
      },
      // ... 其他映射字典
    }
  }
}
```

**使用场景**：
- 前端应用启动时获取所有映射字典
- 动态更新状态文本（无需重新部署前端）
- 确保前后端状态映射一致

---

## 七、维护说明

### 1. 添加新状态

1. **后端**：在 `StatusDict.php` 中添加常量、映射方法和工具方法
2. **前端**：在 `statusDict.ts` 中添加枚举、映射对象和工具方法
3. **文档**：更新本文档的状态值定义部分

### 2. 修改状态文本

1. **后端**：修改 `StatusDict.php` 中对应的映射方法
2. **前端**：修改 `statusDict.ts` 中对应的映射对象
3. **验证**：确保前后端文本一致

### 3. 版本控制

- 状态值（常量）一旦确定，不应随意修改
- 状态文本可以修改，但应保持语义一致
- 重大变更应记录在 CHANGELOG 中

---

## 八、注意事项

1. **类型一致性**：确保前后端状态值的类型一致（数字 vs 字符串）
2. **常量使用**：优先使用常量而非硬编码值
3. **向后兼容**：修改状态时应考虑向后兼容性
4. **文档同步**：修改映射字典后应及时更新文档

---

## 九、相关文件

- **后端映射字典**：`app/common/library/StatusDict.php`
- **前端映射字典**：`web/src/utils/statusDict.ts`
- **API接口**：`app/api/controller/Common.php::statusDict()`
- **本文档**：`docs/reference/前后端统一映射字典说明.md`


<<<<<<< HEAD
=======

>>>>>>> 392e607a6782491114a0aee7408a7d620ecf394f

