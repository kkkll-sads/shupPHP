# 藏品哈希和确权编号一致性检查报告

**检查日期：** 2026-01-02  
**检查范围：** 藏品商城哈希生成和确权编号生成逻辑

---

## 一、问题概述

检查发现以下**不一致**问题：

### 🔴 严重问题

1. **模型字段名不一致**：模型使用 `fingerprint`，数据库字段是 `tx_hash`
2. **哈希生成方式不一致**：两种不同的生成方式
3. **确权编号生成格式不一致**：两处使用不同格式

---

## 二、详细分析

### 2.1 数据库字段情况

**表名：** `ba_collection_item`

| 字段名 | 类型 | 说明 | 状态 |
|--------|------|------|------|
| `asset_code` | varchar(50) | 确权编号 | ✅ 存在 |
| `tx_hash` | varchar(64) | 存证指纹 | ✅ 存在 |
| `fingerprint` | - | - | ❌ **不存在** |

**结论：** 数据库中没有 `fingerprint` 字段，只有 `tx_hash` 字段。

---

### 2.2 代码中的使用情况

#### 问题1：模型事件中使用 `fingerprint` 但数据库字段是 `tx_hash`

**文件：** `app/admin/model/CollectionItem.php`

```php
// 模型事件：创建前自动设置发行价
public static function onBeforeInsert($item)
{
    // ...
    // 新增时若未填写存证指纹则自动生成
    if (empty($item->fingerprint)) {  // ❌ 使用了 fingerprint
        $item->fingerprint = self::generateFingerprint();  // ❌ 使用了 fingerprint
    }
}
```

**问题：** 模型事件中使用了 `fingerprint` 属性，但数据库实际字段是 `tx_hash`。如果模型没有字段映射，这会导致数据无法正确保存。

**需要检查：** 模型是否有字段映射配置，将 `fingerprint` 映射到 `tx_hash`。

---

#### 问题2：哈希生成方式不一致

##### 方式1：AssetPackage生成藏品时（基于确权编号生成）

**文件：** `app/admin/controller/collection/AssetPackage.php:385`

```php
// 生成确权编号：37-DATA-{包ID(4位)}-{序号(4位)}
$assetCode = sprintf('37-DATA-%04d-%04d', $packageId, $seq);

// 生成MD5指纹（基于确权编号）
$fingerprint = '0x' . md5($assetCode . $now . $seq . mt_rand());

$items[] = [
    // ...
    'asset_code' => $assetCode,
    'tx_hash' => $fingerprint,  // ✅ 保存到 tx_hash 字段
    // ...
];
```

**特点：**
- 哈希是基于 `asset_code` 生成的
- 使用 MD5 算法
- 格式：`0x` + 32位十六进制

##### 方式2：模型事件中生成（随机生成）

**文件：** `app/admin/model/CollectionItem.php:91`

```php
protected static function generateFingerprint(): string
{
    $hex = '';
    try {
        $hex = bin2hex(random_bytes(16));  // 随机生成
    } catch (\Throwable) {
        $hex = md5(uniqid((string)microtime(true), true));  // 备用随机生成
    }
    return '0x' . $hex;
}
```

**特点：**
- 哈希是**随机生成**的，与确权编号无关
- 使用随机字节或 MD5(uniqid)
- 格式：`0x` + 32位十六进制

**问题：** 两种生成方式不一致，导致：
- AssetPackage生成的哈希与确权编号**有关联**
- 模型事件生成的哈希与确权编号**无关联**

---

#### 问题3：确权编号生成格式不一致

##### 格式1：AssetPackage生成（包ID + 序号）

**文件：** `app/admin/controller/collection/AssetPackage.php:382`

```php
// 生成确权编号：37-DATA-{包ID(4位)}-{序号(4位)}
$assetCode = sprintf('37-DATA-%04d-%04d', $packageId, $seq);
// 示例：37-DATA-0001-0001
```

**格式：** `37-DATA-{包ID(4位)}-{序号(4位)}`

##### 格式2：UserCollection生成（场次ID + 用户藏品ID）

**文件：** `app/api/controller/UserCollection.php:105`

```php
// 资产编号优先使用商品层的通用配置，如果商品层没配则尝试生成
$assetCode = $item['item_asset_code'] ?? null;
if (empty($assetCode)) {
    $assetCode = '37-DATA-' . str_pad((string)($item['session_id'] ?? 0), 4, '0', STR_PAD_LEFT) . '-' . str_pad((string)$userCollectionId, 6, '0', STR_PAD_LEFT);
}
// 示例：37-DATA-0001-000083
```

**格式：** `37-DATA-{场次ID(4位)}-{用户藏品ID(6位)}`

**问题：** 两种格式不一致：
- AssetPackage：`37-DATA-{包ID(4位)}-{序号(4位)}`
- UserCollection：`37-DATA-{场次ID(4位)}-{用户藏品ID(6位)}`

**影响：** 
- 同一藏品的确权编号可能在两个地方生成不同格式
- 但代码中优先使用 `collection_item.asset_code`，所以 UserCollection 中的生成逻辑通常不会执行

---

### 2.3 API接口中的使用

#### API接口中的哈希处理

**文件：** `app/api/controller/CollectionItem.php`

```php
// Hash 统一回退逻辑
$realHash = $item['rights_hash'] ?? null;
if (empty($realHash)) {
    $realHash = $item['hash'] ?? null;  // hash 来自 tx_hash
}
if (empty($realHash)) {
    $realHash = md5($item['id'] . 'USER_COLLECTION_SALT_2025');  // 兜底生成
}
$item['hash'] = $realHash;
```

**查询时使用 `tx_hash`：**

```php
->field([
    'i.tx_hash as hash',  // ✅ 正确使用 tx_hash 字段
    // ...
])
```

**结论：** API接口中正确使用了 `tx_hash` 字段，并且有回退逻辑。

---

## 三、问题总结

### 3.1 关键问题列表

| 问题 | 严重程度 | 位置 | 说明 |
|------|---------|------|------|
| 模型使用 `fingerprint` 但数据库是 `tx_hash` | 🔴 高 | `app/admin/model/CollectionItem.php` | 可能导致数据无法保存 |
| 哈希生成方式不一致 | 🟡 中 | AssetPackage vs 模型事件 | 一个基于asset_code，一个随机生成 |
| 确权编号格式不一致 | 🟢 低 | AssetPackage vs UserCollection | 但UserCollection中优先使用item.asset_code，通常不会执行生成逻辑 |

---

## 四、建议修复方案

### 4.1 修复模型字段映射（高优先级）

**方案1：添加字段映射（推荐）**

在 `CollectionItem` 模型中添加字段映射：

```php
// app/admin/model/CollectionItem.php

protected $field = [
    'fingerprint' => 'tx_hash',  // 将 fingerprint 映射到 tx_hash
];
```

**方案2：直接使用 `tx_hash`（更直接）**

修改模型事件，直接使用 `tx_hash`：

```php
public static function onBeforeInsert($item)
{
    // ...
    if (empty($item->tx_hash)) {  // 改为 tx_hash
        $item->tx_hash = self::generateFingerprint();
    }
}
```

---

### 4.2 统一哈希生成方式（中优先级）

**建议：** 统一使用基于确权编号的哈希生成方式（AssetPackage的方式）

**原因：**
- 哈希与确权编号关联，便于验证和追溯
- 确权编号是唯一的，基于它生成的哈希也具有唯一性

**修改模型事件中的生成方法：**

```php
protected static function generateFingerprint($assetCode = null): string
{
    if ($assetCode) {
        // 如果提供了确权编号，基于它生成哈希
        return '0x' . md5($assetCode);
    }
    
    // 否则使用随机生成（向后兼容）
    $hex = '';
    try {
        $hex = bin2hex(random_bytes(16));
    } catch (\Throwable) {
        $hex = md5(uniqid((string)microtime(true), true));
    }
    return '0x' . $hex;
}
```

---

### 4.3 确权编号生成（低优先级）

**当前情况：**
- UserCollection 中优先使用 `collection_item.asset_code`
- 只有在 `asset_code` 为空时才生成
- 通常不会执行生成逻辑

**建议：** 保持现状，但添加注释说明优先级逻辑。

---

## 五、测试建议

### 5.1 测试模型事件是否正常工作

```php
// 测试代码
$item = new CollectionItem();
$item->title = '测试藏品';
$item->price = 100;
$item->session_id = 1;
$item->save();

// 检查 tx_hash 是否被正确设置
$saved = CollectionItem::find($item->id);
var_dump($saved->tx_hash);  // 应该不为空
```

### 5.2 检查现有数据

```sql
-- 检查是否有 tx_hash 为空的记录
SELECT COUNT(*) FROM ba_collection_item WHERE tx_hash IS NULL OR tx_hash = '';

-- 检查是否有 asset_code 为空的记录
SELECT COUNT(*) FROM ba_collection_item WHERE asset_code IS NULL OR asset_code = '';

-- 检查 asset_code 和 tx_hash 的关联性（AssetPackage生成的应该有关联）
SELECT id, asset_code, tx_hash, 
       CASE 
           WHEN tx_hash LIKE CONCAT('0x', SUBSTRING(MD5(asset_code), 1, 32)) THEN 'match'
           ELSE 'no match'
       END as hash_match
FROM ba_collection_item 
WHERE asset_code IS NOT NULL 
LIMIT 10;
```

---

## 六、影响评估

### 6.1 当前影响

- **模型事件可能无效**：如果模型没有字段映射，`fingerprint` 属性可能无法正确保存到数据库
- **数据不一致**：部分藏品的哈希基于确权编号生成，部分随机生成
- **API接口正常**：API接口中使用 `tx_hash` 字段，并且有回退逻辑，应该能正常工作

### 6.2 风险评估

- **高风险**：模型字段映射问题可能导致新创建的藏品没有哈希值
- **中风险**：哈希生成不一致可能导致验证逻辑问题
- **低风险**：确权编号格式不一致影响较小（因为优先使用item.asset_code）

---

## 七、修复优先级

1. **立即修复**：模型字段映射问题（检查是否有映射，如果没有则添加）
2. **尽快修复**：统一哈希生成方式
3. **后续优化**：确权编号格式统一（当前影响较小）

---

**报告生成时间：** 2026-01-02  
**检查人员：** AI Assistant  
**下一步行动：** 需要确认模型是否有字段映射配置，然后决定修复方案

<<<<<<< HEAD
=======

>>>>>>> 392e607a6782491114a0aee7408a7d620ecf394f

