# 藏品状态保护规则

## 创建时间
2025-12-30

## 概述
本文档定义了关键操作的状态拦截规则和分红脚本的扫描规则，防止数据不一致和重复发放收益。

---

## 一、状态拦截规则

### 1.1 核心原则
**藏品在"收益中"状态时，不可进行转让操作**

包括以下状态：
- `mining_status = 1` - 矿机分红中
- `rights_status = 1` - 权益收益中（未来可能添加）

### 1.2 需要拦截的操作

#### ✅ 已实施
1. **寄售操作** (`/api/collectionItem/consign`)
   - 检查 `mining_status = 1` → 拦截
   - 提示："该藏品当前为矿机状态（正在产生收益），无法寄售"

#### 🔜 建议实施
以下操作也应添加相同的状态检查：

2. **转让/赠送操作** (`/api/collectionItem/transfer`)
   - 检查 `mining_status = 1` → 拦截
   - 检查 `rights_status = 1` → 拦截

3. **提货操作** (`/api/collectionItem/delivery`)
   - 检查 `mining_status = 1` → 拦截
   - 检查 `rights_status = 1` → 拦截

4. **权益交割操作** (`/api/collectionItem/rightsDeliver`)
   - 检查 `mining_status = 1` → 拦截
   - 提示："该藏品当前为矿机状态，请先停止分红再进行交割"

### 1.3 实现代码模板

```php
// ⚠️ 关键保护：检查藏品是否处于"收益中"状态
$miningStatus = (int)($collection['mining_status'] ?? 0);
if ($miningStatus === 1) {
    throw new \Exception('该藏品当前为矿机状态（正在产生收益），无法操作。如需操作，请先停止矿机分红');
}

// TODO: 如果将来添加 rights_status 字段（权益分红状态），也需要检查
// $rightsStatus = (int)($collection['rights_status'] ?? 0);
// if ($rightsStatus === 1) {
//     throw new \Exception('该藏品当前处于权益收益中，无法操作');
// }
```

---

## 二、分红脚本扫描规则

### 2.1 核心原则
**每个分红脚本只扫描单一状态来源，避免重复发钱**

### 2.2 矿机分红脚本

**文件**: `app/command/CollectionMiningDividend.php`

**扫描规则**:
```php
// ✅ 只扫描 mining_status = 1
$collections = Db::name('user_collection')
    ->where('mining_status', 1)  // 矿机状态
    ->select();

// ❌ 不要混合其他状态
// 例如：不要 ->where('rights_status', 1)
```

**理由**:
- 矿机分红是基于 `mining_status` 的独立逻辑
- 如果同时扫描多个状态，可能导致同一藏品重复发放收益

### 2.3 权益分红脚本（未来可能添加）

**假设文件**: `app/command/CollectionRightsDividend.php`

**扫描规则**:
```php
// ✅ 只扫描 rights_status = 1
$collections = Db::name('user_collection')
    ->where('rights_status', 1)  // 权益收益状态
    ->select();

// ❌ 不要混合 mining_status
```

**理由**:
- 权益分红与矿机分红是两套独立的收益机制
- 必须严格隔离，避免交叉发放

### 2.4 状态互斥性

**规则**:
```php
// ⚠️ 同一藏品只能处于一种收益状态
if (mining_status == 1 && rights_status == 1) {
    // 这是错误状态，需要修复
    throw new Exception('藏品不能同时处于矿机和权益收益状态');
}
```

**实施方式**:
1. 数据库约束（推荐）:
   ```sql
   -- 添加检查约束（MySQL 8.0.16+）
   ALTER TABLE ba_user_collection ADD CONSTRAINT chk_single_earning_status 
   CHECK (
       (mining_status = 1 AND (rights_status IS NULL OR rights_status = 0))
       OR
       ((mining_status IS NULL OR mining_status = 0) AND rights_status = 1)
       OR
       ((mining_status IS NULL OR mining_status = 0) AND (rights_status IS NULL OR rights_status = 0))
   );
   ```

2. 应用层校验（兼容旧版MySQL）:
   ```php
   // 在转矿机前检查
   if ($collection['rights_status'] == 1) {
       throw new Exception('该藏品正在权益收益中，无法转为矿机');
   }
   
   // 在设置权益收益前检查
   if ($collection['mining_status'] == 1) {
       throw new Exception('该藏品正在矿机分红中，无法设置为权益收益');
   }
   ```

---

## 三、状态流转图

```
藏品购买
    ↓
[正常持有] (mining_status=0, rights_status=0)
    │
    ├─→ [转为矿机] → mining_status=1
    │       │            ↓
    │       │      矿机每日分红
    │       │            ↓
    │       └─→ [停止矿机] → mining_status=0
    │
    ├─→ [设置权益收益] → rights_status=1
    │       │                ↓
    │       │          权益每日分红
    │       │                ↓
    │       └─→ [停止权益] → rights_status=0
    │
    └─→ [寄售/转让/提货] ← 只有 mining_status=0 且 rights_status=0 时允许
```

---

## 四、检查清单

### 4.1 代码实施检查清单

**寄售/转让/提货等操作**:
- [ ] 检查 `mining_status = 1` → 拦截
- [ ] 检查 `rights_status = 1` → 拦截（如果字段存在）
- [ ] 提供清晰的错误提示

**矿机分红脚本**:
- [x] 只扫描 `mining_status = 1`
- [x] 不混合其他状态字段
- [x] 双重检查（二次锁定）

**权益分红脚本**（未来）:
- [ ] 只扫描 `rights_status = 1`
- [ ] 不混合 `mining_status`
- [ ] 双重检查（二次锁定）

**状态设置**:
- [ ] 转矿机前检查 `rights_status != 1`
- [ ] 设置权益前检查 `mining_status != 1`

### 4.2 测试场景

1. **矿机中尝试寄售**
   ```
   前提: mining_status = 1
   操作: 调用寄售接口
   预期: 拒绝，提示"矿机状态不可寄售"
   ```

2. **同时设置两种收益**
   ```
   前提: mining_status = 1
   操作: 尝试设置 rights_status = 1
   预期: 拒绝，提示"已在矿机分红中"
   ```

3. **矿机分红只发一次**
   ```
   前提: mining_status = 1
   操作: 连续运行两次矿机分红脚本
   预期: 第二次跳过（今日已发放）
   ```

---

## 五、数据修复脚本

如果发现数据不一致（同时有两种收益状态），使用以下脚本修复：

```sql
-- 查询异常数据
SELECT id, title, mining_status, rights_status
FROM ba_user_collection
WHERE mining_status = 1 AND rights_status = 1;

-- 修复：优先保留矿机状态
UPDATE ba_user_collection
SET rights_status = 0
WHERE mining_status = 1 AND rights_status = 1;

-- 或：根据业务规则手动决定保留哪个状态
```

---

## 六、监控建议

### 6.1 日常监控指标

1. **状态互斥性监控**
   ```sql
   -- 每日检查是否有藏品同时处于两种收益状态
   SELECT COUNT(*) AS conflict_count
   FROM ba_user_collection
   WHERE mining_status = 1 AND rights_status = 1;
   
   -- 预期结果: 0
   ```

2. **重复分红监控**
   ```sql
   -- 检查今天是否有藏品获得两种分红
   SELECT user_collection_id, COUNT(*) AS dividend_count
   FROM ba_user_activity_log
   WHERE action_type IN ('mining_dividend', 'rights_dividend')
     AND DATE(FROM_UNIXTIME(create_time)) = CURDATE()
   GROUP BY user_collection_id
   HAVING COUNT(*) > 1;
   
   -- 预期结果: 空
   ```

3. **状态拦截监控**
   ```sql
   -- 统计矿机状态藏品的寄售尝试（应该都被拦截）
   -- 通过应用日志监控错误信息中包含"矿机状态"的寄售失败
   ```

---

## 七、常见问题

### Q1: 用户反馈"矿机中的藏品无法寄售"，怎么办？
**A**: 这是正确的保护机制。用户需要：
1. 先停止矿机（设置 `mining_status = 0`）
2. 然后才能寄售

**操作路径**: 提供"停止矿机"功能接口

### Q2: 如果用户既想分红又想卖出怎么办？
**A**: 不能同时进行。用户需要选择：
- 继续持有，获得分红收益
- 或停止分红，进行寄售

### Q3: 权益交割和矿机分红可以同时存在吗？
**A**: 不可以。它们是两种不同的收益机制：
- **权益交割**: 一次性结算，将利润分配给卖家
- **矿机分红**: 持续性收益，每日发放

---

## 八、版本历史

| 版本 | 日期 | 修改内容 |
|------|------|----------|
| 1.0 | 2025-12-30 | 初始版本，定义状态拦截和分红扫描规则 |
