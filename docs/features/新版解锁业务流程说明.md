# 新版解锁业务流程说明

## 一、业务流程

### 1. 用户发起解锁
- **操作**：用户请求解锁旧资产（例如解锁 1000 元）
- **接口**：`POST /api/Account/unlockOldAssets`
- **消耗**：待激活金（`pending_activation_gold`）-1000元

### 2. 定位场次 (Session)
- **逻辑**：系统查找当前时间之后的最近一个交易场次
- **实现**：`LegacyAssetService::selectTargetSession()`
- **规则**：
  - 查询所有启用的场次，按开始时间排序
  - 寻找下一个开启的场次（`start_time > 当前时间`）
  - 如果今天所有场次都已开始，选择明天最早开始的场次

### 3. 匹配分区 (Zone)
- **逻辑**：根据解锁金额（例如1000元），匹配该场次下的对应分区（例如1K分区，范围500.01-1000.00）
- **实现**：`LegacyAssetService::determineZoneId($unlockPrice)`
- **规则**：
  - 根据解锁金额查找对应的价格分区配置（`ba_price_zone_config`）
  - 匹配条件：`min_price <= 解锁金额 <= max_price`
  - 如果有多个匹配，选择范围更小的分区
  - 如果没有匹配，查找包含该价格的最大分区
  - 兜底：返回最大的分区或默认分区（500元区）

### 4. 锁定资产包 (Package)
- **逻辑**：在该分区下随机找一个资产包，如果没有专用包，在该分区下随机分配一个现有资产包
- **实现**：`LegacyAssetService::findOrCreateTargetPackage($sessionId, $zoneId)`
- **规则**：
  1. **优先查找**：在该场次下查找通用包（`zone_id = 0`），因为所有资产包都是通用包
  2. **随机选择**：如果有多个资产包，随机选择一个，确保持仓多样性
  3. **自动创建**：如果没有现有资产包，创建新的通用包
     - 名称：`{日期}{场次名称}-{分区名称}自动包`
     - 设置为通用包（`zone_id = 0`）

### 5. 生成/分发藏品
- **定价**：价格 = 解锁金额（固定，例如1000元）
- **落库**：
  - 写入 `collection_item`（SPU）
  - 写入 `user_collection`（用户持有记录）
- **其他**：
  - 赠送寄售券（用于用户后续手动寄售时使用）
  - 不自动创建寄售单，由用户手动选择寄售或转矿机

---

## 二、代码实现

### 1. 选择目标场次

**位置**：`app/common/service/LegacyAssetService.php:selectTargetSession()`

```php
public static function selectTargetSession(): array
{
    $currentHi = date('H:i');
    
    // 查询所有启用的场次，按开始时间排序
    $sessions = Db::name('collection_session')
        ->where('status', '1')
        ->order('start_time', 'asc')
        ->select()
        ->toArray();
        
    // 寻找下一个开启的场次（start_time > 当前时间）
    foreach ($sessions as $session) {
        $startTime = $session['start_time'] ?? '';
        if ($startTime > $currentHi) {
            return $session; // 找到今天未开始的场次
        }
    }
    
    // 如果今天所有场次都已开始，选择明天最早开始的场次
    return $sessions[0];
}
```

### 2. 匹配价格分区

**位置**：`app/common/service/LegacyAssetService.php:determineZoneId()`

```php
private static function determineZoneId(float $unlockPrice): int
{
    // 根据解锁金额查找对应的价格分区
    $zone = Db::name('price_zone_config')
        ->where('status', 1)
        ->where('min_price', '<=', $unlockPrice)
        ->where('max_price', '>=', $unlockPrice)
        ->order('min_price', 'desc')
        ->find();
    
    if ($zone) {
        return (int)$zone['id'];
    }
    
    // 如果没有匹配，查找包含该价格的最大分区
    // ... 兜底逻辑
}
```

### 3. 锁定资产包

**位置**：`app/common/service/LegacyAssetService.php:findOrCreateTargetPackage()`

```php
public static function findOrCreateTargetPackage(int $sessionId, int $zoneId): array
{
    // 1. 优先在该场次下查找通用包（zone_id = 0）
    $packages = Db::name('asset_package')
        ->where('session_id', $sessionId)
        ->where('zone_id', 0)  // 所有资产包都是通用包
        ->where('status', 1)
        ->select()
        ->toArray();
    
    if (!empty($packages)) {
        // 随机选择一个资产包，确保持仓多样性
        $randomIndex = array_rand($packages);
        return $packages[$randomIndex];
    }
    
    // 2. 如果没有现有资产包，创建新的通用包
    // ... 创建逻辑
}
```

### 4. 生成藏品

**位置**：`app/common/service/LegacyAssetService.php:executeUnlock()`

```php
// 创建 collection_item（SPU）
$newItemId = Db::name('collection_item')->insertGetId([
    'session_id' => $sessionId,
    'zone_id' => $zoneId,
    'package_id' => $packageId,
    'package_name' => $targetPackage['name'],
    'title' => '创世节点算力权益证',
    'price' => $unlockPrice,  // 价格 = 解锁金额（固定）
    'issue_price' => $unlockPrice,
    // ...
]);

// 创建 user_collection（用户持有记录）
$userCollectionId = Db::name('user_collection')->insertGetId([
    'user_id' => $userId,
    'item_id' => $newItemId,
    'price' => $unlockPrice,  // 价格 = 解锁金额（固定）
    // ...
]);
```

---

## 三、关键点说明

### 1. 资产包分配策略

**新版逻辑**：
- 在该场次下随机选择一个通用包（`zone_id = 0`）
- 确保持仓多样性，避免所有解锁资产都集中在同一个资产包

**原因**：
- 所有资产包都是通用包（`zone_id = 0`）
- 可以用于所有价格分区
- 随机分配可以确保持仓多样性

### 2. 价格分区匹配

**新版逻辑**：
- 根据解锁金额（例如1000元），匹配对应的价格分区
- 例如：1000元对应1K分区（范围500.01-1000.00）

**匹配规则**：
1. 精确匹配：`min_price <= 解锁金额 <= max_price`
2. 包含匹配：查找包含该价格的最大分区
3. 兜底：返回最大的分区或默认分区

### 3. 定价规则

**固定定价**：
- 价格 = 解锁金额（固定，例如1000元）
- 不随市场变化，保持解锁时的价格

---

## 四、流程图

```
用户发起解锁（1000元）
    ↓
定位场次：查找当前时间之后的最近一个交易场次
    ↓
匹配分区：根据解锁金额（1000元），匹配1K分区（500.01-1000.00）
    ↓
锁定资产包：在该场次下随机选择一个通用包
    ↓
生成藏品：
  - 创建 collection_item（价格=1000元）
  - 创建 user_collection（价格=1000元）
  - 赠送寄售券
    ↓
完成：用户获得藏品，可以手动选择寄售或转矿机
```

---

## 五、相关文件

- **服务类**：`app/common/service/LegacyAssetService.php`
- **接口**：`app/api/controller/Account.php:unlockOldAssets()`
- **数据库表**：
  - `ba_collection_session` - 场次配置
  - `ba_price_zone_config` - 价格分区配置
  - `ba_asset_package` - 资产包配置
  - `ba_collection_item` - 商品表（SPU）
  - `ba_user_collection` - 用户持有记录


<<<<<<< HEAD
=======

>>>>>>> 392e607a6782491114a0aee7408a7d620ecf394f

