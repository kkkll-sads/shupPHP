# 撮合脚本使用说明

**创建日期**：2025-12-27  
**最后更新**：2025-12-27 21:10  
**脚本路径**：`app/command/CollectionMatching.php`  
**版本**：v2.0（优化日志输出）

---

## 一、功能说明

### 1.1 核心功能
撮合脚本包含以下三个主要功能：

1. **场次结束自动下架寄售订单**（新增）
   - 检测所有已结束的场次
   - 自动下架该场次下所有寄售中的订单
   - 退回寄售券给用户（有效期30天）
   - 记录活动日志

2. **撮合池撮合（轮盘赌机制）**
   - 处理用户竞价购买记录
   - 使用轮盘赌算法根据权重分配中签名额
   - 发放藏品和分配收益

3. **盲盒预约撮合**
   - 处理用户的盲盒预约订单
   - 匹配可用的寄售商品
   - 优先级：旧资产包 > 老用户 > 系统单 > 早寄售

---

## 二、使用方法

### 2.1 立即运行（手动）

#### 方式1：命令行执行
```bash
cd /opt/sqzx
php think collection:matching
```

#### 方式2：强制撮合模式（忽略场次时间限制）
```bash
php think collection:matching --force
```

### 2.2 定时任务（自动）

#### 添加到 Crontab
建议每分钟执行一次：

```bash
crontab -e
```

添加以下行：
```
* * * * * cd /opt/sqzx && php think collection:matching >> /tmp/collection_matching.log 2>&1
```

#### 或每5分钟执行一次：
```
*/5 * * * * cd /opt/sqzx && php think collection:matching >> /tmp/collection_matching.log 2>&1
```

---

## 三、执行日志说明

### 3.1 日志格式（v2.0）

#### 完整日志示例
```
================================================================================
[2025-12-27 21:10:48] 🤖 开始处理撮合池撮合（轮盘赌机制）- 自动运行
================================================================================
[2025-12-27 21:10:48] 开始检查场次结束需下架的寄售订单...
  场次 #1 「富春山居图」已结束（19:49-19:53），自动下架 4 个寄售订单
场次结束自动下架完成！共下架 4 个寄售订单，增加 4 次免费寄售机会

--------------------------------------------------------------------------------
【撮合池撮合结果】
  处理: 0 | 中签: 0 | 未中签: 0 | 失败: 0 | 耗时: 0.02秒
--------------------------------------------------------------------------------

[2025-12-27 21:10:48] 开始处理盲盒预约撮合...
  ✓ 用户升级为交易用户
  ✓ 发放寄售券：场次#3，区间#2
  ✓ 用户ID 28 盲盒中签，商品ID 21，价格 532，退差 468

--------------------------------------------------------------------------------
【盲盒预约撮合结果】
  总预约: 5 | 处理: 3 | 中签: 2 | 未中签: 1 | 跳过: 2 | 失败: 0
--------------------------------------------------------------------------------

================================================================================
[2025-12-27 21:10:49] 🤖 撮合任务完成 - 自动运行
================================================================================
```

#### 运行模式标识
| 符号 | 模式 | 说明 |
|------|------|------|
| 🤖 | 自动运行 | Cron定时任务触发（非终端环境） |
| 👤 | 手动运行 | 管理员手动执行（终端环境） |
| ⚡ | 强制撮合 | 使用 `--force` 参数，忽略场次时间限制 |

### 3.2 场次结束自动下架
```
[2025-12-27 20:04:15] 开始检查场次结束需下架的寄售订单...
  场次 #1 「富春山居图」已结束（19:49-19:53），自动下架 4 个寄售订单
场次结束自动下架完成！共下架 4 个寄售订单，增加 4 次免费寄售机会
```

**说明**：
- 检测到场次#1已结束
- 自动下架了4个寄售订单
- 为这4个藏品各增加了1次免费寄售次数
- **不退还寄售券**：用户下次寄售会自动使用免费次数

### 3.3 撮合池撮合
```
--------------------------------------------------------------------------------
【撮合池撮合结果】
  处理: 0 | 中签: 0 | 未中签: 0 | 失败: 0 | 耗时: 0.02秒
--------------------------------------------------------------------------------
```

**字段说明**：
- **处理**：待处理的竞价记录数
- **中签**：成功撮合的数量
- **未中签**：未中签的数量
- **失败**：处理失败的数量（异常）
- **耗时**：撮合耗时（秒）

### 3.4 盲盒预约撮合

#### 完整示例
```
[2025-12-27 21:10:48] 开始处理盲盒预约撮合...
  ⊗ 用户ID 10 预约跳过（场次 #2 「杭州西湖」交易时间未结束）
  ⊗ 用户ID 15 预约跳过（场次 #5 不存在或已下架）
  ✓ 用户升级为交易用户
  ✓ 发放寄售券：场次#1，区间#1
  ✓ 用户ID 20 盲盒中签，商品ID 18，价格 500，退差 0
  ✗ 用户ID 22 盲盒预约未中签（无可匹配商品），已退还冻结金额 500
  ✗ 用户ID 25 盲盒撮合失败: 数据库连接超时

--------------------------------------------------------------------------------
【盲盒预约撮合结果】
  总预约: 5 | 处理: 3 | 中签: 1 | 未中签: 1 | 跳过: 2 | 失败: 1
--------------------------------------------------------------------------------
```

**字段说明**：
- **总预约**：待处理的盲盒预约总数
- **处理**：实际进入撮合流程的数量
- **中签**：成功匹配到商品的数量
- **未中签**：无可匹配商品，退款的数量
- **跳过**：因场次未结束或场次不存在而跳过的数量
- **失败**：因异常错误而失败的数量

**状态符号**：
- ✓ 成功：中签、升级、发券
- ✗ 失败：未中签、异常错误
- ⊗ 跳过：场次未结束或不存在

#### 常见情况解读

**情况1：总预约 > 处理（有跳过）**
```
总预约: 5 | 处理: 3 | 中签: 2 | 未中签: 1 | 跳过: 2 | 失败: 0
```
- 有5个预约，但2个被跳过（场次未结束或不存在）
- 实际处理了3个，其中2个中签，1个未中签

**情况2：处理 = 中签（全部中签）**
```
总预约: 7 | 处理: 7 | 中签: 7 | 未中签: 0 | 跳过: 0 | 失败: 0
```
- 所有预约都进入撮合流程，且全部中签

**情况3：处理 > 中签 + 未中签（有失败）**
```
总预约: 10 | 处理: 10 | 中签: 8 | 未中签: 1 | 跳过: 0 | 失败: 1
```
- 1个预约因异常错误而失败

---

## 四、场次结束自动下架详情

### 4.1 触发条件
1. 场次状态为启用（status=1）
2. 当前时间超过场次结束时间
3. 该场次下有寄售中的订单（status=1）

### 4.2 执行流程
```
1. 检测所有已结束的场次
   ↓
2. 查询该场次下所有寄售中的订单
   ↓
3. 更新寄售状态为已下架（status=3）
   ↓
4. 更新用户藏品状态为未寄售（consignment_status=0）
   ↓
5. 退回寄售券（有效期30天）
   ↓
6. 记录活动日志
```

### 4.3 数据库操作
- **更新 `ba_collection_consignment`**：status = 3（已下架）
- **更新 `ba_user_collection`**：
  - consignment_status = 0（未寄售）
  - free_consign_attempts += 1（增加一次免费寄售次数）
- **插入 `ba_user_activity_log`**：记录下架日志

### 4.4 补偿机制（免费寄售次数）
**重要**：场次结束自动下架时，**不退还寄售券和手续费**，而是给予补偿：
- **补偿方式**：藏品的 `free_consign_attempts` 字段 +1
- **下次寄售**：系统会优先使用免费次数，无需扣除寄售券和手续费
- **优势**：用户可以立即重新上架，无需等待或消耗额外资源
- **逻辑依据**：参见 `docs/更新日志_20251226.md` 第666-673行

---

## 五、注意事项

### 5.1 权限问题
确保 PHP 进程有权限写入日志文件：
```bash
chmod 777 /tmp
```

### 5.2 性能优化
- 定时任务建议设置为每分钟或每5分钟执行一次
- 不建议执行间隔小于30秒，避免重复处理

### 5.3 日志管理
日志文件路径：`/tmp/collection_matching.log`

定期清理日志：
```bash
# 保留最近7天的日志
find /tmp -name "collection_matching.log" -mtime +7 -delete
```

或使用日志轮转：
```bash
# 每天轮转一次
logrotate -f /etc/logrotate.d/collection_matching
```

### 5.4 故障排查

#### 问题1：寄售订单未自动下架
**原因**：
- Crontab 未配置或未启动
- 场次时间配置错误
- 脚本执行失败

**解决方法**：
```bash
# 检查 Crontab 配置
crontab -l

# 手动执行脚本查看错误
php think collection:matching

# 查看系统日志
tail -f /tmp/collection_matching.log
```

#### 问题2：免费寄售次数未增加
**原因**：
- `ba_user_collection` 表缺少 `free_consign_attempts` 字段
- 数据库更新失败

**解决方法**：
```bash
# 检查藏品是否有免费次数字段
mysql -u用户名 -p密码 数据库名 -e "DESC ba_user_collection;" | grep free_consign

# 检查某个藏品的免费次数
mysql -u用户名 -p密码 数据库名 -e "SELECT id, user_id, item_id, consignment_status, free_consign_attempts FROM ba_user_collection WHERE id=藏品ID;"
```

---

## 六、后台管理集成（可选）

### 6.1 添加后台按钮
可以在后台"预约盲盒管理"页面添加一个"立即运行撮合"按钮。

**前端代码**（`web/src/views/backend/collection/matchingPool/index.vue`）：
```vue
<template #refreshAppend>
    <el-button v-blur class="table-header-operate" type="primary" @click="runMatching">
        <span class="table-header-operate-text">立即运行撮合</span>
    </el-button>
</template>

<script setup>
const runMatching = async () => {
    try {
        const res = await createAxios({
            url: '/admin/collection.MatchingPool/runMatching',
            method: 'post',
        })
        ElMessage.success(res.msg || '撮合任务已提交')
        baTable.onRefresh()
    } catch (error) {
        ElMessage.error(error.msg || '撮合任务提交失败')
    }
}
</script>
```

**后端代码**（`app/admin/controller/collection/MatchingPool.php`）：
```php
public function runMatching(): void
{
    try {
        // 在后台执行撮合命令
        $command = 'php ' . root_path() . 'think collection:matching > /dev/null 2>&1 &';
        exec($command);
        
        $this->success('撮合任务已提交，请稍后查看结果');
    } catch (\Throwable $e) {
        $this->error('撮合任务提交失败：' . $e->getMessage());
    }
}
```

---

## 七、更新历史

### v1.2 - 2025-12-27 晚
- ✅ 修正补偿机制：场次结束下架时不退还寄售券
- ✅ 改为增加免费寄售次数（`free_consign_attempts + 1`）
- ✅ 用户下次寄售自动使用免费次数，无需寄售券
- ✅ 符合文档规范（`docs/更新日志_20251226.md`）

### v1.1 - 2025-12-27
- ✅ 新增场次结束自动下架寄售订单功能
- ✅ 记录活动日志
- ✅ 修复 `price_zone` 字段默认值问题

### v1.0 - 初始版本
- 撮合池撮合（轮盘赌机制）
- 盲盒预约撮合

---

**备注**：本脚本已在生产环境测试通过，可放心使用。

