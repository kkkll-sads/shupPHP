# 权益交割功能说明

## 一、功能概述

**权益交割** 是指藏品买家（或持有者）通过API主动触发，将藏品的增值收益分配给原卖家（如果有寄售记录）的功能。

**与转矿机的区别**：
- ✅ **权益交割**：买家主动操作，将利润分配给卖家，是一次性的结算操作
- ✅ **转矿机**：系统自动判断，将滞销藏品转为矿机，每日持续分红

---

## 二、接口信息

### 2.1 基本信息
- **接口路径**: `POST /api/collectionItem/rightsDeliver`
- **权限要求**: 需要登录（batoken）
- **文件位置**: `app/api/controller/CollectionItem.php::rightsDeliver()`

### 2.2 请求参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| user_collection_id | int | ✅ | 用户藏品记录ID |

### 2.3 响应示例

**成功响应**:
```json
{
  "code": 1,
  "message": "权益交割完成",
  "data": {
    "user_collection_id": 123,
    "item_id": 45,
    "distributed_time": 1703952000,
    "note": "卖家（用户ID 67）获得可调度收益 525.50，消费金 25"
  }
}
```

**失败响应**:
```json
{
  "code": 0,
  "message": "该藏品已进行过权益交割，无法重复操作"
}
```

---

## 三、执行逻辑

### 3.1 前置校验

```php
// 1. 校验藏品是否存在且属于当前用户
// 2. 检查藏品是否寄售中（寄售中不能交割）
if ($collection['consignment_status'] > 0) {
    throw new Exception('该藏品当前状态为寄售中/已售出，无法进行权益交割');
}

// 3. 检查是否已交割过（防止重复）
// 通过查询 user_activity_log 表，action_type = 'rights_distribute'
if (已交割) {
    throw new Exception('该藏品已进行过权益交割，无法重复操作');
}
```

### 3.2 配置参数

从系统配置读取：

| 配置项 | 说明 | 示例值 |
|--------|------|--------|
| `matching_profit_rate` | 利润率（藏品价格的百分比） | 0.05 (5%) |
| `matching_profit_balance` | 利润分配到可提现余额的比例 | 0.5 (50%) |
| `matching_profit_score` | 利润分配到积分的比例 | 0.5 (50%) |
| `matching_distribute_to_seller` | 是否分配给卖家 | 1=是, 0=否 |

**约束**：
- `matching_profit_rate` 必须在 0-1 之间
- `matching_profit_balance + matching_profit_score` 必须 = 1.0

### 3.3 核心计算逻辑

```php
// 1. 计算总利润
$itemPrice = 藏品价格;  // 例如: 500元
$matchingProfitRate = 0.05;  // 5%利润率
$profit = $itemPrice * $matchingProfitRate;  // 500 × 0.05 = 25元

// 2. 分配利润
$profitBalanceRate = 0.5;  // 50%到余额
$profitScoreRate = 0.5;    // 50%到积分

$profitToWithdrawable = $profit * $profitBalanceRate;  // 25 × 0.5 = 12.5元
$profitToScore = $profit * $profitScoreRate;           // 25 × 0.5 = 12.5分

// 3. 卖家收益 = 本金 + 利润（余额部分）
$schedulableIncome = $itemPrice + $profitToWithdrawable;  // 500 + 12.5 = 512.5元

// 4. 更新卖家账户
UPDATE ba_user SET
    withdrawable_money = withdrawable_money + $schedulableIncome,  // +512.5
    score = score + $profitToScore                                 // +12.5
WHERE id = 卖家ID;
```

### 3.4 查找卖家逻辑

```php
// 通过 user_collection_id 查找对应的寄售记录
$consignment = SELECT * FROM ba_collection_consignment
WHERE user_collection_id = :user_collection_id
  AND status = 2  // 已售出
ORDER BY update_time DESC
LIMIT 1;

if ($consignment && $distributeToSeller) {
    $sellerId = $consignment['user_id'];  // 卖家ID
    // 分配给卖家...
} else {
    // 没有寄售记录或不分配给卖家 → 平台收益
}
```

---

## 四、完整执行流程

```
买家触发权益交割
    ↓
[1. 校验藏品]
    ├─ 藏品是否存在？
    ├─ 是否属于当前用户？
    ├─ 是否正在寄售中？❌
    └─ 是否已交割过？❌
    ↓
[2. 查找寄售记录]
    ↓
找到卖家？
    │
    ├─ YES ──→ [分配给卖家]
    │             │
    │             ├─ 计算利润 = 价格 × 5%
    │             ├─ 分配：50%余额 + 50%积分
    │             ├─ 卖家收益 = 本金 + 利润(余额部分)
    │             ├─ 更新卖家账户
    │             ├─ 记录余额日志 (ba_user_money_log)
    │             ├─ 记录活动日志 (ba_user_activity_log)
    │             └─ 返回成功
    │
    └─ NO ───→ [平台收益]
                  │
                  ├─ 记录活动日志（标记为平台收益）
                  └─ 返回成功
```

---

## 五、数据库记录

### 5.1 余额变动日志 (`ba_user_money_log`)

```php
INSERT INTO ba_user_money_log (
    user_id,
    money,              // +512.5（本金+利润余额部分）
    before,             // 变动前余额
    after,              // 变动后余额
    memo,               // '权益交割收益：藏品名称（本金：500.00元，利润可提现：12.50元）'
    create_time
)
```

### 5.2 活动日志 (`ba_user_activity_log`)

```php
INSERT INTO ba_user_activity_log (
    user_id,            // 卖家ID
    action_type,        // 'rights_distribute'
    change_field,       // 'withdrawable_money,score'
    change_value,       // JSON: {"withdrawable_money":512.5, "score":12.5}
    before_value,       // JSON: {"withdrawable_money":原值, "score":原值}
    after_value,        // JSON: {"withdrawable_money":新值, "score":新值}
    remark,             // '权益交割分配：利润 25.00，可调度收益 512.50，消费金 12'
    extra,              // JSON: {"user_collection_id":123, "item_id":45}
    create_time
)
```

### 5.3 查询权益交割记录

```sql
-- 查询某藏品是否已交割
SELECT * FROM ba_user_activity_log
WHERE action_type = 'rights_distribute'
  AND JSON_EXTRACT(extra, '$.user_collection_id') = 123;

-- 查询某用户获得的所有权益交割收益
SELECT 
    id,
    remark,
    FROM_UNIXTIME(create_time) AS distribute_time,
    JSON_EXTRACT(change_value, '$.withdrawable_money') AS withdrawable,
    JSON_EXTRACT(change_value, '$.score') AS score
FROM ba_user_activity_log
WHERE user_id = 67
  AND action_type = 'rights_distribute'
ORDER BY create_time DESC;
```

---

## 六、业务场景

### 场景1：正常权益交割（有卖家）

**前提**：
- 用户A以500元购买了用户B寄售的藏品
- 现在藏品已售出（consignment.status = 2）
- 买家A持有该藏品，决定交割权益

**操作**：
```bash
POST /api/collectionItem/rightsDeliver
{
  "user_collection_id": 123
}
```

**结果**：
- ✅ 卖家B获得：512.5元可提现余额（500本金 + 12.5利润） + 12.5积分
- ✅ 记录到 `ba_user_activity_log`
- ✅ 该藏品标记为已交割，无法再次交割

### 场景2：无卖家的权益交割

**前提**：
- 用户直接从平台购买的藏品（非寄售）
- 或配置 `matching_distribute_to_seller = 0`

**操作**：
```bash
POST /api/collectionItem/rightsDeliver
{
  "user_collection_id": 456
}
```

**结果**：
- ✅ 平台获得利润（不分配给具体用户）
- ✅ 记录活动日志（标记为平台收益）

### 场景3：重复交割（错误）

**操作**：
```bash
POST /api/collectionItem/rightsDeliver
{
  "user_collection_id": 123  // 已交割过的藏品
}
```

**结果**：
```json
{
  "code": 0,
  "message": "该藏品已进行过权益交割，无法重复操作"
}
```

---

## 七、与转矿机的对比

| 项目 | 权益交割 | 转矿机 |
|------|----------|--------|
| **触发方式** | 买家手动调用API | 系统自动检查（定时任务） |
| **触发条件** | 无限制，随时可触发 | 连续流拍/长期滞销/价格触顶 |
| **执行频率** | 一次性 | 转换后每日分红 |
| **收益对象** | 卖家（或平台） | 矿机持有者自己 |
| **收益计算** | 本金 + 利润（5%） | 每日固定金额分红 |
| **数据库状态** | 记录到 `user_activity_log` | 更新 `mining_status = 1` |
| **可重复性** | ❌ 不可重复 | ✅ 可每日重复分红 |

---

## 八、注意事项

### 8.1 防重复机制
- 通过查询 `user_activity_log` 表判断是否已交割
- 使用 `action_type = 'rights_distribute'` + `extra.user_collection_id` 双重校验

### 8.2 配置依赖
- 必须配置 `matching_profit_rate`、`matching_profit_balance`、`matching_profit_score`
- 配置缺失会抛出异常

### 8.3 事务保护
- 整个交割过程在事务中执行
- 失败自动回滚

### 8.4 寄售状态检查
- 寄售中（consignment_status = 1）的藏品不能交割
- 已售出（consignment_status = 2）的藏品不能交割
- 只有未寄售的藏品才能交割

---

## 九、系统配置示例

```php
// 系统配置项（需要在后台设置）
[
    // 利润率：5%
    'matching_profit_rate' => 0.05,
    
    // 利润分配比例：50%余额 + 50%积分
    'matching_profit_balance' => 0.5,
    'matching_profit_score' => 0.5,
    
    // 是否分配给卖家
    'matching_distribute_to_seller' => 1,  // 1=是, 0=否（平台收益）
]
```
