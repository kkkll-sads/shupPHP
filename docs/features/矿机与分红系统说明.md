# 矿机与分红系统完整说明

## 系统概述

本系统包含藏品自动转为矿机功能和矿机每日分红功能，用于盘活滞销藏品并给持有者提供稳定收益。

---

## 一、强制转矿机逻辑

### 1.1 脚本位置
**文件**: `app/command/CollectionMiningCheck.php`

**命令**: `php think collection:mining:check`

**Crontab**: 每天凌晨5点执行
```bash
0 5 * * * cd /www/wwwroot/18.166.209.223 && php think collection:mining:check >> /tmp/collection_mining_check.log 2>&1
```

### 1.2 触发条件（满足任一即转）

系统会自动检查所有 `mining_status = 0`（未锁仓）且 `delivery_status = 0`（未提货）的藏品，符合以下任一条件时自动转为矿机：

#### 条件1：连续寄售失败
- **配置项**: `mining_continuous_fail`（默认: 5次）
- **触发规则**: 最近N次寄售记录**全部**为流拍（status = 3）
- **代码位置**: 第111-141行

#### 条件2：长期滞销
- **配置项**: `mining_long_term_days`（默认: 7天）
- **触发规则**: 
  - 持有时间超过N天
  - 且从未寄售过**或**最后一次寄售是失败的
- **代码位置**: 第143-160行

#### 条件3：价格触顶
- **配置项**: `mining_price_top_multiple`（默认: 7倍）
- **触发规则**: 当前价格 ≥ 发行价 × N倍
- **代码位置**: 第162-177行

### 1.3 转矿机执行流程

```php
// 1. 更新藏品状态（注意：时间戳字段使用UNIX_TIMESTAMP()）
UPDATE ba_user_collection SET
    mining_status = 1,                    // 转为矿机
    mining_start_time = UNIX_TIMESTAMP(), // ✅ int时间戳（秒）
    last_dividend_time = 0,               // 初始化分红时间
    consignment_status = 0                // 重置寄售状态
WHERE id = :collection_id;

// 2. 取消进行中的寄售
UPDATE ba_collection_consignment SET
    status = 0                  // 已取消
WHERE user_collection_id = :collection_id 
  AND status = 1;               // 寄售中

// 3. 记录活动日志
INSERT INTO ba_user_activity_log 
    (action_type = 'collection_mining', ...)
```

### 1.4 数据库字段

**表**: `ba_user_collection`

| 字段 | 类型 | 说明 |
|------|------|------|
| `mining_status` | int | 0=未锁仓, 1=矿机, 2=已释放 |
| `mining_start_time` | int | 转矿机时间戳（**Unix秒级时间戳**） |
| `last_dividend_time` | int | 最后分红时间戳（**Unix秒级时间戳**） |

**⚠️ 重要**：
- 字段类型为 `int`，存储Unix时间戳（秒）
- PHP赋值: `time()` 或 SQL: `UNIX_TIMESTAMP()`
- ❌ 不要使用 `NOW()`（那是datetime类型）

---

## 二、手动转矿机逻辑

### 2.1 接口状态
❌ **未找到**手动转矿机的接口

**搜索结果**: 在 `app/api/controller` 目录下未找到 `startMining` 或类似的手动转矿机方法

**建议**: 
- 如需要手动转矿机功能，需要新增接口
- 可参考强制转矿机逻辑（`CollectionMiningCheck.php`）编写

---

## 三、分红脚本

### 3.1 矿机每日分红脚本

#### 基本信息
**文件**: `app/command/CollectionMiningDividend.php`

**命令**: `php think collection:mining:dividend`

**Crontab**: 每天凌晨6点执行
```bash
0 6 * * * cd /www/wwwroot/18.166.209.223 && php think collection:mining:dividend >> /tmp/collection_mining_dividend.log 2>&1
```

#### 配置参数

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| `mining_daily_dividend` | 每台矿机每日分红金额（元） | 0 |
| `mining_dividend_balance` | 分配到可提现余额的比例 | 0.5 (50%) |
| `mining_dividend_score` | 分配到积分的比例 | 0.5 (50%) |

#### 执行逻辑

```php
// 1. 查询所有矿机（mining_status = 1）
// 2. 检查今天是否已分红（关键判断逻辑）
$now = time();
$todayStart = strtotime(date('Y-m-d 00:00:00')); // 今日0点时间戳

if ($collection['last_dividend_time'] >= $todayStart) {
    // ✅ 今天已发放，跳过
    continue;
}

// 3. 如果未分红，则发放：
$dailyDividendAmount = 配置的每日分红金额;
$dividendToBalance = $dailyDividendAmount × mining_dividend_balance;  // 余额部分
$dividendToScore = $dailyDividendAmount × mining_dividend_score;      // 积分部分

// 更新用户余额
UPDATE ba_user SET
    withdrawable_money = withdrawable_money + $dividendToBalance,
    score = score + $dividendToScore
WHERE id = :user_id;

// 更新藏品最后分红时间（使用UNIX_TIMESTAMP()）
UPDATE ba_user_collection SET
    last_dividend_time = UNIX_TIMESTAMP()  // ✅ 存储时间戳
WHERE id = :collection_id;
```

**⚠️ 今日已分红判断规则**：
```php
$todayStart = strtotime(date('Y-m-d 00:00:00'));
if ($last_dividend_time >= $todayStart) {
    // 今天已发放
}
```

#### 分红记录

**余额变动日志 (`ba_user_money_log`)**:
```php
[
    'user_id' => $userId,
    'field_type' => 'withdrawable_money',
    'money' => $dividendToBalance,
    'before' => $beforeWithdrawable,
    'after' => $afterWithdrawable,
    'memo' => '矿机每日分红（可提现余额）：' . $itemTitle,
    'create_time' => time(),
]
```

**积分变动日志 (`ba_user_score_log`)**:
```php
[
    'user_id' => $userId,
    'score' => $dividendToScore,
    'before' => $beforeScore,
    'after' => $afterScore,
    'memo' => '矿机每日分红（积分）：' . $itemTitle,
    'create_time' => time(),
]
```

**活动日志 (`ba_user_activity_log`)** - ⚠️ **标准化格式**:
```php
[
    'user_id' => $userId,
    'action_type' => 'mining_dividend',  // ✅ 固定值，便于查询
    'change_field' => 'withdrawable_money,score',
    'change_value' => json_encode([      // ✅ 标准JSON结构
        'withdrawable_money' => $dividendToBalance,
        'score' => $dividendToScore,
    ]),
    'before_value' => json_encode([
        'withdrawable_money' => $beforeWithdrawable,
        'score' => $beforeScore,
    ]),
    'after_value' => json_encode([
        'withdrawable_money' => $afterWithdrawable,
        'score' => $afterScore,
    ]),
    'remark' => '矿机每日分红：' . $itemTitle . '（可提现：' . $dividendToBalance . '元，积分：' . $dividendToScore . '）',
    'extra' => json_encode([             // ✅ 扩展信息（含配置快照）
        'user_collection_id' => $collectionId,
        'item_id' => $itemId,
        'item_title' => $itemTitle,
        'daily_dividend_amount' => $dailyDividendAmount,
        'dividend_balance' => $dividendToBalance,
        'dividend_score' => $dividendToScore,
        'dividend_balance_rate' => $dividendBalanceRate,  // 配置快照
        'dividend_score_rate' => $dividendScoreRate,      // 配置快照
    ], JSON_UNESCAPED_UNICODE),
    'create_time' => time(),
]
```

**⚠️ 日志规范要求**：
1. `action_type` 固定为 `'mining_dividend'`
2. `extra` 字段必须包含：
   - `user_collection_id` - 藏品ID
   - `dividend_balance` - 本次余额分红
   - `dividend_score` - 本次积分分红
   - `dividend_balance_rate` - 配置快照（余额比例）
   - `dividend_score_rate` - 配置快照（积分比例）
3. 便于后续自动化对账和审计

### 3.2 每日藏品分红脚本（已废弃）

**文件**: `app/command/CollectionDailyDividend.php`

**命令**: `php think collection:daily:dividend`

**状态**: 此脚本似乎是旧版分红逻辑，可能已不再使用

**配置**: 
- `daily_dividend_balance_rate` (balance比例)
- `daily_dividend_score_rate` (score比例)

---

## 四、分红流水表

### 4.1 每日分红流水表

**表名**: `ba_daily_dividend_log`

**结构**:
```sql
CREATE TABLE ba_daily_dividend_log (
    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    order_id INT UNSIGNED NOT NULL DEFAULT 0,      -- 订单ID
    seller_id INT UNSIGNED NOT NULL DEFAULT 0,     -- 卖家ID
    profit DECIMAL(12,2) NOT NULL DEFAULT 0.00,    -- 利润
    balance_amount DECIMAL(12,2) NOT NULL DEFAULT 0.00,  -- 余额金额
    score_amount INT NOT NULL DEFAULT 0,           -- 积分金额
    create_time BIGINT NOT NULL DEFAULT 0          -- 创建时间
);
```

**用途**: 记录每日藏品分红的详细流水（由 `CollectionDailyDividend.php` 写入）

### 4.2 通用活动日志表

**表名**: `ba_user_activity_log`

**字段**:
```sql
- id              INT         主键
- user_id         INT         用户ID
- action_type     VARCHAR(50) 动作类型（mining_dividend, collection_mining等）
- change_field    VARCHAR(50) 变动字段
- change_value    DECIMAL     变动值
- before_value    DECIMAL     原值
- after_value     DECIMAL     现值
- remark          VARCHAR     备注
- extra           JSON        扩展信息（JSON格式）
- create_time     INT         创建时间
```

**索引**:
- `idx_user_id` (user_id)
- `idx_action_type` (action_type)
- `idx_change_field` (change_field)

**查询示例**:
```sql
-- 查询某用户的所有分红记录
SELECT * FROM ba_user_activity_log
WHERE user_id = 123
  AND action_type = 'mining_dividend'
ORDER BY create_time DESC;

-- 查询某藏品的转矿机记录
SELECT * FROM ba_user_activity_log
WHERE action_type = 'collection_mining'
  AND JSON_EXTRACT(extra, '$.user_collection_id') = 456;
```

---

## 五、状态枚举定义

### 5.1 寄售状态枚举 (`ba_collection_consignment.status`)

| 值 | 常量名 | 说明 |
|----|--------|------|
| 0 | STATUS_CANCELLED | 已取消/下架 |
| 1 | STATUS_SELLING | 寄售中 |
| 2 | STATUS_SOLD | 已售出 |
| 3 | STATUS_FAILED | 流拍/清退 |

**⚠️ 重要**：
- 强制转矿机只处理 `status = 3`（流拍）的记录
- `status = 2`（已售出）说明寄售成功，不触发转矿机

---

## 六、配置项汇总

### 6.1 强制转矿机配置

| 配置项 | 说明 | 默认值 | 有效范围 |
|--------|------|--------|----------|
| `mining_continuous_fail` | 连续失败次数 | 5 | 1-100 |
| `mining_long_term_days` | 长期滞销天数 | 7 | 1-365 |
| `mining_price_top_multiple` | 价格触顶倍数 | 7.0 | 1-100 |

### 6.2 矿机分红配置

| 配置项 | 说明 | 默认值 | 有效范围 | 校验规则 |
|--------|------|--------|----------|----------|
| `mining_daily_dividend` | 每日分红金额（元/台） | 0 | ≥ 0 | - |
| `mining_dividend_balance` | 余额分配比例 | 0.5 | 0-1 | ✅ 必须 + score = 1.0 |
| `mining_dividend_score` | 积分分配比例 | 0.5 | 0-1 | ✅ 必须 + balance = 1.0 |

**⚠️ 强校验规则**（后台保存时必须执行）：
```php
$balanceRate = (float)$config['mining_dividend_balance'];
$scoreRate = (float)$config['mining_dividend_score'];

// 校验1：范围检查
if ($balanceRate < 0 || $balanceRate > 1) {
    throw new Exception('余额分配比例必须在 0-1 之间');
}
if ($scoreRate < 0 || $scoreRate > 1) {
    throw new Exception('积分分配比例必须在 0-1 之间');
}

// 校验2：总和必须为1（允许0.0001误差）
if (abs(($balanceRate + $scoreRate) - 1.0) > 0.0001) {
    throw new Exception('余额比例 + 积分比例必须等于 1.0');
}
```

### 6.3 配置位置

配置通过 `get_sys_config()` 函数读取，可能存储在：
- 数据库配置表（需确认表名）
- 配置文件

---

## 六、使用示例

### 6.1 手动执行强制转矿机
```bash
# 检查并转换符合条件的藏品
php think collection:mining:check

# 查看日志
tail -f /tmp/collection_mining_check.log
```

### 6.2 手动执行分红
```bash
# 发放今日矿机分红
php think collection:mining:dividend

# 查看日志
tail -f /tmp/collection_mining_dividend.log
```

### 6.3 查询矿机数量
```sql
-- 查询当前矿机总数
SELECT COUNT(*) AS mining_count
FROM ba_user_collection
WHERE mining_status = 1;

-- 查询某用户的矿机列表
SELECT id, title, mining_start_time, last_dividend_time
FROM ba_user_collection
WHERE user_id = 123
  AND mining_status = 1;
```

### 6.4 查询分红记录
```sql
-- 查询某用户的所有分红记录
SELECT 
    id,
    remark,
    FROM_UNIXTIME(create_time) AS dividend_time,
    JSON_EXTRACT(extra, '$.dividend_balance') AS balance,
    JSON_EXTRACT(extra, '$.dividend_score') AS score
FROM ba_user_activity_log
WHERE user_id = 123
  AND action_type = 'mining_dividend'
ORDER BY create_time DESC;
```

---

## 七、注意事项

### 7.1 防重复发放
- 矿机分红脚本会检查 `last_dividend_time`
- 如果今天已发放（`last_dividend_time >= 今日0点`），则跳过
- 使用行锁（`lock(true)`）防止并发问题

### 7.2 事务保护
- 所有转矿机和分红操作都在事务中执行
- 失败自动回滚，保证数据一致性

### 7.3 状态检查
- 转矿机前会二次检查 `mining_status = 0`
- 发放分红前会二次检查 `mining_status = 1`
- 避免并发导致的状态不一致

### 7.4 日志记录
- 所有操作都会记录到 `ba_user_activity_log`
- 包含详细的 extra 信息（JSON格式）
- 便于追踪和审计

---

## 八、系统流程图

```
藏品购买
    ↓
持有期间（未寄售/寄售失败/滞销）
    ↓
[检查触发条件] ← 每日凌晨5点自动执行
    │
    ├─ 连续5次流拍？ ──→ YES ──┐
    ├─ 持有>7天未售？ ──→ YES ──┤
    └─ 价格>发行价7倍？ ─→ YES ──┘
                                │
                                ↓
                        [转为矿机]
                            │
                            ↓
                    mining_status = 1
                    mining_start_time = NOW
                    last_dividend_time = 0
                            │
                            ↓
                [等待次日分红] ← 每日凌晨6点自动执行
                            │
                            ↓
                    [发放日分红]
                        │
                        ├─ withdrawable_money += X元
                        ├─ score += Y分
                        └─ last_dividend_time = NOW
                            │
                            ↓
                        循环每日发放...
```

---

## 九、待确认问题

### 9.1 手动转矿机接口
- ❌ 未找到手动转矿机的API接口
- 建议: 如需要用户手动转矿机，需新增接口

### 9.2 系统配置表
- 配置通过 `get_sys_config()` 读取
- 需确认配置存储位置（数据库表或配置文件）

### 9.3 矿机释放逻辑
- `mining_status = 2` 表示已释放
- 未找到释放矿机的脚本或接口
- 需确认释放条件和逻辑

### 9.4 CollectionDailyDividend 脚本
- 此脚本与 `CollectionMiningDividend` 功能类似
- 需确认是否仍在使用或已废弃
