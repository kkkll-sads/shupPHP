# 代理佣金系统说明

## 概述
当卖家通过寄售或撮合成交时，系统会根据代理关系链自动分配佣金给上级代理。所有佣金都发放到代理的 `withdrawable_money`（可提现余额）。

## 佣金计算基数
**佣金基数 = 卖家获得的利润（`$profit`）**

例如：
- 卖家以100元购买藏品，以150元卖出
- 利润 = 150 - 100 = 50元
- 佣金基数 = 50元

## 佣金类型

### 1. 直推佣金（Direct Commission）
**比例：** 默认10%（可通过 `agent_direct_rate` 配置调整）

**发放对象：** 卖家的直接邀请人（`inviter_id`）

**计算公式：**
```
直推佣金 = 利润 × 直推比例
```

**示例：**
- 利润：50元
- 直推比例：10%
- 直推佣金：50 × 0.10 = 5元

---

### 2. 间推佣金（Indirect Commission）
**比例：** 默认5%（可通过 `agent_indirect_rate` 配置调整）

**发放对象：** 直推的邀请人（二级邀请人）

**计算公式：**
```
间推佣金 = 利润 × 间推比例
```

**示例：**
- 利润：50元
- 间推比例：5%
- 间推佣金：50 × 0.05 = 2.5元

---

### 3. 代理团队奖（Team Commission - 累计制 + 同级特殊处理）
**混合制说明：** 采用累计级差制，但对同级代理进行特殊处理。

**代理等级映射：**
| user_type | 代理等级 | 累计比例 | 级差比例（层级奖） | 同级奖比例 |
|-----------|---------|---------|-----------------|----------|
| 3 | 1级代理 | 9% | 9% | 10% |
| 4 | 2级代理 | 12% | 3% | 10% |
| 5 | 3级代理 | 15% | 3% | 10% |
| 6 | 4级代理 | 18% | 3% | 10% |
| 7 | 5级代理 | 21% | 3% | 10% |

**混合制原理：**

**正常情况（累计级差制）：**
- 1级代理拿 9%（层级奖）
- 2级代理拿 12% - 9% = 3%（层级奖）
- 3级代理拿 15% - 12% = 3%（层级奖）
- 4级代理拿 18% - 15% = 3%（层级奖）
- 5级代理拿 21% - 18% = 3%（层级奖）

**同级特殊处理：**
- 如果上级代理和下级代理是**同一等级**（user_type相同）
- 上级代理只拿 **10%的同级奖**，不按级差计算
- 示例：链上连续两个1级代理，第二个1级代理拿10%的同级奖

**查找规则：**
1. 从卖家开始，向上查找邀请关系链（最多10层）
2. 检查每个上级的 `user_type` 是否 >= 3（是否为代理）
3. 每个等级只取第一个遇到的代理
4. 按等级从低到高分配团队奖（累计制 + 同级特殊处理）

**示例场景：**

**场景1：正常级差（不同等级代理）**
假设邀请链：卖家 → A(普通用户) → B(1级代理) → C(普通用户) → D(3级代理) → E(5级代理)
- 利润：50元
- B(1级代理)：50 × 9% = 4.5元（层级奖）
- D(3级代理)：50 × (15% - 9%) = 3元（层级奖，跳过2级）
- E(5级代理)：50 × (21% - 15%) = 3元（层级奖，跳过4级）
- 总佣金：10.5元

**场景2：同级特殊处理**
假设邀请链：卖家 → A(1级代理) → B(1级代理) → C(3级代理)
- 利润：50元
- A(1级代理)：50 × 9% = 4.5元（层级奖）
- B(1级代理)：50 × 10% = 5元（同级奖，因为和A同级）
- C(3级代理)：50 × (15% - 9%) = 3元（层级奖，从9%累计）
- 总佣金：12.5元

**场景3：混合情况**
假设邀请链：卖家 → A(2级代理) → B(2级代理) → C(2级代理) → D(5级代理)
- 利润：50元
- A(2级代理)：50 × 12% = 6元（层级奖）
- B(2级代理)：50 × 10% = 5元（同级奖）
- C(2级代理)：50 × 10% = 5元（同级奖）
- D(5级代理)：50 × (21% - 12%) = 4.5元（层级奖，从12%累计）
- 总佣金：20.5元

**注意：** 
- 如果链上有全部不同等级的代理（1-5级各一个），总团队奖 = 利润 × 21%
- 如果链上有多个同级代理，同级奖会增加总佣金比例

---

## 佣金发放流程

### 触发时机
1. **寄售购买（CollectionItem.php）**
   - 买家购买寄售商品后
   - 在 `buyConsignment()` 方法中调用 `distributeAgentCommission()`

2. **撮合交易（CollectionMatching.php）**
   - 撮合成功后
   - 在卖家收益发放完成后调用 `distributeAgentCommission()`

### 发放步骤
1. **获取卖家信息**
   - 查询卖家的 `inviter_id`

2. **直推佣金处理**
   - 查询直推邀请人
   - 计算直推佣金
   - 更新 `withdrawable_money`
   - 记录 `user_money_log` 和 `user_activity_log`

3. **间推佣金处理**
   - 查询间推邀请人（直推的邀请人）
   - 计算间推佣金
   - 更新 `withdrawable_money`
   - 记录 `user_money_log` 和 `user_activity_log`

4. **代理团队奖处理**
   - 向上查找所有代理（最多10层）
   - 按等级从低到高分配团队奖（级差）
   - 更新 `withdrawable_money`
   - 记录 `user_money_log` 和 `user_activity_log`

### 数据库记录
每次佣金发放都会记录：

**user_money_log（余额变动日志）：**
- `user_id`：代理ID
- `money`：佣金金额
- `before`：发放前的 `withdrawable_money`
- `after`：发放后的 `withdrawable_money`
- `memo`：佣金类型和详情

**user_activity_log（活动日志）：**
- `user_id`：代理ID
- `related_user_id`：卖家ID
- `action_type`：
  - `agent_direct_commission`（直推佣金）
  - `agent_indirect_commission`（间推佣金）
  - `agent_team_commission`（团队奖）
- `change_field`：`withdrawable_money`
- `change_value`：佣金金额
- `extra`：JSON格式的详细信息（卖家ID、利润、比例、订单号等）

---

## 配置参数

### 系统配置表（ba_system_config）
| 配置键 | 说明 | 默认值 |
|--------|------|--------|
| `agent_direct_rate` | 直推佣金比例 | 0.10 (10%) |
| `agent_indirect_rate` | 间推佣金比例 | 0.05 (5%) |
| `agent_team_level1` | 1级代理累计比例 | 0.09 (9%) |
| `agent_team_level2` | 2级代理累计比例 | 0.12 (12%) |
| `agent_team_level3` | 3级代理累计比例 | 0.15 (15%) |
| `agent_team_level4` | 4级代理累计比例 | 0.18 (18%) |
| `agent_team_level5` | 5级代理累计比例 | 0.21 (21%) |
| `agent_same_level_rate` | 同级奖比例 | 0.10 (10%) |

### 配置修改
在后台管理系统中，通过 `get_sys_config()` 读取配置，可以动态调整佣金比例。

---

## 代码示例

### CollectionItem.php（寄售购买）
```php
// 在buyConsignment方法中，卖家收益发放完成后
// ========== 代理商佣金分配 ==========
// 佣金计算基数为卖家的利润
if ($profit > 0) {
    $this->distributeAgentCommission($sellerId, $profit, $item['title'], $consignmentId, $orderNo, $orderId, $now);
}
```

### CollectionMatching.php（撮合交易）
```php
// 在撮合成功后，卖家收益发放完成后
// ========== 代理商佣金分配 ==========
// 佣金计算基数为卖家的利润
if ($profit > 0) {
    $this->distributeAgentCommission($sellerId, $profit, $itemInfo['title'], $consignment['id'] ?? 0, $orderNo, $orderId, $now, $output);
}
```

### distributeAgentCommission方法核心逻辑
```php
/**
 * 分配代理佣金
 * @param int $sellerId 卖家ID
 * @param float $profit 利润（佣金计算基数）
 * @param string $itemTitle 商品标题
 * @param int $consignmentId 寄售记录ID
 * @param string $orderNo 订单号
 * @param int $orderId 订单ID
 * @param int $now 当前时间戳
 * @param OutputInterface|null $output 输出对象（可选，用于命令行输出）
 * @return void
 */
private function distributeAgentCommission(int $sellerId, float $profit, string $itemTitle, int $consignmentId, string $orderNo, int $orderId, int $now, $output = null): void
{
    // 1. 读取佣金比例配置
    $directRate = (float)(get_sys_config('agent_direct_rate') ?? 0.10);
    $indirectRate = (float)(get_sys_config('agent_indirect_rate') ?? 0.05);
    $teamRates = [
        1 => (float)(get_sys_config('agent_team_level1') ?? 0.09),
        2 => (float)(get_sys_config('agent_team_level2') ?? 0.12),
        3 => (float)(get_sys_config('agent_team_level3') ?? 0.15),
        4 => (float)(get_sys_config('agent_team_level4') ?? 0.18),
        5 => (float)(get_sys_config('agent_team_level5') ?? 0.21),
    ];
    $sameLevelRate = (float)(get_sys_config('agent_same_level_rate') ?? 0.10);

    // 2. 获取卖家信息
    $seller = Db::name('user')->where('id', $sellerId)->find();
    
    // 3. 直推佣金
    $directInviterId = (int)$seller['inviter_id'];
    if ($directInviterId > 0) {
        // 查询直推邀请人，锁定记录
        $directInviter = Db::name('user')->where('id', $directInviterId)->lock(true)->find();
        if ($directInviter) {
            $directCommission = round($profit * $directRate, 2);
            if ($directCommission > 0) {
                // 更新可提现余额
                $directBeforeWithdrawable = (float)$directInviter['withdrawable_money'];
                $directAfterWithdrawable = round($directBeforeWithdrawable + $directCommission, 2);
                
                Db::name('user')->where('id', $directInviterId)->update([
                    'withdrawable_money' => $directAfterWithdrawable,
                    'update_time' => $now,
                ]);

                // 记录日志
                // ... (user_money_log 和 user_activity_log)
            }
        }
    }

    // 4. 间推佣金
    // ... (类似直推逻辑)

    // 5. 代理团队奖（累计制+同级特殊处理）
    // 向上查找所有代理（最多10层），记录每个代理的等级和ID
    $agentChain = []; // [['user_id' => xxx, 'agent_level' => xxx], ...]
    $searchUserId = $sellerId;
    
    for ($searchDepth = 0; $searchDepth < 10; $searchDepth++) {
        $searchUser = Db::name('user')->where('id', $searchUserId)->find();
        if (!$searchUser) break;
        
        $inviterId = (int)$searchUser['inviter_id'];
        if ($inviterId <= 0) break;
        
        $inviter = Db::name('user')->where('id', $inviterId)->find();
        if (!$inviter) break;
        
        // 检查是否是代理（user_type >= 3）
        $agentLevel = (int)$inviter['user_type'] - 2;
        
        if ($agentLevel >= 1 && $agentLevel <= 5) {
            $agentChain[] = [
                'user_id' => $inviterId,
                'agent_level' => $agentLevel,
            ];
        }
        
        $searchUserId = $inviterId;
    }
    
    // 按等级分组，记录每个等级第一次出现的代理
    $foundAgents = []; // [agentLevel => agentId]
    foreach ($agentChain as $agent) {
        $level = $agent['agent_level'];
        if (!isset($foundAgents[$level])) {
            $foundAgents[$level] = $agent['user_id'];
        }
    }
    
    // 按等级从低到高分配团队奖（累计制+同级特殊处理）
    $previousRate = 0;
    $previousLevel = 0;
    
    for ($level = 1; $level <= 5; $level++) {
        if (!isset($foundAgents[$level])) continue;
        
        $agentId = $foundAgents[$level];
        
        // 判断是否是同级代理
        $isSameLevel = ($level == $previousLevel);
        
        if ($isSameLevel) {
            // 同级代理：只拿10%的同级奖
            $actualRate = $sameLevelRate;
            $commissionType = '同级奖';
        } else {
            // 不同级代理：按累计级差分配
            $currentRate = $teamRates[$level] ?? 0;
            $actualRate = $currentRate - $previousRate; // 级差
            $commissionType = '层级奖';
            $previousRate = $currentRate; // 更新上一等级的累计比例
        }
        
        $previousLevel = $level; // 更新上一个代理的等级
        
        if ($actualRate > 0) {
            $teamCommission = round($profit * $actualRate, 2);
            
            if ($teamCommission > 0) {
                // 更新可提现余额
                // ... (类似直推逻辑)
            }
        }
    }
}
```

---

## 验证与测试

### 测试场景
1. **寄售购买场景**
   - 买家购买寄售商品
   - 验证卖家收益正确（本金+利润）
   - 验证直推、间推、团队奖佣金发放到 `withdrawable_money`

2. **撮合交易场景**
   - 撮合成功（中签）
   - 验证卖家收益正确（本金+利润）
   - 验证直推、间推、团队奖佣金发放到 `withdrawable_money`

### 验证方法
1. **数据库查询**
   - 检查 `ba_user` 表的 `withdrawable_money` 是否增加
   - 检查 `ba_user_money_log` 表是否有佣金记录
   - 检查 `ba_user_activity_log` 表是否有佣金记录

2. **控制台输出（撮合场景）**
   ```
   代理佣金：直推（用户ID 123）获得 10.00 元
   代理佣金：间推（用户ID 456）获得 5.00 元
   代理佣金：1级团队奖（用户ID 789）获得 9.00 元
   ```

3. **日志文件**
   - 查看 `runtime/logs/` 中的应用日志

---

## 注意事项

### 1. 行锁保护
所有涉及余额变动的操作都使用 `lock(true)` 行锁，防止并发问题。

### 2. 精度处理
- 佣金金额使用 `round($value, 2)` 保留2位小数
- 使用 `number_format()` 格式化显示

### 3. 防重复发放
每次佣金发放前都会检查：
- 邀请人是否存在
- 佣金金额是否大于0
- 避免重复发放

### 4. 事务保护
佣金发放包含在整个交易的数据库事务中，确保原子性：
- 卖家收益发放
- 代理佣金发放
- 订单状态更新
任何一步失败，整个事务回滚。

### 5. 配置容错
如果配置参数不合理（<0 或 >1），使用默认值：
- 直推：10%
- 间推：5%
- 团队奖累计比例：9%/12%/15%/18%/21%
- 同级奖：10%

---

## 更新历史
- **2025-12-27**：修复代理佣金发放字段，从 `money` 改为 `withdrawable_money`，符合新财务架构
- **2025-12-27**：在撮合交易场景中添加代理佣金分润逻辑
- **2025-12-27**：调整代理团队奖为累计制+同级特殊处理：正常按级差分配，同级代理只拿10%的同级奖

---

## 相关文档
- [money字段架构调整说明.md](./money字段架构调整说明.md)
- [更新日志_20251227.md](./更新日志_20251227.md)
- [寄售业务逻辑说明.md](./寄售业务逻辑说明.md)

