# 用户预约与撮合逻辑说明 (User Reservation & Matching Logic)

> **⚠️ 最新变更**: 废弃“指定藏品预约”模式，全平台采用**“单一盲盒/自动匹配”**模式。

## 1. 预约模式 (Blind Box Only)

系统仅支持 **盲盒/自动预约 (Blind Box / Session Reservation)**。

*   **对象**: 指定场次 (`session_id`) + 指定价格区间 (`price_zone`)。
*   **消耗**: 用户需支付 `绿色算力` (Green Power) 作为权重。
*   **资金冻结**: 冻结该区间的最高限价金额（**优先扣可用余额/专项金**）。
*   **模式**: 用户不指定具体藏品，而是竞购该价格区间内的任意可用资产。

## 2. 撮合优先级规则 (Matching Priorities)

撮合过程是“所有买家”与“所有可用资产”之间的**全局匹配**。

### 2.1 买家优先级 (Buyer Ranking)
在同一价格区间内，所有买家按以下规则排序：
1.  **绿色算力 (Green Power)**: 投入算力**多者优先** (`weight DESC`)。
2.  **时间优先 (Time)**: 算力相同时，**先预约者优先** (`create_time ASC`)。

### 2.2 资产匹配优先级 (Asset Matching)
当确定了中签买家后，系统为他分配资产的顺序如下：
1.  **旧资产包优先**: `asset_package.id` 越小越优先（优先消耗历史遗留资产）。
2.  **老用户卖家优先**: `user.create_time` 越早越优先（优先帮助老用户出货）。
3.  **系统单/小号优先**: `user_id` 越小越优先（通常0号为系统库存）。
4.  **挂单时间优先**: `consignment.create_time` 越早越优先（早挂单早卖出）。

## 3. 撮合执行流程 (Execution Flow)

场次结束后，系统执行一次性的**批量撮合**：

1.  **提取买家池**: 获取该场次、该区间所有状态为 `pending` 的预约记录，按 **[2.1 买家优先级]** 排序。
2.  **提取资产池**: 获取该场次、该区间所有状态为 `寄售中/可售` 的资产（含旧资产包和用户寄售），按 **[2.2 资产匹配优先级]** 排序。
3.  **按序匹配**:
    *   **步骤 A**: 取出排名第一的买家，匹配排名第一的资产。
    *   **步骤 B**: 执行交易：
        *   **资金**: 扣除实际价格，退还差价 (`冻结 - 实际`) 至 `balance_available`。
        *   **资产**: 转移所有权给买家。
        *   **算力**: 消耗该买家投入的算力。
    *   **步骤 C**: 循环处理下一位买家，直到“买家池耗尽”或“做匹配资池耗尽”。

## 4. 失败与退款 (Failure & Refunds)

场次撮合结束后，剩余未匹配的买家和资产将按以下逻辑处理：

*   **未中签买家**:
    *   **资金**: 全额退款至 `balance_available` (可用余额)。
    *   **算力**: **已被消耗（销毁）**，不会退回。预约时算力即被扣除作为参与成本。
    *   **状态**: 预约记录标记为 `Failed/Refunded` (状态码：2)。
*   **未售出资产**:
    *   **状态**: 保持寄售中或标记为流拍 (`Unsold`)。
    *   **后续**: 自动进入下一轮场次或退回持有者（视寄售配置而定，通常是作为流拍处理）。

**算力消耗说明：**
- ✅ 预约时：算力立即扣除并销毁（作为参与成本）
- ✅ 中签时：冻结资金转为实际支付（退还差价到可用余额）
- ✅ 未中签时：冻结资金全额退回可用余额，算力不退回

**设计目的：**
- 算力作为预约的"门票"或"燃料"，一旦使用即消耗
- 防止无成本刷预约，确保用户认真参与
- 鼓励用户通过商城或积分兑换持续补充算力

> **总结**: 这是"多对多"的队列匹配模型。高算力买家优先买到优质历史资产；所有未成交的预约和寄售，在场次结束后即视为失败/流拍并清算。算力作为参与成本已消耗，只有冻结资金会退回。
