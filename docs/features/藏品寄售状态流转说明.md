# 藏品寄售状态流转说明

## 状态定义

### user_collection.consignment_status
- `0` = 未寄售
- `1` = 寄售中  
- `2` = 已售出

### collection_consignment.status
- `0` = 已取消
- `1` = 寄售中
- `2` = 已售出
- `3` = 已下架/流拍

## 正常业务流转

### 场景1：A卖家寄售 → B买家购买

1. **A创建寄售**
   - `user_collection(A).consignment_status` = 0 → 1
   - `collection_consignment.status` = 1

2. **B购买成功（撮合）**
   - **卖家藏品（旧记录）**:
     - `user_collection(A).consignment_status` = 1 → 2 ✅
     - `collection_consignment.status` = 1 → 2 ✅
   
   - **买家藏品（新记录）**:
     - 新创建 `user_collection(B).consignment_status` = 0 ✅
     - 无寄售记录

3. **B再次寄售（可选）**
   - `user_collection(B).consignment_status` = 0 → 1
   - 新建 `collection_consignment.status` = 1

### 场景2：寄售未售出被清退

1. **场次结束清退**
   - `collection_consignment.status` = 1 → 3 (已下架)
   - `user_collection.consignment_status` = 1 → 0 (恢复未寄售)
   - `user_collection.free_consign_attempts` += 1 (补偿)

## 验证结果

查询最近购买记录：

```sql
-- 买家新购买的藏品（正确）
ID 143-147: consignment_status = 0 或 1(自己再次寄售)

-- 卖家已售出的藏品（正确）  
ID 141-142: consignment_status = 2
```

## 代码实现

### 买家购买后创建藏品记录
位置: `CollectionMatching.php:1288`
```php
'consignment_status' => 0,  // 新购买藏品，未寄售
```

### 卖家藏品状态更新  
位置: `ConsignmentService::markAsSold()`
```php
'consignment_status' => self::UC_STATUS_SOLD,  // 2=已售出
```

### 寄售清退
位置: `UserService::clearUnsoldConsignments()`
```php
'consignment_status' => 0,  // 恢复未寄售
```

## 结论

✅ 当前状态流转逻辑**完全正确**：
- 买家购买后获得新藏品，`consignment_status = 0`
- 卖家原藏品被售出，`consignment_status = 2`
- 状态一致性得到保证
