# 增值逻辑启用修复说明

## 问题描述

用户反馈：藏品增值逻辑（`matching_profit_rate`）已经在后台配置，但在寄售购买场景中没有生效。

## 原因分析

### 代码实现差异

| 场景 | 利润计算方式 | 是否使用增值配置 |
|-----|-------------|----------------|
| **撮合**（CollectionMatching.php） | `Profit = Price × matching_profit_rate` | ✅ 是 |
| **权益交割**（CollectionItem.php deliveryRights） | `Profit = Price × matching_profit_rate` | ✅ 是 |
| **寄售购买**（CollectionItem.php buyConsignment） | `Profit = SellPrice - BuyPrice` | ❌ 否 |

###问题根源

**寄售购买场景**使用的是 **"差价模式"**，只计算买卖差价，没有使用平台补贴增值逻辑。

```php
// ❌ 修复前（差价模式）
$buyPrice = (float)$sellerCollection['price']; // 卖家买入价
$profit = $consignmentPrice - $buyPrice; // 只计算差价
```

### 与文档不符

根据 `docs/藏品增值逻辑说明.md`：

> **增值模式**: 买家成本 = Price，卖家收入 = Price + Profit  
> **公式**: `Profit = Price × matching_profit_rate`  
> **资金来源**: 本金来自买家支付，利润来自平台补贴

---

## 修复方案

### 修改文件
`/opt/sqzx/app/api/controller/CollectionItem.php` - `buyConsignment` 方法

### 修改内容

#### 1. 利润计算逻辑（第1152-1166行）

**修复前（差价模式）：**
```php
// 获取卖家的买入价（本金）
$sellerCollection = Db::name('user_collection')
    ->where('id', $userCollectionId)
    ->where('user_id', $sellerId)
    ->find();

$buyPrice = (float)$sellerCollection['price']; // 买入价（本金）
if ($buyPrice <= 0) {
    $buyPrice = $consignmentPrice; // 兼容处理
}

// 计算利润 = 卖出价 - 买入价
$profit = $consignmentPrice - $buyPrice;
```

**修复后（增值模式）：**
```php
// 从配置读取增值比例（默认50%）
$matchingProfitRate = (float)(get_sys_config('matching_profit_rate') ?? 0.5);
if ($matchingProfitRate < 0 || $matchingProfitRate > 1) {
    $matchingProfitRate = 0.5;
}

// 按照增值逻辑计算：
// - 本金（buyerPrice）：买家支付的寄售价，全额返还卖家
// - 利润（platformProfit）：寄售价 × 增值比例，平台补贴给卖家
$buyerPrice = $consignmentPrice; // 买家支付的价格（本金）
$profit = round($buyerPrice * $matchingProfitRate, 2); // 平台补贴利润
```

#### 2. 利润分配配置（第1168-1183行）

**修复前：**
```php
$profitBalanceRate = (float)(get_sys_config('consignment_profit_balance') ?? 0.5);
$profitScoreRate = (float)(get_sys_config('consignment_profit_score') ?? 0.5);
```

**修复后（统一使用撮合配置）：**
```php
$profitBalanceRate = (float)(get_sys_config('matching_profit_balance') ?? 0.5);
$profitScoreRate = (float)(get_sys_config('matching_profit_score') ?? 0.5);

// 规范两者之和为1（若不等于1，按 balance 优先，score = 1 - balance）
if (abs(($profitBalanceRate + $profitScoreRate) - 1.0) > 0.0001) {
    $profitScoreRate = 1.0 - $profitBalanceRate;
}
```

#### 3. 变量名更新（第1194行）

**修复前：**
```php
$sellerTotalWithdrawable = $buyPrice + $profitToBalance;
```

**修复后：**
```php
$sellerTotalWithdrawable = $buyerPrice + $profitToBalance;
```

#### 4. 日志记录更新（第1207-1213行）

**修复前：**
```php
'memo' => '寄售藏品售出结算：' . $item['title'] . 
         '（本金：' . number_format($buyPrice, 2) . 
         '元，利润余额：' . number_format($profitToBalance, 2) . '元）'
```

**修复后：**
```php
'memo' => '寄售藏品售出结算（增值模式）：' . $item['title'] . 
         '（本金：' . number_format($buyerPrice, 2) . 
         '元，平台补贴利润：' . number_format($profit, 2) . 
         '元，利润余额：' . number_format($profitToBalance, 2) . '元）'
```

#### 5. 活动日志修复（第1310-1393行）

**修复前（使用未定义变量）：**
```php
// ❌ 使用未定义的变量
'change_value' => (string)$sellerTotalMoney,
'before_value' => (string)$sellerBeforeMoney,
'after_value' => (string)$sellerAfterMoney,
```

**修复后（记录具体余额池）：**
```php
// ✅ 记录具体余额池变动
'change_field' => 'withdrawable_money',
'change_value' => (string)$sellerTotalWithdrawable,
'before_value' => (string)$sellerBeforeWithdrawable,
'after_value' => (string)$sellerAfterWithdrawable,
```

---

## 修复效果对比

### 举例说明

**假设：**
- 藏品寄售价：100元
- `matching_profit_rate`：0.5（50%）
- 卖家买入价：80元（仅差价模式相关）

### 修复前（差价模式）

| 角色 | 支付/获得 | 计算方式 |
|-----|----------|---------|
| 买家 | 支付 100元 | consignmentPrice |
| 卖家 | 获得 100元 | buyPrice (80) + (consignmentPrice - buyPrice) = 80 + 20 = 100 |
| 平台 | 0元 | 无补贴 |

**卖家收益明细：**
- 可提现余额：80 + (20 × 50%) = 90元
- 消费金：20 × 50% = 10元
- **总收益：100元（无增值）**

### 修复后（增值模式）

| 角色 | 支付/获得 | 计算方式 |
|-----|----------|---------|
| 买家 | 支付 100元 | consignmentPrice |
| 卖家 | 获得 150元 | buyerPrice (100) + profit (100 × 0.5) = 100 + 50 = 150 |
| 平台 | 补贴 50元 | profit = buyerPrice × matching_profit_rate |

**卖家收益明细：**
- 可提现余额：100 + (50 × 50%) = 125元
- 消费金：50 × 50% = 25元
- **总收益：150元（增值50%）✅**

---

## 修复验证

### 语法检查
✅ 通过（无linter错误）

### 代码对齐
| 场景 | 利润计算 | 配置使用 | 状态 |
|-----|---------|---------|------|
| 撮合 | `Price × matching_profit_rate` | ✅ | ✅ 对齐 |
| 权益交割 | `Price × matching_profit_rate` | ✅ | ✅ 对齐 |
| 寄售购买 | `Price × matching_profit_rate` | ✅ | ✅ 已修复 |

### 配置统一
✅ 所有场景统一使用以下配置：
- `matching_profit_rate`：增值比例（0-1）
- `matching_profit_balance`：利润进可提现余额比例（0-1）
- `matching_profit_score`：利润进消费金比例（0-1）

---

## 影响范围

### 直接影响
- ✅ 寄售购买场景现在会按配置的增值比例给卖家发放平台补贴利润
- ✅ 卖家收益显著提升（按配置比例）
- ✅ 与文档描述完全对齐

### 注意事项
1. **平台成本增加**：每笔寄售交易平台需要补贴 `Price × matching_profit_rate` 的利润
2. **数据统计**：需要关注平台补贴总额和资金池余额
3. **历史数据**：修复前的历史交易按差价模式结算，修复后按增值模式结算

### 建议
1. 在后台配置中合理设置 `matching_profit_rate`（推荐0.3-0.5）
2. 定期监控平台资金池和补贴总额
3. 可考虑针对不同类型藏品设置不同的增值比例

---

## 后台配置路径

**配置位置**：后台管理 → 内容管理 → 抽奖与配置 → 撮合设置

**配置项**：
1. **中签利润占比（相对于价格）** - `matching_profit_rate`
   - 默认值：0.5（50%）
   - 说明：例如0.5表示利润为价格的50%

2. **利润分配：可调度收益比例** - `matching_profit_balance`
   - 默认值：0.5（50%）
   - 说明：利润中进入可提现余额的比例

3. **利润分配：消费金比例** - `matching_profit_score`
   - 默认值：0.5（50%）
   - 说明：利润中进入消费金的比例

**配置要求**：
- `matching_profit_balance` + `matching_profit_score` = 1

---

## 测试建议

### 单元测试
1. 测试不同 `matching_profit_rate` 值（0, 0.3, 0.5, 0.8, 1.0）
2. 测试不同利润分配比例组合
3. 测试边界情况（价格为0、极大值等）

### 集成测试
1. 完整寄售流程：上架 → 购买 → 结算 → 查看余额
2. 验证卖家各余额池的正确性
3. 验证日志记录的完整性

### 数据验证
```sql
-- 验证寄售结算记录
SELECT 
    ul.user_id,
    ul.memo,
    ul.money as amount,
    ul.before,
    ul.after,
    ul.create_time
FROM ba_user_money_log ul
WHERE ul.memo LIKE '%寄售藏品售出结算（增值模式）%'
ORDER BY ul.create_time DESC
LIMIT 20;
```

---

**修复完成时间**：2025-12-27  
**修复人员**：AI Assistant  
**版本**：v2.0（增值逻辑统一版）

