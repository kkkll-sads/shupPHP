# è—å“æ¥å£æ¶æ„é‡æ„æ–¹æ¡ˆ

## ä¸€ã€å½“å‰é—®é¢˜è¯Šæ–­

### 1.1 æ ¸å¿ƒé—®é¢˜
**`CollectionItem.php` å·²è¾¾åˆ° 3780 è¡Œ**ï¼Œå­˜åœ¨ä¸¥é‡çš„æ¶æ„é—®é¢˜ï¼š

| é—®é¢˜ç±»å‹ | å…·ä½“è¡¨ç° | å½±å“ |
|---------|---------|------|
| **å•ä¸€å·¨å‹æ§åˆ¶å™¨** | 31ä¸ªæ–¹æ³•é›†ä¸­åœ¨ä¸€ä¸ªæ–‡ä»¶ | éš¾ä»¥å¯¼èˆªã€ç†è§£ã€ç»´æŠ¤ |
| **èŒè´£æ··æ‚** | è—å“æŸ¥è¯¢ã€å¯„å”®ã€é¢„çº¦ã€æ’®åˆã€éªŒè¯ç­‰å¤šç§ä¸šåŠ¡ | è¿åå•ä¸€èŒè´£åŸåˆ™ |
| **é‡å¤ä»£ç ** | æ•°æ®æ ¼å¼åŒ–ã€æƒé™æ£€æŸ¥ã€ä»·æ ¼è®¡ç®—ç­‰é€»è¾‘é‡å¤ | ç»´æŠ¤æˆæœ¬é«˜ï¼Œæ˜“å‡ºé”™ |
| **ä¸šåŠ¡é€»è¾‘è€¦åˆ** | æ§åˆ¶å™¨ç›´æ¥å†™SQLå’Œä¸šåŠ¡é€»è¾‘ | æ— æ³•å¤ç”¨ï¼Œéš¾ä»¥æµ‹è¯• |
| **ç¼ºä¹åˆ†å±‚** | æ²¡æœ‰Serviceå±‚ã€Repositoryå±‚ | ä»£ç å¼ºè€¦åˆ |

### 1.2 æ–¹æ³•åˆ†ç±»ç»Ÿè®¡

```
è—å“æŸ¥è¯¢ç±» (6ä¸ª):
- index, detail, originalDetail, bySession, queryByCode, deliveryList

å¯„å”®ä¸šåŠ¡ç±» (6ä¸ª):
- consign, consignmentCheck, myConsignmentList, consignmentDetail, cancelConsignment, tradeList

è´­ä¹°äº¤æ˜“ç±» (4ä¸ª):
- bidBuy, processConsignmentPurchase, purchaseRecords, rightsDeliver

é¢„çº¦æ’®åˆç±» (3ä¸ª):
- reservations, matchingPool (åºŸå¼ƒ), setAutoRelist

å·¥å…·æ–¹æ³• (5ä¸ª):
- generateFingerprint, maskAssetCode, isTimeInRange, getPriceZone, getOrCreateZoneByPrice

å†…éƒ¨æ–¹æ³• (2ä¸ª):
- getMatchingStatusText, getUserCollectionIdFromOrder
```

---

## äºŒã€é‡æ„æ–¹æ¡ˆè®¾è®¡

### 2.1 æ¶æ„åˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Controller Layer              â”‚  â† è½»é‡çº§ï¼Œåªè´Ÿè´£è¯·æ±‚å“åº”
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           Service Layer                â”‚  â† ä¸šåŠ¡é€»è¾‘å±‚
â”‚  - CollectionQueryService              â”‚
â”‚  - ConsignmentService (å·²æœ‰)           â”‚
â”‚  - ReservationService                  â”‚
â”‚  - TradingService                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         Repository Layer               â”‚  â† æ•°æ®è®¿é—®å±‚
â”‚  - CollectionRepository                â”‚
â”‚  - ConsignmentRepository               â”‚
â”‚  - ReservationRepository               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚            Model Layer                 â”‚  â† æ•°æ®æ¨¡å‹
â”‚  - CollectionItem                      â”‚
â”‚  - UserCollection                      â”‚
â”‚  - Consignment                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ§åˆ¶å™¨æ‹†åˆ†æ–¹æ¡ˆ

å°† `CollectionItem.php` æ‹†åˆ†ä¸ºå¤šä¸ªä¸“æ³¨çš„æ§åˆ¶å™¨ï¼š

```
app/api/controller/collection/
â”œâ”€â”€ Item.php              (è—å“æŸ¥è¯¢)
â”‚   â”œâ”€â”€ index()          - åˆ—è¡¨
â”‚   â”œâ”€â”€ detail()         - è¯¦æƒ…
â”‚   â”œâ”€â”€ bySession()      - æŒ‰ä¸“åœºæŸ¥è¯¢
â”‚   â””â”€â”€ queryByCode()    - é˜²ä¼ªéªŒè¯
â”‚
â”œâ”€â”€ Consignment.php       (å¯„å”®ä¸šåŠ¡)
â”‚   â”œâ”€â”€ create()         - åˆ›å»ºå¯„å”®
â”‚   â”œâ”€â”€ list()           - å¯„å”®åˆ—è¡¨
â”‚   â”œâ”€â”€ myList()         - æˆ‘çš„å¯„å”®
â”‚   â”œâ”€â”€ detail()         - å¯„å”®è¯¦æƒ…
â”‚   â”œâ”€â”€ cancel()         - å–æ¶ˆå¯„å”®
â”‚   â””â”€â”€ check()          - å¯„å”®æ£€æŸ¥
â”‚
â”œâ”€â”€ Trading.php           (äº¤æ˜“è´­ä¹°)
â”‚   â”œâ”€â”€ buy()            - è´­ä¹°
â”‚   â”œâ”€â”€ deliver()        - æƒç›Šäº¤å‰²
â”‚   â”œâ”€â”€ records()        - è´­ä¹°è®°å½•
â”‚   â””â”€â”€ tradeList()      - äº¤æ˜“åˆ—è¡¨
â”‚
â””â”€â”€ Reservation.php       (ç›²ç›’é¢„çº¦)
    â”œâ”€â”€ create()         - åˆ›å»ºé¢„çº¦
    â”œâ”€â”€ list()           - é¢„çº¦åˆ—è¡¨
    â””â”€â”€ setAutoRelist()  - è‡ªåŠ¨é‡æ–°ä¸Šæ¶
```

### 2.3 Serviceå±‚è®¾è®¡

#### CollectionQueryService
```php
namespace app\common\service;

class CollectionQueryService
{
    /**
     * è·å–è—å“è¯¦æƒ…ï¼ˆç»Ÿä¸€å¤„ç†ï¼‰
     */
    public function getDetail(int $itemId, ?int $userId = null): array
    
    /**
     * æŒ‰ä¸“åœºèšåˆè—å“ï¼ˆå®˜æ–¹+å¯„å”®ï¼‰
     */
    public function getItemsBySession(int $sessionId, int $zoneId): array
    
    /**
     * æ ¼å¼åŒ–è—å“æ•°æ®
     */
    public function formatItem(array $item, bool $maskCode = false): array
}
```

#### TradingService
```php
namespace app\common\service;

class TradingService
{
    /**
     * å¤„ç†å¯„å”®è´­ä¹°
     */
    public function purchaseConsignment(int $consignmentId, int $userId, string $payType): array
    
    /**
     * è®¡ç®—è´­ä¹°è´¹ç”¨
     */
    public function calculatePurchaseFee(float $price, int $userId): array
    
    /**
     * æ‰§è¡Œæƒç›Šäº¤å‰²
     */
    public function deliverRights(int $userCollectionId, int $userId): void
}
```

#### ReservationService
```php
namespace app\common\service;

class ReservationService
{
    /**
     * åˆ›å»ºç›²ç›’é¢„çº¦
     */
    public function createReservation(int $sessionId, int $zoneId, int $userId, array $params): int
    
    /**
     * è·å–ç”¨æˆ·é¢„çº¦åˆ—è¡¨ï¼ˆå«å®é™…è´­ä¹°ä»·æ ¼ï¼‰
     */
    public function getUserReservations(int $userId, int $page, int $limit): array
    
    /**
     * è®¡ç®—é¢„çº¦è´¹ç”¨
     */
    public function calculateReservationCost(int $baseHashrate, int $extraHashrate): array
}
```

---

## ä¸‰ã€å®æ–½æ­¥éª¤

### é˜¶æ®µä¸€ï¼šå‡†å¤‡å·¥ä½œï¼ˆ1-2å¤©ï¼‰
1. âœ… åˆ›å»º `ConsignmentService`ï¼ˆå·²å®Œæˆï¼‰
2. åˆ›å»ºç›®å½•ç»“æ„
3. ç¼–å†™å•å…ƒæµ‹è¯•æ¡†æ¶

### é˜¶æ®µäºŒï¼šServiceå±‚é‡æ„ï¼ˆ3-5å¤©ï¼‰
1. æå– `CollectionQueryService`
2. æå– `TradingService`
3. æå– `ReservationService`
4. æå–å…±ç”¨çš„ `FormatterService`ï¼ˆæ•°æ®æ ¼å¼åŒ–ï¼‰

### é˜¶æ®µä¸‰ï¼šControlleræ‹†åˆ†ï¼ˆ2-3å¤©ï¼‰
1. åˆ›å»ºæ–°çš„æ§åˆ¶å™¨æ–‡ä»¶
2. è¿ç§»æ–¹æ³•åˆ°æ–°æ§åˆ¶å™¨
3. æ›´æ–°è·¯ç”±é…ç½®
4. ä¿æŒå‘åå…¼å®¹ï¼ˆæ—§æ¥å£é‡å®šå‘ï¼‰

### é˜¶æ®µå››ï¼šRepositoryå±‚ï¼ˆå¯é€‰ï¼Œ1-2å¤©ï¼‰
1. åˆ›å»º Repository æ¥å£
2. å®ç°å…·ä½“çš„ Repository
3. æ›¿æ¢ Service ä¸­çš„ç›´æ¥ Db è°ƒç”¨

### é˜¶æ®µäº”ï¼šæµ‹è¯•ä¸ä¼˜åŒ–ï¼ˆ2-3å¤©ï¼‰
1. å•å…ƒæµ‹è¯•
2. é›†æˆæµ‹è¯•
3. æ€§èƒ½æµ‹è¯•
4. ä»£ç å®¡æŸ¥

---

## å››ã€ç«‹å³å¯è¡Œçš„æ¸è¿›å¼é‡æ„

### 4.1 ç¬¬ä¸€æ­¥ï¼šæå–æ ¸å¿ƒServiceï¼ˆæœ¬å‘¨ï¼‰

åˆ›å»ºä»¥ä¸‹Serviceï¼Œé€æ­¥å°†ä¸šåŠ¡é€»è¾‘ä»Controllerè¿ç§»ï¼š

```
app/common/service/collection/
â”œâ”€â”€ QueryService.php      - è—å“æŸ¥è¯¢
â”œâ”€â”€ TradingService.php    - äº¤æ˜“è´­ä¹°
â”œâ”€â”€ ReservationService.php - é¢„çº¦ç®¡ç†
â””â”€â”€ FormatterService.php  - æ•°æ®æ ¼å¼åŒ–
```

### 4.2 ç¬¬äºŒæ­¥ï¼šåˆ›å»ºFacadeï¼ˆä¸‹å‘¨ï¼‰

æä¾›ç»Ÿä¸€çš„APIè°ƒç”¨å…¥å£ï¼š

```php
// ä½¿ç”¨ç¤ºä¾‹
use app\facade\Collection;

// æ§åˆ¶å™¨ä¸­
$detail = Collection::getDetail($itemId, $userId);
$items = Collection::getBySession($sessionId, $zoneId);
```

### 4.3 ç¬¬ä¸‰æ­¥ï¼šå¹¶è¡Œè¿è¡Œï¼ˆä¸‹ä¸‹å‘¨ï¼‰

- ä¿ç•™æ—§æ¥å£ä¸å˜
- æ–°åŠŸèƒ½ä½¿ç”¨æ–°æ¶æ„
- é€æ­¥è¿ç§»ç°æœ‰æ¥å£

---

## äº”ã€é£é™©æ§åˆ¶

### 5.1 å‘åå…¼å®¹ç­–ç•¥

1. **è·¯ç”±åˆ«å**ï¼šæ—§è·¯ç”±æŒ‡å‘æ–°æ§åˆ¶å™¨
2. **é€‚é…å™¨æ¨¡å¼**ï¼šå…¼å®¹æ—§çš„è¯·æ±‚å‚æ•°
3. **ç‰ˆæœ¬æ§åˆ¶**ï¼šAPIç‰ˆæœ¬å·ç®¡ç†ï¼ˆv1 â†’ v2ï¼‰

### 5.2 æµ‹è¯•ç­–ç•¥

1. **å›å½’æµ‹è¯•**ï¼šç¡®ä¿æ‰€æœ‰ç°æœ‰åŠŸèƒ½ä¸å—å½±å“
2. **A/Bæµ‹è¯•**ï¼šå°æµé‡éªŒè¯æ–°æ¶æ„
3. **ç›‘æ§å‘Šè­¦**ï¼šé”™è¯¯ç‡ã€å“åº”æ—¶é—´ç›‘æ§

---

## å…­ã€é¢„æœŸæ”¶ç›Š

| æŒ‡æ ‡ | é‡æ„å‰ | é‡æ„å | æ”¹å–„ |
|-----|--------|--------|------|
| å•æ–‡ä»¶è¡Œæ•° | 3780è¡Œ | <500è¡Œ/æ–‡ä»¶ | â†“ 87% |
| ä»£ç å¤ç”¨ç‡ | ~30% | ~80% | â†‘ 167% |
| å•å…ƒæµ‹è¯•è¦†ç›–ç‡ | ~0% | ~70% | â†‘ 70% |
| æ–°åŠŸèƒ½å¼€å‘æ—¶é—´ | 2-3å¤© | 0.5-1å¤© | â†“ 67% |
| Bugä¿®å¤æ—¶é—´ | 1-2å¤© | 0.5å¤© | â†“ 75% |

---

## ä¸ƒã€å»ºè®®ä¼˜å…ˆçº§

**é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³å¼€å§‹ï¼‰**ï¼š
1. âœ… ConsignmentServiceï¼ˆå·²å®Œæˆï¼‰
2. ğŸ”¥ CollectionQueryService - æœ€å¸¸ç”¨ï¼Œå½±å“æœ€å¤§
3. ğŸ”¥ FormatterService - å‡å°‘é‡å¤ä»£ç 

**ä¸­ä¼˜å…ˆçº§ï¼ˆæœ¬æœˆå†…ï¼‰**ï¼š
4. TradingService - æ ¸å¿ƒä¸šåŠ¡
5. ReservationService - æ–°åŠŸèƒ½

**ä½ä¼˜å…ˆçº§ï¼ˆä¸‹æœˆï¼‰**ï¼š
6. Repositoryå±‚ - è¿›ä¸€æ­¥è§£è€¦
7. Controlleræ‹†åˆ† - æœ€åä¸€æ­¥

---

## å…«ã€ä¸‹ä¸€æ­¥è¡ŒåŠ¨

**æˆ‘å»ºè®®ç«‹å³å¼€å§‹ï¼š**

1. **åˆ›å»º `CollectionQueryService`** - æå– `detail`, `bySession`, `index` ç­‰æŸ¥è¯¢é€»è¾‘
2. **åˆ›å»º `FormatterService`** - ç»Ÿä¸€æ•°æ®æ ¼å¼åŒ–
3. **é‡æ„ `reservations` æ¥å£** - ä½¿ç”¨æ–°çš„ Serviceå±‚

**æ˜¯å¦éœ€è¦æˆ‘ï¼š**
- âœ… ç«‹å³åˆ›å»ºè¿™äº›Serviceæ–‡ä»¶åŠç¤ºä¾‹ä»£ç ï¼Ÿ
- âœ… æä¾›å…·ä½“çš„é‡æ„ä»£ç ç¤ºä¾‹ï¼Ÿ
- âœ… åˆ›å»ºæµ‹è¯•ç”¨ä¾‹æ¡†æ¶ï¼Ÿ
