# 核心业务重构计划 (2025-12-28)

## 1. 重构目标
对现有系统的核心交易逻辑进行模块化重构，解决代码维护困难、逻辑混乱的问题。重构将保持现有 ThinkPHP 框架不变，但引入 Service 层进行业务解耦。

## 2. 核心业务逻辑重定义

### 2.1 交易体系：场次与资产包
- **统一资产池**：不再区分“官方资产包”和“用户资产包”。所有在流通的藏品（Collection Item）都归属于某个 **资产包 (Asset Package)**。
- **交易场次 (Session)**：官方设定交易场次（如：上午场 10:00-12:00）。
- **价格分区 (Price Zone)**：每个资产包下划分为不同的价格区间（如：1000-2000元区，2000-3000元区）。

### 2.2 池化撮合机制 (Pool Matching)
用户不再直接购买具体的“某一个藏品”，而是针对 **“资产包 + 价格分区”** 进行预约或匹配。
- **买方**：预约/投入资金到 `[资产包A - 2000元区]`。
- **卖方**：将手中的藏品寄售。系统根据藏品所属的资产包和当前价格，自动将其归入对应的 `[资产包A - 2000元区]` 卖单池。
- **撮合**：系统在结算时，自动匹配该区域内的 **买单** 和 **卖单**。
    - 匹配成功：生成订单，资产转移。
    - 匹配失败：资金退回或顺延。

### 2.3 增值逻辑 (Conditional Appreciation)
藏品价格的增长由“流通频率”决定，规则如下：
1.  **触发时机**：用户 **买入** 藏品，交易完成（所有权转移）后。
2.  **判断条件**：检查该藏品 **上一次交易** 的时间。
    - 如果上一次交易发生在 **昨天** (前一天)，则 **触发增值** (价格 = 当前价 * (1 + 增值率))。
    - 否则（如：今天是第一次交易，或上一次交易是前天），**不增值**，价格保持不变。

## 3. 技术架构改造

引入 `Service` 层，将原本堆积在 Controller 中的逻辑剥离。

### 3.1 目录结构
在 `app/common/service/core` 下建立核心服务类：

```
app/common/service/core/
├── MarketService.php        # 市场服务：管理场次、资产包、价格分区
├── TradeService.php         # 交易服务：负责撮合匹配逻辑 (Matching)
├── AssetService.php         # 资产服务：负责用户持仓、寄售(锁定)、交割(转移)
└── AppreciationService.php  # 增值服务：负责价格增长判断与执行
```

### 3.2 职责划分

#### MarketService
- 获取当前开放的交易场次。
- 获取某个场次下的资产包列表。
- 获取资产包下的价格分区状态（买单数/卖单数）。

#### AssetService
- **consignItem(userId, itemId)**: 用户发起寄售。
    - 验证归属权。
    - 将资产状态置为“寄售中”。
    - 计算其所属的价格分区，加入撮合池。
- **deliverAsset(buyerId, itemId)**: 资产交割。
    - 将资产从卖家名下转移到买家名下。
    - 记录交易日志。
    - **调用 AppreciationService::checkAndAppreciate()**。

#### TradeService
- **matchPool(sessionId, packageId, zoneId)**: 执行撮合。
    - 这是一个核心算法函数，通常由定时任务 `Command` 调用。
    - 逻辑：取出该池子所有待买记录和待卖记录，按策略（时间优先或随机）匹配，生成订单并调用支付/交割流程。

#### AppreciationService
- **checkAndAppreciate(itemId)**:
    - 查询 `collection_order_item` 或历史记录，找到 `last_trade_time`。
    - `if (date('Y-m-d', $last_trade_time) == date('Y-m-d', strtotime('-1 day')))`:
        - 执行价格更新。

## 4. 实施步骤

1.  **创建 Service 类文件**：建立上述目录结构和基础类。
2.  **迁移寄售逻辑**：将 `CollectionItem.php` 中的寄售逻辑迁移至 `AssetService`。
3.  **实现增值逻辑**：编写 `AppreciationService` 并编写单元测试验证“昨天交易”的判断准确性。
4.  **重写撮合脚本**：新建 `php think trade:match` 命令，使用新的池化撮合逻辑替代旧的轮盘赌逻辑。
5.  **接口适配**：修改 `api/controller/CollectionItem.php` (或新建 `Trade.php`) 接入新的 Service。

## 5. 待确认事项 (已确认)
- **首单问题**：藏品第一次产生交易（如创世发行）时，是否默认不增值？
    - **确认结果**：**首单也需要增值**。如果找不到上一次交易记录，默认视为满足增值条件。
- **流拍处理**：如果撮合未成功，藏品是否自动下架或留在池中等待下一场？
    - **确认结果**：**流拍即下架**。未匹配成功的寄售记录将自动下架，状态变更为“已下架”，资产状态恢复为“未寄售”。
