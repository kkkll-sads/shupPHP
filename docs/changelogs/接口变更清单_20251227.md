# 接口变更清单 - 2025年12月27日

**功能模块：** 旧资产解锁逻辑重构  
**更新时间：** 2025-12-27 18:00

---

## 一、更新接口列表

### 1.1 GET /api/Account/checkOldAssetsUnlockStatus
**功能：** 查询旧资产解锁状态

**变更类型：** 🔄 更新（增加返回字段）

**变更内容：**
| 字段 | 类型 | 状态 | 说明 |
|------|------|------|------|
| `unlocked_count` | int | 🆕 新增 | 已解锁次数 |
| `available_quota` | int | 🆕 新增 | 可用解锁资格 |
| `unlock_conditions.unlocked_count` | int | 🆕 新增 | 条件详情中的已解锁次数 |
| `unlock_conditions.available_quota` | int | 🆕 新增 | 条件详情中的可用资格 |
| `unlock_conditions.is_qualified` | boolean | 🔄 逻辑变更 | 改为基于资格判断而非一次性检查 |
| `unlock_conditions.messages` | array | 🔄 内容增加 | 新增解锁次数和资格相关信息 |

**兼容性：** ✅ 向下兼容（保留所有旧字段）

**前端影响：**
- 需要展示已解锁次数和可用资格
- 按钮逻辑改为基于 `available_quota` 判断
- 提示信息需要显示新增的 messages

---

### 1.2 POST /api/Account/unlockOldAssets
**功能：** 执行旧资产解锁操作

**变更类型：** 🔄 更新（返回值重大变化）

**变更内容：**
| 字段 | 类型 | 状态 | 说明 |
|------|------|------|------|
| `unlock_count` | int | 🆕 新增 | 当前解锁次数（累计） |
| `reward_item_id` | int | 🆕 新增 | 获得的藏品ID |
| `reward_item_title` | string | 🆕 新增 | 获得的藏品名称 |
| `reward_item_price` | float | 🆕 新增 | 藏品价值（1000.00） |
| `user_collection_id` | int | 🆕 新增 | 用户藏品记录ID |
| `remaining_quota` | int | 🆕 新增 | 剩余可用解锁资格 |
| `message` | string | 🆕 新增 | 友好提示信息 |
| ~~`reward_equity_package`~~ | ~~float~~ | ❌ 移除 | 不再直接发放余额 |

**兼容性：** ⚠️ 部分不兼容（移除了 `reward_equity_package` 字段）

**前端影响：**
- **重要**：不再展示"获得余额"，改为展示"获得藏品"
- 成功后引导用户前往"我的藏品"
- 显示剩余可用资格
- 显示 message 提示信息

---

## 二、新增接口列表

### ❌ 无新增接口
本次更新使用现有接口，通过增加返回字段实现新功能。

---

## 三、内部逻辑更新（无接口变化）

### 3.1 POST /api/CollectionItem/consign
**功能：** 提交藏品寄售

**变更类型：** 🔧 内部逻辑增强

**变更内容：**
- 新增旧资产包识别逻辑（`is_old_asset_package=1`）
- 新增随机混入资产包逻辑
- 新增自动创建资产包逻辑（当价格分区无可用资产包时）

**对外接口：** 无变化

**前端影响：** 无（内部逻辑，前端无感知）

---

### 3.2 Command: CollectionMatching
**功能：** 盲盒撮合定时任务

**变更类型：** 🔧 内部逻辑增强

**变更内容：**
- 新增 `user_collection` 表关联
- 新增 `is_old_asset_package` 字段查询
- 匹配优先级增加：旧资产解锁包最优先

**对外接口：** 无（定时任务）

**前端影响：** 无（内部逻辑，前端无感知）

---

## 四、相关接口（无变化）

### 4.1 GET /api/Account/getInfo
**功能：** 获取用户信息

**变更：** 无变化

**说明：** 
- 返回 `pending_activation_gold`（待激活金）字段
- 前端可从此接口获取用户的待激活金余额

---

### 4.2 GET /api/User/consignmentCoupons
**功能：** 查询用户寄售券列表

**变更：** 无变化

**说明：**
- 解锁时自动发放的寄售券可从此接口查询
- 前端可提示用户寄售券已到账

---

## 五、数据库变更

### 5.1 ba_user 表
```sql
-- 新增字段
ALTER TABLE `ba_user` 
ADD COLUMN `old_assets_unlock_count` int(10) UNSIGNED NOT NULL DEFAULT 0 
COMMENT '旧资产解锁次数' AFTER `old_assets_status`;
```

**影响：** 用户模型需要支持新字段读写

---

### 5.2 ba_user_old_assets_unlock 表
```sql
-- 新增字段
ALTER TABLE `ba_user_old_assets_unlock` 
ADD COLUMN `unlock_count` int(10) UNSIGNED NOT NULL DEFAULT 1 
COMMENT '第几次解锁' AFTER `user_id`;
```

**影响：** 解锁记录表新增字段

---

### 5.3 ba_user_collection 表
```sql
-- 新增字段
ALTER TABLE `ba_user_collection` 
ADD COLUMN `is_old_asset_package` tinyint(1) UNSIGNED NOT NULL DEFAULT 0 
COMMENT '是否为旧资产包' AFTER `consignment_status`;
```

**影响：** 藏品记录表新增标识字段

---

### 5.4 ba_collection_item 表
```sql
-- 新增记录（旧资产包模板）
INSERT INTO `ba_collection_item` (...) VALUES (...);
```

**影响：** 需要配置旧资产包藏品模板

---

## 六、前端对接检查清单

### 6.1 必须更新的页面

#### ✅ 解锁状态页面
- [ ] 显示已解锁次数（`unlocked_count`）
- [ ] 显示可用资格（`available_quota`）
- [ ] 显示详细条件信息（`unlock_conditions.messages`）
- [ ] 按钮状态基于 `can_unlock` 判断
- [ ] 提示"每3个交易直推=1次资格"

#### ✅ 解锁成功页面
- [ ] **移除**"获得余额1000元"的展示
- [ ] **新增**"获得旧资产包藏品"的展示
- [ ] 显示藏品信息（`reward_item_title`、`reward_item_price`）
- [ ] 显示寄售券信息（`reward_consignment_coupon`）
- [ ] 显示剩余资格（`remaining_quota`）
- [ ] 引导用户前往"我的藏品"寄售

#### ✅ 我的藏品页面
- [ ] 能够显示旧资产包藏品
- [ ] 旧资产包支持寄售操作
- [ ] （可选）为旧资产包添加特殊标识

---

### 6.2 建议优化的页面

#### 💡 个人中心
- [ ] 显示解锁进度条或徽章
- [ ] 快捷入口：待激活金余额 + 可用资格

#### 💡 推广页面
- [ ] 显示交易直推数量
- [ ] 显示可获得的解锁资格
- [ ] 引导用户推广以获得更多解锁资格

---

## 七、测试要点

### 7.1 接口测试
- [ ] 测试 `checkOldAssetsUnlockStatus` 新增字段返回正确
- [ ] 测试 `unlockOldAssets` 发放藏品而非余额
- [ ] 测试多次解锁功能
- [ ] 测试资格计算逻辑（floor(直推数/3) - 已解锁次数）
- [ ] 测试待激活金扣除正确

### 7.2 业务测试
- [ ] 解锁后生成 `user_collection` 记录
- [ ] 藏品标记 `is_old_asset_package=1`
- [ ] 寄售时自动混入资产包
- [ ] 寄售时自动创建资产包（当分区无可用包时）
- [ ] 撮合时旧资产包享有最高优先级
- [ ] 卖出后收益按50/50分配

### 7.3 兼容性测试
- [ ] 旧版前端调用接口不报错
- [ ] 新旧字段都能正确返回
- [ ] 数据库迁移后旧数据正常

---

## 八、已实现逻辑但未暴露接口检查

### ✅ 检查结果：全部已对外暴露

| 功能 | 实现位置 | 对外接口 | 状态 |
|------|---------|---------|------|
| 查询解锁状态 | `Account::checkOldAssetsUnlockStatus()` | GET `/api/Account/checkOldAssetsUnlockStatus` | ✅ 已暴露 |
| 执行解锁 | `Account::unlockOldAssets()` | POST `/api/Account/unlockOldAssets` | ✅ 已暴露 |
| 检查解锁条件 | `Account::checkUnlockConditions()` | private方法，通过上述接口调用 | ✅ 通过公共接口暴露 |
| 寄售混入逻辑 | `CollectionItem::consign()` | POST `/api/CollectionItem/consign` | ✅ 已集成到现有接口 |
| 撮合优先级 | `CollectionMatching::execute()` | 定时任务 | ✅ 自动执行 |

**结论：** 所有业务逻辑都已通过合适的接口或任务暴露，无遗漏。

---

## 九、潜在需求（建议新增接口）

虽然当前所有逻辑都已实现和暴露，但以下接口可能对前端有帮助：

### 💡 建议新增：GET /api/Account/myOldAssetPackages
**功能：** 查询用户的旧资产包列表

**用途：**
- 单独列出用户的旧资产包藏品
- 方便用户管理和寄售
- 显示寄售状态

**优先级：** 低（可通过现有的 `/api/CollectionItem/myCollections` + 前端过滤实现）

**实现建议：**
```php
public function myOldAssetPackages(): void
{
    if (!$this->auth->isLogin()) {
        $this->error('请先登录', [], 401);
    }
    
    $userId = $this->auth->id;
    
    $list = Db::name('user_collection')
        ->where('user_id', $userId)
        ->where('is_old_asset_package', 1)
        ->order('create_time desc')
        ->select();
    
    $this->success('', $list);
}
```

---

### 💡 建议新增：GET /api/Account/unlockHistory
**功能：** 查询解锁历史记录

**用途：**
- 显示用户的解锁历史
- 每次解锁的时间、消耗、获得
- 方便用户追溯

**优先级：** 低（用户主要关心当前状态，历史记录需求不强）

**实现建议：**
```php
public function unlockHistory(): void
{
    if (!$this->auth->isLogin()) {
        $this->error('请先登录', [], 401);
    }
    
    $userId = $this->auth->id;
    
    $list = Db::name('user_old_assets_unlock')
        ->where('user_id', $userId)
        ->order('unlock_time desc')
        ->select();
    
    $this->success('', $list);
}
```

---

## 十、部署注意事项

### 10.1 部署顺序
1. **备份数据库**（必须）
2. 执行数据库迁移脚本
3. 在后台配置旧资产包藏品模板
4. 部署后端代码
5. 部署前端代码（强烈建议同步发布）
6. 验证功能

### 10.2 灰度发布建议
- 后端可先发布（向下兼容）
- 前端分批发布，监控错误
- 旧版前端仍可使用，但功能受限

### 10.3 回滚方案
- 如需回滚，先回滚前端
- 数据库变更不建议回滚（已产生数据）
- 后端可保持新版（兼容旧前端）

---

## 十一、文档清单

| 文档名称 | 路径 | 用途 |
|---------|------|------|
| API接口文档 | `docs/API接口文档_旧资产解锁_20251227.md` | 前端对接手册 |
| 更新日志 | `docs/更新日志_20251227.md` | 完整变更记录 |
| 接口变更清单 | `docs/接口变更清单_20251227.md` | 本文档 |
| 业务逻辑说明 | `docs/资产确权与解锁逻辑说明.md` | 业务流程文档 |
| 数据库迁移脚本 | `database/old_assets_unlock_repeatable.sql` | SQL脚本 |

---

## 十二、联系方式

**技术负责人：** 开发团队  
**更新时间：** 2025-12-27 18:00  
**版本号：** v2.0

---

**审核状态：** ✅ 已完成  
**前端对接状态：** ⏳ 待对接


