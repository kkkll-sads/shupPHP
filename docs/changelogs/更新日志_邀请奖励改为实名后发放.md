# 更新日志：邀请奖励改为实名认证后发放

**更新日期**：2025-12-27  
**版本**：v1.0  
**更新类型**：功能优化

---

## 一、更新概述

### 1.1 更新背景
为了提升平台用户质量，防止刷单和羊毛党，将邀请奖励发放时机从"下级注册时"改为"下级实名认证通过后"。

### 1.2 核心变更
- **原逻辑**：用户注册时，邀请人立即获得邀请奖励
- **新逻辑**：用户实名认证通过后，邀请人才能获得邀请奖励

---

## 二、代码修改详情

### 2.1 修改监听器：`app/listener/UserRegisterSuccess.php`

#### 2.1.1 注释注册时的邀请奖励发放
```php
// 处理邀请好友奖励（给邀请人发放奖励）
// 修改：邀请奖励需要在下级实名认证通过后才发放
// if ($inviterId > 0) {
//     $this->handleInviteReward($inviterId, $userId);
// }
```

#### 2.1.2 将 `handleInviteReward` 改为 public 方法
```php
/**
 * 处理邀请好友奖励（给邀请人发放奖励）
 * 修改为 public 方法，以便在实名认证通过时调用
 */
public function handleInviteReward(int $inviterId, int $newUserId): void
```

#### 2.1.3 添加防重复发放检查
```php
// 防重复发放：检查是否已经为该下级用户发放过邀请奖励
$existing = UserActivityLog::where('user_id', $inviterId)
    ->where('related_user_id', $newUserId)
    ->where('action_type', 'invite_reward')
    ->find();
if ($existing) {
    Log::info("邀请奖励已发放，跳过重复发放。邀请人ID: {$inviterId}, 被邀请人ID: {$newUserId}");
    return; // 已经发放过，不再重复发放
}
```

### 2.2 修改实名认证审核：`app/admin/controller/user/RealName.php`

#### 2.2.1 在审核通过后触发邀请奖励发放
```php
$this->model->commit();

// 实名认证通过后，给邀请人发放邀请奖励
if ($row->inviter_id > 0) {
    try {
        $listener = new \app\listener\UserRegisterSuccess();
        $listener->handleInviteReward($row->inviter_id, $row->id);
    } catch (\Throwable $e) {
        // 邀请奖励发放失败不影响审核结果
        \think\facade\Log::error('实名认证通过后发放邀请奖励失败: ' . $e->getMessage());
    }
}

$this->success('审核通过成功');
```

---

## 三、业务流程变化

### 3.1 旧流程
```
用户A注册（使用邀请码） 
→ 邀请人B立即获得邀请奖励
```

### 3.2 新流程
```
用户A注册（使用邀请码）
→ 用户A提交实名认证
→ 管理员审核通过
→ 邀请人B获得邀请奖励
```

### 3.3 奖励发放触发点
- **触发时机**：管理员在后台审核用户实名认证并点击"审核通过"时
- **发放对象**：被审核用户的邀请人（inviter_id）
- **奖励类型**：活动配置中的邀请奖励（withdrawable_money）
- **防重复发放**：通过 UserActivityLog 检查，确保同一个下级用户只能为邀请人贡献一次奖励

---

## 四、影响范围

### 4.1 影响的用户场景
1. **新注册用户**：注册后不会立即为邀请人带来奖励
2. **邀请人**：需要等待下级实名认证通过后才能获得奖励
3. **管理员**：审核实名认证时会自动触发邀请奖励发放

### 4.2 不影响的功能
- 注册奖励：仍在注册时发放
- 邀请关系记录：仍在注册时记录
- 其他业务逻辑：不受影响

### 4.3 历史数据处理
- **已注册但未实名的用户**：当他们实名认证通过时，邀请人将获得奖励
- **已注册已实名的用户**：不受影响（防重复发放机制会阻止重复发放）

---

## 五、测试要点

### 5.1 功能测试
1. **新用户注册测试**
   - 用户A使用邀请码注册
   - 检查邀请人B的可提现金额：应无变化
   - 检查 user_activity_log：不应有 action_type='invite_reward' 的记录

2. **实名认证通过测试**
   - 用户A提交实名认证
   - 管理员审核通过
   - 检查邀请人B的可提现金额：应增加邀请奖励金额
   - 检查 user_activity_log：应有 action_type='invite_reward' 的记录

3. **防重复发放测试**
   - 对同一用户多次审核通过（先拒绝再通过）
   - 检查邀请人B的可提现金额：只增加一次
   - 检查 user_activity_log：只有一条 invite_reward 记录

4. **无邀请人场景测试**
   - 用户直接注册（无邀请码）
   - 实名认证通过后：不应发放邀请奖励
   - 不应有报错或异常

### 5.2 数据一致性测试
1. 检查 `ba_user.withdrawable_money` 与 `ba_user_money_log` 的一致性
2. 检查 `user_activity_log` 中 invite_reward 记录的数量
3. 检查邀请关系链：`ba_user.inviter_id` 是否正确

### 5.3 异常场景测试
1. 活动配置中邀请奖励为0：不应发放奖励
2. 无有效活动：不应发放奖励
3. 邀请人不存在：应正常通过审核，记录错误日志但不影响审核结果

---

## 六、注意事项

### 6.1 运营注意事项
1. **告知用户**：需要在前端页面或用户协议中说明"邀请奖励需要下级实名认证后发放"
2. **活动规则更新**：更新邀请活动规则说明
3. **客服培训**：告知客服人员新的奖励发放机制

### 6.2 技术注意事项
1. **防重复发放**：通过 UserActivityLog 检查，确保同一下级用户只能贡献一次奖励
2. **异常容错**：邀请奖励发放失败不影响实名认证审核结果
3. **日志记录**：发放失败会记录到系统日志，方便排查问题

### 6.3 回滚方案
如需回滚到旧逻辑，修改 `app/listener/UserRegisterSuccess.php`：
```php
// 取消注释以下代码
if ($inviterId > 0) {
    $this->handleInviteReward($inviterId, $userId);
}

// 并注释掉 app/admin/controller/user/RealName.php 中的邀请奖励发放代码
```

---

## 七、后续优化建议

1. **实名认证自动审核**：接入第三方实名认证服务（易盾、阿里云等），自动审核通过后触发邀请奖励
2. **邀请奖励提醒**：邀请人获得奖励后，推送通知提醒
3. **邀请进度展示**：在前端展示下级用户的实名认证进度
4. **统计报表优化**：增加"待实名下级数"、"已实名下级数"等统计维度

---

## 八、相关文件清单

### 8.1 修改的文件
- `app/listener/UserRegisterSuccess.php` - 监听器，处理邀请奖励逻辑
- `app/admin/controller/user/RealName.php` - 实名认证审核控制器

### 8.2 相关表结构
- `ba_user` - 用户表
  - `inviter_id` - 邀请人ID
  - `real_name_status` - 实名状态（0=未认证，1=待审核，2=已通过，3=已拒绝）
  - `withdrawable_money` - 可提现金额
- `ba_user_activity_log` - 用户活动日志表
  - `action_type` = 'invite_reward' - 邀请奖励记录
  - `related_user_id` - 被邀请用户ID
- `ba_user_money_log` - 资金流水表

---

## 九、更新状态

- [x] 代码修改完成
- [x] 防重复发放机制实现
- [x] 文档编写完成
- [ ] 前端提示文案更新
- [ ] 活动规则说明更新
- [ ] 测试验证
- [ ] 生产环境部署

---

**备注**：本次更新是业务逻辑优化，不涉及数据库结构变更，可直接部署代码。

