# API接口变更汇总 - 2025年12月27日

**更新日期**：2025-12-27  
**版本号**：v1.0  
**文档状态**：✅ 已完成

---

## 📋 目录

- [一、变更概览](#一变更概览)
- [二、旧资产解锁功能重构](#二旧资产解锁功能重构)
- [三、寄售订单服务费记录](#三寄售订单服务费记录)
- [四、新增接口（防伪查询）](#四新增接口防伪查询)
- [五、前端对接优先级](#五前端对接优先级)
- [六、测试清单](#六测试清单)
- [七、部署说明](#七部署说明)

---

## 一、变更概览

### 1.1 统计数据

| 类别 | 数量 | 说明 |
|------|------|------|
| 🆕 新增接口 | 1 | 1个新增公开查询接口 |
| 🔄 更新接口 | 3 | 3个接口新增返回字段 |
| ❌ 废弃接口 | 0 | 无废弃接口 |
| 🔧 内部逻辑变更 | 3 | 3处内部逻辑优化（无接口变化） |
| 🗄️ 数据库变更 | 2 | 新增2个字段 |

### 1.2 变更清单

#### A. 早间更新（旧资产解锁）

| 接口 | 类型 | 变更说明 | 兼容性 |
|------|------|----------|--------|
| `GET /api/Account/checkOldAssetsUnlockStatus` | 🔄 更新 | 新增 `unlocked_count`、`available_quota` 字段 | ✅ 向下兼容 |
| `POST /api/Account/unlockOldAssets` | 🔄 更新 | 返回值重大变化，从"发放余额"改为"发放藏品" | ⚠️ 部分不兼容 |

#### B. 晚间更新（寄售服务费）

| 接口 | 类型 | 变更说明 | 兼容性 |
|------|------|----------|--------|
| `GET /api/collectionItem/myConsignmentList` | 🔄 更新 | 新增 `service_fee`、`total_cost` 字段 | ✅ 完全兼容 |

#### C. 新增接口（防伪查询）

| 接口 | 类型 | 变更说明 | 兼容性 |
|------|------|----------|--------|
| `GET /api/collectionItem/queryByCode` | 🆕 新增 | 通过确权编号或MD5查询藏品（公开接口） | ✅ 新增接口 |

---

## 二、旧资产解锁功能重构

> **详细文档**：`docs/接口变更清单_20251227.md`

### 2.1 功能说明
支持用户多次解锁旧资产，每次解锁发放价值1000元的"旧资产包"藏品（而非直接发放余额），用户需要将藏品寄售后才能变现。

### 2.2 涉及接口

#### 接口1：`GET /api/Account/checkOldAssetsUnlockStatus`

**新增返回字段**：

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `unlocked_count` | int | 已解锁次数 | `1` |
| `available_quota` | int | 可用解锁资格（基于直推人数） | `2` |

**返回示例**：
```json
{
  "code": 1,
  "msg": "success",
  "data": {
    "canUnlock": true,
    "unlocked_count": 1,        // ✅ 新增
    "available_quota": 2,        // ✅ 新增
    "unlock_conditions": {
      "has_old_assets": true,
      "sufficient_gold": true,
      "qualified_referrals": 9,
      "unlocked_count": 1,       // ✅ 新增
      "available_quota": 2,      // ✅ 新增
      "is_qualified": true
    }
  }
}
```

---

#### 接口2：`POST /api/Account/unlockOldAssets`

**返回值重大变化**：

**变更前**：
```json
{
  "code": 1,
  "msg": "解锁成功",
  "data": {
    "reward_equity_package": 1000.00  // 直接发放余额
  }
}
```

**变更后**：
```json
{
  "code": 1,
  "msg": "success",
  "data": {
    "unlock_count": 2,                    // ✅ 新增：当前解锁次数
    "reward_item_id": 99999,              // ✅ 新增：藏品ID
    "reward_item_title": "旧资产包",      // ✅ 新增：藏品名称
    "reward_item_price": 1000.00,         // ✅ 新增：藏品价值
    "user_collection_id": 12345,          // ✅ 新增：用户藏品记录ID
    "remaining_quota": 1,                 // ✅ 新增：剩余可用资格
    "message": "恭喜！解锁成功，获得旧资产包×1（价值1000.00元），请前往"我的藏品"查看并寄售变现。剩余可用解锁资格：1次"
  }
}
```

**⚠️ 兼容性影响**：
- 移除了 `reward_equity_package` 字段
- 前端需要修改UI，从"获得余额"改为"获得藏品"
- 成功后引导用户前往"我的藏品"而非"账户余额"

---

### 2.3 内部逻辑变更

#### A. 寄售混入逻辑（`POST /api/collectionItem/consign`）
- 旧资产包寄售时自动混入现有资产包
- 对外接口无变化，前端无感知

#### B. 撮合优先级（`CollectionMatching` 命令）
- 旧资产包享有最高匹配优先级
- 对外接口无变化，前端无感知

---

## 三、寄售订单服务费记录

> **详细文档**：`docs/API接口变更_20251227_晚.md`

### 3.1 功能说明
完整记录用户提交寄售时支付的服务费，便于成本统计和财务对账。

### 3.2 涉及接口

#### 接口：`GET /api/collectionItem/myConsignmentList`

**新增返回字段**：

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `list[].service_fee` | float | 服务费（从确权金扣除） | `15.00` |
| `list[].total_cost` | float | 用户实际成本（寄售价格+服务费） | `515.00` |

**返回示例**：
```json
{
  "code": 1,
  "msg": "success",
  "data": {
    "list": [
      {
        "consignment_id": 123,
        "consignment_price": 500.00,
        "service_fee": 15.00,           // ✅ 新增
        "total_cost": 515.00,           // ✅ 新增
        "consignment_status": 1,
        "consignment_status_text": "寄售中",
        "title": "富春山居图"
      }
    ]
  }
}
```

**✅ 兼容性影响**：
- 完全向下兼容
- 历史寄售记录的 `service_fee` 为 `0.00`
- 建议前端优雅处理历史数据

**业务规则**：
```
正常寄售：service_fee = consignment_price × 3%
代理优惠：service_fee = consignment_price × 3% × 折扣率
免费重发：service_fee = 0（流拍后）
```

---

### 3.3 数据库变更

#### 表：`ba_collection_consignment`

**新增字段**：
```sql
ALTER TABLE `ba_collection_consignment`
ADD COLUMN `service_fee` decimal(12,2) NOT NULL DEFAULT '0.00' 
COMMENT '服务费（从确权金扣除）' AFTER `price`;
```

| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `service_fee` | decimal(12,2) | 0.00 | 服务费金额 |

---

## 四、新增接口（防伪查询）

> **详细文档**：`docs/API接口_通过确权编号或MD5查询藏品.md`

### 4.1 功能说明
提供公开接口，允许用户通过**确权编号（asset_code）**或**MD5指纹（fingerprint）**查询藏品信息，用于防伪验证和溯源查询。

### 4.2 接口详情

#### 接口：`GET /api/collectionItem/queryByCode`

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `code` | string | 是 | 确权编号或MD5指纹（精确查询） |

**返回示例**：
```json
{
  "code": 1,
  "msg": "查询成功",
  "data": {
    "id": 123,
    "title": "富春山居图",
    "image": "https://...",
    "price": 1000.00,
    "asset_code": "37-DATA-0001-000123",
    "fingerprint": "0x1a2b3c...",
    "status": "1",
    "core_enterprise": "山东供应链管理有限公司",
    "holder": {
      "user_id": 456,
      "username": "user123",
      "nickname": "用户昵称",
      "mobile": "138****8000"
    }
  }
}
```

**特性**：
- ✅ 无需登录（公开接口）
- ✅ 精确匹配查询
- ✅ 返回持有人信息（如果已交付且未售出）
- ✅ 手机号自动脱敏
- ✅ 只查询上架中的藏品

**使用场景**：
- 📱 扫码验证藏品真伪
- 🔍 通过确权编号查询详情
- 🔐 通过MD5指纹验证唯一性

**安全建议**：
- 建议限流：60次/分钟/IP
- 添加IP黑名单机制
- 监控异常查询行为

---

## 五、前端对接优先级

### 5.1 必须升级（🔴 高优先级）

#### 1. 旧资产解锁成功页面
**影响接口**：`POST /api/Account/unlockOldAssets`

**升级要点**：
- ❌ 删除"获得余额"的展示
- ✅ 改为"获得藏品"的展示
- ✅ 显示藏品信息（旧资产包，价值1000元）
- ✅ 引导按钮改为"前往我的藏品"

**UI示例**：
```
┌─────────────────────────────┐
│  🎉 解锁成功！              │
├─────────────────────────────┤
│  获得藏品：旧资产包         │
│  藏品价值：¥1000.00         │
│  剩余资格：2次              │
├─────────────────────────────┤
│  提示：请前往"我的藏品"     │
│  寄售后可变现               │
├─────────────────────────────┤
│  [前往我的藏品]  [继续解锁] │
└─────────────────────────────┘
```

#### 2. 寄售列表页面
**影响接口**：`GET /api/collectionItem/myConsignmentList`

**升级要点**：
- ✅ 显示服务费和实际成本
- ✅ 区分正常寄售和免费重发
- ✅ 优雅处理历史数据

**UI示例**：
```
┌─────────────────────────────┐
│ 富春山居图                  │
│ 寄售中                      │
├─────────────────────────────┤
│ 寄售价格    ¥500.00         │
│ 服务费      ¥15.00 (3%)     │
│ ─────────────────────────── │
│ 实际成本    ¥515.00         │
└─────────────────────────────┘
```

---

### 5.2 建议升级（🟡 中优先级）

#### 1. 旧资产解锁检查页面
**影响接口**：`GET /api/Account/checkOldAssetsUnlockStatus`

**升级要点**：
- ✅ 显示已解锁次数
- ✅ 显示可用解锁资格
- ✅ 按钮文案改为"立即解锁 (剩余X次)"

#### 2. 寄售详情页面
**影响接口**：`GET /api/collectionItem/consignmentDetail`（可能需要同步更新）

**升级要点**：
- ✅ 显示服务费明细
- ✅ 显示实际成本

---

### 5.3 可选升级（🟢 低优先级）

#### 1. 用户成本统计页面
- 统计总寄售成本（包含服务费）
- 展示服务费占比

#### 2. 寄售前预览
- 在用户提交寄售前，预览将要扣除的服务费
- 提示实际成本

---

## 六、测试清单

### 6.1 接口测试

#### A. 旧资产解锁

**测试用例1：首次解锁**
```bash
# 1. 检查解锁状态
GET /api/Account/checkOldAssetsUnlockStatus

# 预期：unlocked_count=0, available_quota>=1

# 2. 执行解锁
POST /api/Account/unlockOldAssets

# 预期：返回藏品信息，而非余额
```

**测试用例2：多次解锁**
```bash
# 1. 检查状态
GET /api/Account/checkOldAssetsUnlockStatus

# 预期：unlocked_count>=1, available_quota>=1

# 2. 再次解锁
POST /api/Account/unlockOldAssets

# 预期：unlocked_count增加，available_quota减少
```

**测试用例3：资格不足**
```bash
# 当 available_quota=0 时
POST /api/Account/unlockOldAssets

# 预期：返回错误，提示需要更多直推
```

---

#### B. 寄售服务费

**测试用例1：正常寄售**
```bash
# 1. 提交寄售
POST /api/collectionItem/consign
{
  "user_collection_id": 123,
  "consignment_price": 500
}

# 2. 查看列表
GET /api/collectionItem/myConsignmentList

# 预期：service_fee=15.00, total_cost=515.00
```

**测试用例2：免费重发**
```bash
# 流拍后重新上架
POST /api/collectionItem/consign
{
  "user_collection_id": 124,
  "consignment_price": 500
}

# 预期：service_fee=0.00, total_cost=500.00
```

**测试用例3：代理优惠**
```bash
# 代理用户寄售
POST /api/collectionItem/consign
{
  "user_collection_id": 125,
  "consignment_price": 500
}

# 预期：service_fee<15.00（享受折扣）
```

---

### 6.2 数据验证

#### SQL验证脚本
```sql
-- 1. 验证旧资产解锁记录
SELECT 
    u.id,
    u.username,
    u.old_assets_unlock_count AS 解锁次数,
    COUNT(uc.id) AS 藏品数量
FROM ba_user u
LEFT JOIN ba_user_collection uc ON u.id = uc.user_id AND uc.is_old_asset_package = 1
WHERE u.old_assets > 0
GROUP BY u.id
HAVING 解锁次数 != 藏品数量;
-- 应该返回0行（次数与藏品数一致）

-- 2. 验证寄售服务费
SELECT 
    id,
    price AS 寄售价格,
    service_fee AS 服务费,
    (price + service_fee) AS 实际成本,
    CASE 
        WHEN service_fee = 0 THEN '免费重发或历史'
        WHEN ABS(service_fee - price * 0.03) < 0.01 THEN '正常寄售'
        ELSE '代理优惠'
    END AS 类型
FROM ba_collection_consignment
WHERE create_time > UNIX_TIMESTAMP('2025-12-27 00:00:00')
ORDER BY id DESC
LIMIT 20;
```

---

### 6.3 前端测试

#### 测试检查清单

| 功能点 | 测试内容 | 状态 |
|--------|----------|------|
| 旧资产解锁 | 显示解锁次数和可用资格 | ⬜ 待测 |
| 旧资产解锁 | 解锁成功显示藏品信息 | ⬜ 待测 |
| 旧资产解锁 | 引导前往我的藏品 | ⬜ 待测 |
| 寄售列表 | 显示服务费和实际成本 | ⬜ 待测 |
| 寄售列表 | 区分正常寄售和免费重发 | ⬜ 待测 |
| 寄售列表 | 历史数据优雅降级 | ⬜ 待测 |
| 代理用户 | 服务费折扣正确显示 | ⬜ 待测 |

---

## 七、部署说明

### 7.1 部署步骤

#### 步骤1：数据库迁移
```bash
# 1. 备份数据库
mysqldump -u用户名 -p密码 数据库名 > backup_20251227.sql

# 2. 执行迁移脚本（旧资产解锁）
mysql -u用户名 -p密码 数据库名 < database/old_assets_unlock_repeatable.sql

# 3. 执行迁移脚本（寄售服务费）
mysql -u用户名 -p密码 数据库名 < database/add_service_fee_to_consignment.sql

# 4. 验证字段
mysql -u用户名 -p密码 数据库名 -e "
    DESC ba_user;
    DESC ba_user_collection;
    DESC ba_collection_consignment;
"
```

#### 步骤2：后端部署
```bash
# 1. 拉取最新代码
git pull origin dev-financial-refactor

# 2. 清除缓存
cd /opt/sqzx && php think clear

# 3. 重启服务（如需要）
# systemctl restart php-fpm
```

#### 步骤3：前端部署
```bash
# 1. 更新前端代码
cd /opt/sqzx/web
git pull origin main

# 2. 安装依赖（如有新增）
npm install

# 3. 构建前端
cd /opt/sqzx && bash build-frontend.sh

# 4. 验证构建结果
ls -lh public/assets/
```

#### 步骤4：验证部署
```bash
# 1. 检查接口可用性
curl -X GET "https://your-domain.com/api/Account/checkOldAssetsUnlockStatus" \
  -H "batoken: test_token"

# 2. 检查前端页面
curl -I "https://your-domain.com/"

# 3. 查看日志
tail -f runtime/log/$(date +%Y%m%d).log
```

---

### 7.2 回滚方案

#### 数据库回滚
```bash
# 恢复备份（仅在严重问题时使用）
mysql -u用户名 -p密码 数据库名 < backup_20251227.sql
```

#### 代码回滚
```bash
# 回滚到上一个版本
git checkout <上一个commit_id>

# 清除缓存
php think clear

# 重新构建前端
bash build-frontend.sh
```

---

### 7.3 监控指标

#### 关键指标监控

| 指标 | 监控点 | 预警阈值 |
|------|--------|----------|
| 旧资产解锁成功率 | `POST /api/Account/unlockOldAssets` | < 95% |
| 寄售创建成功率 | `POST /api/collectionItem/consign` | < 95% |
| 接口响应时间 | 所有涉及接口 | > 2秒 |
| 服务费记录准确性 | `service_fee` 字段 | 异常值比例 > 5% |
| 前端错误率 | 浏览器控制台 | > 1% |

#### 日志监控
```bash
# 查看旧资产解锁日志
grep "unlockOldAssets" runtime/log/*.log | tail -50

# 查看寄售服务费日志
grep "consignment_fee" runtime/log/*.log | tail -50

# 查看错误日志
grep "ERROR" runtime/log/*.log | tail -50
```

---

## 八、常见问题FAQ

### Q1: 为什么旧资产解锁不再直接发放余额？
**A**: 为了符合业务规则，旧资产需要通过"寄售-售出"的流程才能变现，而非直接到账。这样可以：
- 增加用户粘性（需要参与寄售流程）
- 符合监管要求（资产流转可追溯）
- 提供更灵活的资产管理方式

### Q2: 历史寄售记录的服务费为什么是0？
**A**: 本次更新前创建的寄售记录，数据库中 `service_fee` 字段默认为 `0.00`。这不影响数据的准确性，因为：
- 历史服务费可从 `user_activity_log` 表查询
- 新的寄售记录会正确记录服务费
- 前端可以优雅处理这种情况（显示为"历史记录"）

### Q3: 如何区分"免费重发"和"历史数据"？
**A**: 
- **历史数据**：`service_fee = 0` 且 `create_time < 1735308000`
- **免费重发**：`service_fee = 0` 且 `create_time >= 1735308000`，且有流拍记录

### Q4: 前端兼容性如何保证？
**A**: 
- 所有接口变更都是**新增字段**，不删除或修改现有字段
- 旧版前端继续使用不受影响（只是看不到新功能）
- 新版前端需要处理新字段，但对旧数据有降级方案

### Q5: 代理用户的服务费折扣如何查询？
**A**: 
- 代理折扣率存储在系统配置（`agent_service_discount`）
- 前端无法直接查询配置
- 但可以通过 `service_fee` 字段反推折扣率
- 建议在寄售成功后的提示中说明实际扣费金额

---

## 九、相关文档索引

| 文档名称 | 路径 | 说明 |
|---------|------|------|
| **接口详细文档** | | |
| 旧资产解锁接口变更 | `docs/接口变更清单_20251227.md` | 解锁功能的详细接口文档 |
| 寄售服务费接口变更 | `docs/API接口变更_20251227_晚.md` | 服务费功能的详细接口文档 |
| 确权编号查询接口 | `docs/API接口_通过确权编号或MD5查询藏品.md` | 防伪查询功能的详细接口文档 |
| **业务逻辑文档** | | |
| 资产确权与解锁说明 | `docs/资产确权与解锁逻辑说明.md` | 旧资产解锁的业务流程 |
| 寄售业务逻辑说明 | `docs/寄售业务逻辑说明.md` | 寄售流程和费用规则 |
| 财务架构分析 | `docs/财务架构与资金流向分析.md` | 资金流向和账户体系 |
| **技术文档** | | |
| 修复说明（旧资产） | `docs/更新日志_20251227.md` | 旧资产解锁的技术实现 |
| 修复说明（服务费） | `docs/修复_寄售订单服务费记录.md` | 服务费记录的技术实现 |
| 场次补偿机制修正 | `docs/修正_场次结束补偿机制.md` | 场次结束逻辑的修正说明 |
| **数据库脚本** | | |
| 旧资产解锁迁移 | `database/old_assets_unlock_repeatable.sql` | 数据库结构变更SQL |
| 服务费字段迁移 | `database/add_service_fee_to_consignment.sql` | 服务费字段添加SQL |

---

## 十、版本历史

| 版本 | 日期 | 主要变更 | 作者 |
|------|------|----------|------|
| v1.0 | 2025-12-27 21:00 | 初版发布，整合全天API变更 | AI Assistant |

---

## 十一、审批记录

| 角色 | 姓名 | 审批意见 | 日期 |
|------|------|----------|------|
| 后端开发 | [待填写] | | |
| 前端开发 | [待填写] | | |
| 产品经理 | [待填写] | | |
| 技术总监 | [待填写] | | |

---

**文档状态**：✅ 已完成  
**最后更新**：2025-12-27 21:30  
**下次更新**：按需更新

---

**维护说明**：
- 本文档为汇总文档，详细信息请查阅各子文档
- 如有接口变更，请同步更新相关子文档
- 建议每次大版本更新时重新生成汇总文档

