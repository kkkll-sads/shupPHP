# 更新日志 2025-12-28

## 1. 修复与优化

### 1.1 盲盒撮合逻辑修复
- **修复 TypeError**: 修复了 `CollectionMatching.php` 中 `distributeAgentCommission` 方法参数类型声明错误（OutputInterface -> Output）。
- **同步寄售状态**: 修复了盲盒撮合成功后，卖家藏品的 `consignment_status`（user_collection 表）未同步更新为 `0`（未寄售）的问题。这将解决前端"寄售中"标签显示不正确的问题。
- **退差价日志优化**: 优化了盲盒中签退差价的日志记录，在 `user_money_log` 的 `memo` 和 `user_activity_log` 的 `extra` 中添加了 `item_id` 关联，方便前端精确展示。

### 1.2 寄售状态统一管理
- **新增 ConsignmentService**: 创建了 `app\common\service\ConsignmentService.php`，用于统一管理 `collection_consignment` 和 `user_collection` 两个表的寄售状态变更，确保数据一致性。
- **重构应用**: 已将盲盒撮合逻辑中的状态更新重构为使用该 Service。

### 1.3 接口返回字段优化
- **API `detail` & `originalDetail`**: 
    - 移除了 `core_enterprise` 和 `farmer_info` 冗余字段。
    - 确保返回 `price_zone` 价格分区字段。
- **API `bySession`**:
    - **聚合逻辑优化**: 现在将同一资产包（package_name + zone_id）下的官方库存商品和寄售商品合并为一个条目显示。
    - **新增统计字段**: `official_stock`（官方库存）, `consignment_count`（寄售数量）, `min_price/max_price`（价格范围）等。

## 2. 新增功能

### 2.1 后台用户藏品查询
- **后端控制器**: `app\admin\controller\collection\UserCollection.php`
    - 支持按手机号、用户ID、藏品ID、寄售状态查询。
    - 提供藏品详情查询（包含历史寄售记录）。
    - 提供用户藏品统计功能（总值、持有数、寄售数等）。
- **前端页面**: `web/src/views/backend/collection/userCollection/index.vue`
    - 新增“用户藏品管理”页面，方便客服与管理员查询特定用户的持仓情况。

## 3. 文件变更列表

- `app/command/CollectionMatching.php` (修改)
- `app/api/controller/CollectionItem.php` (修改)
- `app/common/service/ConsignmentService.php` (新增)
- `app/admin/controller/collection/UserCollection.php` (新增)
- `web/src/views/backend/collection/userCollection/index.vue` (新增)

---

## 4. 资产包商品数量管理修复

### 4.1 问题描述
- 后台列表无法实时查看资产包中实际有多少商品
- 删除商品后，`generated_count` 字段不会自动更新
- 生成逻辑错误：全部删除商品后，需要设置 101 才能生成 1 个（应该设置 1 就能生成 1 个）

### 4.2 修复内容

#### 列表接口添加实时商品数量
- **文件**: `app/admin/controller/collection/AssetPackage.php`
- **修改**: `index()` 方法添加 `actual_item_count` 字段，实时统计资产包下的实际商品数

#### 修复生成逻辑
- **文件**: `app/admin/controller/collection/AssetPackage.php`
- **修改**: `edit()` 方法改为基于实际商品数量计算需要生成的数量
- **原逻辑**: `需要新增 = item_count - generated_count`
- **新逻辑**: `需要新增 = item_count - 实际商品数量`（实时查询数据库）

#### 删除商品时同步更新计数
- **文件**: `app/admin/controller/collection/Item.php`
- **修改**: `del()` 方法在删除商品后，同步更新资产包的 `generated_count` 和 `total_count`
- **实现**: 使用 SQL `GREATEST(generated_count - 删除数, 0)` 确保字段不为负数

### 4.3 预期效果
- ✅ 资产包列表实时显示实际商品数量
- ✅ 删除商品后，计数自动更新
- ✅ 全部删除后，设置为 1 即可生成 1 个（不需要设置 101）

### 4.4 文件变更
- `app/admin/controller/collection/AssetPackage.php` (修改)
- `app/admin/controller/collection/Item.php` (修改)

---

## 5. 盲盒预约记录状态显示修复

### 5.1 问题描述
- 预约记录列表中 `status=3` 的记录显示 `status_text: "未知"`，应该显示"已取消"

### 5.2 修复内容
- **文件**: `app/admin/controller/collection/TradeReservation.php`
- **修改**: `index()` 方法添加状态文本映射逻辑
- **原因**: 模型访问器不会自动应用到数组数据，需手动处理

### 5.3 状态映射
- 0 → 待处理
- 1 → 已中签
- 2 → 未中签
- 3 → 已取消

### 5.4 增强功能
除修复状态文本外，还添加了：
- 场次信息（标题、开始/结束时间）
- 分区信息（名称、价格范围）
- 商品信息（已中签时显示商品详情、实际成交价、退差价）

### 5.5 文件变更
- `app/admin/controller/collection/TradeReservation.php` (修改)

---

## 6. 藏品管理添加资产包分类筛选

### 6.1 功能说明
为藏品管理添加资产包分类筛选功能，方便按资产包查看和管理藏品

### 6.2 修改内容

#### 模型层
- **文件**: `app/admin/model/CollectionItem.php`
- **修改**: 添加 `package()` 关联方法，建立与资产包的一对一关系

#### 控制器层
- **文件**: `app/admin/controller/collection/Item.php`
- **修改**: 
  - `index()` 方法添加资产包关联查询，返回 `package_name` 字段
  - `add()` 和 `edit()` 方法返回资产包选项供表单选择

### 6.3 预期效果
- ✅ 列表显示每个藏品的资产包名称
- ✅ 支持按资产包筛选藏品
- ✅ 添加/编辑时可选择资产包
- ✅ BuildAdmin 自动生成前端组件

### 6.4 文件变更
- `app/admin/model/CollectionItem.php` (修改)
- `app/admin/controller/collection/Item.php` (修改)
