# 更新日志 - 2025年12月26日

## 新增/重要变更（最新）

### 0) 批量添加藏品功能（21:00 更新）
- **文件**：
  - `app/admin/controller/collection/Item.php`
  - `web/src/views/backend/collection/item/popupForm.vue`
- **功能**：后台添加藏品时支持批量创建，每个藏品自动生成唯一的编号和存证指纹
- **表单新增**：「添加数量」输入框（限制1-100），仅在新增时显示
- **编号区分**：
  - **ID编号**：数据库自增主键自动生成
  - **存证指纹**：`0x` + 32字符十六进制，使用 `random_bytes(16)` 生成
- **前端影响**：❌ 仅后台管理页面变更

### 0.1) 藏品列表资产包归类显示（21:17 更新）
- **文件**：`app/api/controller/CollectionItem.php`
- **接口**：`GET /api/collectionItem/bySession`
- **问题**：批量添加的藏品在列表中分开显示，没有按资产包归类
- **修复**：修改官方商品查询，按 `package_name + zone_id + title` 分组聚合
- **变更**：
  - 同资产包的藏品合并为一条记录
  - `stock` 字段累加显示库存总数
  - `price` 显示最低价
  - 只显示有库存的藏品（`stock > 0`）
  - 返回新增 `package_name` 字段
- **前端影响**：⚠️ 返回数据结构变化，商品合并后 ID 为该组最小 ID

### 0.2) 资产包默认设置逻辑优化（21:47 更新）
- **文件**：`app/admin/controller/collection/AssetPackage.php`
- **问题**：不同名称的资产包在同一场次+分区下只能设置一个默认包
- **业务需求**：
  - 同名资产包按价格分区拆分（如"鲁西蔬菜·1000元区"、"鲁西蔬菜·1500元区"）
  - 每个名称+分区组合都可以有自己的默认包
  - 用户寄售时按价格自动归入对应分区的同名资产包
- **修复**：修改默认包唯一性约束从 `session_id + zone_id` 改为 `name + session_id + zone_id`
- **变更**：
  - 添加/编辑资产包时，只取消**同名+同场次+同分区**的其他默认包
  - 不同名称的资产包可以在同一分区下都设为默认
  - 寄售时动态匹配价格分区（已有 `getOrCreateZoneByPrice` 实现）
- **前端影响**：❌ 仅后台逻辑变更

### 0.3) 寄售手续费字段调整（21:55 更新）
- **文件**：
  - `app/api/controller/CollectionItem.php`
  - `web/src/views/backend/user/user/index.vue`
  - `web/src/views/backend/user/user/popupForm.vue`
- **需求**：用户寄售时使用确权金作为手续费，移除服务金额字段
- **字段映射**（不改数据库结构）：
  - `service_fee_balance` → 显示为"确权金（交易手续费）"
  - `pending_activation_gold` → 显示为"待激活确权金"
  - 删除 `service_fee_balance` 字段的显示
- **变更**：
  - 寄售手续费从 `money` 字段改为 `service_fee_balance` 扣除
  - 手续费不足提示改为"确权金不足"
  - 活动日志备注改为"从确权金扣除"
- **前端影响**：✅ 后台用户管理列表和表单字段名称变更

### 0.4) 资金明细字段类型筛选（22:05 更新）
- **文件**：
  - `database/add_money_log_field_type.sql`
  - `app/api/controller/CollectionItem.php`
  - `web/src/views/backend/user/moneyLog/index.vue`
- **需求**：后台资金明细页面支持按字段类型筛选查看不同金额字段的流水
- **数据库变更**：
  - `ba_user_money_log` 表新增 `field_type` 字段（VARCHAR(50)）
  - 默认值为 `money`（可用金额）
  - 添加索引 `idx_field_type` 和 `idx_user_field`
- **字段类型枚举**：
  - `money` - 可用金额
  - `withdrawable_money` - 可提现金额
  - `service_fee_balance` - 确权金
  - `static_income` - 拓展提现
  - `pending_activation_gold` - 待激活确权金
  - `score` - 消费金
- **前端变更**：
  - 添加"字段类型"列，支持下拉筛选
  - 列名称改为通用名称（变动金额、变动前、变动后）
  - 不同字段类型显示不同颜色标签
- **前端影响**：✅ 后台资金明细页面新增字段类型筛选

### 1) 专场交易时间校验（预约/列表）
- **文件**：`app/api/controller/CollectionItem.php`
- **接口**：`GET /api/collectionItem/bySession`
- **变化**：进入列表前校验专场是否启用且当前时间在 `start_time - end_time` 内，时间外直接返回「交易时间已结束，无法预约/购买」。
- **前端影响**：❌ 接口格式未变，增加错误提示。

### 2) 商品详情双场景合并（market / my）
- **文件**：`app/api/controller/CollectionItem.php`
- **接口**：`GET /api/CollectionItem/detail`
- **参数**：`type=market|my`（默认 `market`）；`id` 为商品ID（market）或用户藏品ID（my）
- **逻辑**：
  - `market`：返回脱敏占位信息（`tx_hash=null`，`asset_code=待确权生成...`，`block_height=等待打包...`，`contract_no=待生成...`，`status=申购中`）。
  - `my`：需登录，返回真实持仓，生成/回填 `tx_hash`、`asset_code`、伪区块高度、合约号，`status=已持仓`。
- **前端影响**：⚠️ H5/小程序需按 `type` 处理；默认兼容旧行为（市场）。

### 3) 寄售限制：严格同场次归类
- **文件**：`app/api/controller/CollectionItem.php`
- **逻辑**：寄售匹配资产包时，增加 `session_id = 当前藏品场次` 过滤，不允许跨场次寄售/归类。
- **前端影响**：❌ 无需修改参数；寄售在非购买场次将被拒绝。

### 4) 资产包归类与价格分区
- **文件**：`app/api/controller/CollectionItem.php`
- **逻辑**：
  - 按当前场次 + 价格分区匹配资产包，优先同名同分区，其次同名通用分区（zone_id=0），再回退当前场次的默认包。
  - 旧资产寄售时自动归入当前场次、同价格分区的包；价格分区由价格映射/动态计算获取。
- **前端影响**：❌ 无需改参；包名/分区归类在后端自动处理。

### 5) API 清单补充
- `GET /api/collectionItem/bySession`：新增交易时间校验。
- `GET /api/CollectionItem/detail`：新增 `type=market|my` 场景合并（脱敏 vs 真实）。
- 寄售归类：`session_id` 绑定 + 分区匹配（无新增参数，后端行为变更）。

## 后端修改（已完成）

### 1. 寄售解锁小时数允许设置为0
- **文件**: `app/admin/controller/content/DrawCountConfig.php`
- **文件**: `app/api/controller/CollectionItem.php`
- **说明**: 
  - 0 表示购买后即可寄售
  - `consignmentCheck` 接口返回 `message: "购买后即可寄售"`
- **前端是否需要更新**: ❌ 不需要（接口返回格式不变）

### 2. 寄售时检查场次是否开启
- **文件**: `app/api/controller/CollectionItem.php`
- **说明**: 
  - 用户提交寄售时会检查藏品关联的场次是否在交易时间内
  - 不在交易时间内时返回错误：`交易场次未开启，XX专场交易时间为 HH:mm - HH:mm，请在场次开启后再进行寄售`
- **前端是否需要更新**: ❌ 不需要（只是增加了错误提示，接口格式不变）

### 3. 撮合池列表状态显示修复
- **文件**: `app/api/controller/CollectionItem.php`
- **说明**: 
  - 修复 `status: cancelled` 时 `status_text` 错误显示为"寄售中"的问题
  - 现在正确显示为"未中签"
- **前端是否需要更新**: ❌ 不需要（字段名不变，只是值的逻辑修正）

### 4. 撮合池列表SQL字段歧义修复
- **文件**: `app/api/controller/CollectionItem.php`
- **说明**: 修复 `matchingPool` 接口500错误（SQL字段歧义）
- **前端是否需要更新**: ❌ 不需要

---

## 后台管理前端修改（已完成）

### 1. 寄售解锁小时数配置
- **文件**: `web/src/views/backend/content/drawCountConfig/components/ConsignmentConfig.vue`
- **说明**: 允许设置为0（之前最小值是1）
- **状态**: ✅ 已构建部署

### 2. 手机号白名单单个导入
- **文件**: `web/src/views/backend/user/mobileWhitelist/index.vue`
- **说明**: 在页面顶部添加手机号输入框和"添加"按钮，支持快速添加单个手机号
- **状态**: ✅ 已构建部署

---

## 总结

| 类型 | 是否需要前端(H5/App)更新 |
|------|-------------------------|
| API接口字段 | ❌ 不需要 |
| 后台管理页面 | ✅ 已完成 |

**结论**: 前端H5/App不需要更新任何接口字段，所有修改都是后端逻辑优化或后台管理页面修改。

---

## 14:32 更新 - 通用验证码 888888 支持

### 1. 找回登录密码（retrievePassword）
- **文件**: `app/api/controller/Account.php`
- **修改**: 添加通用测试验证码 `888888` 放行
- **接口**: `POST /api/Account/retrievePassword`

### 2. 新增：短信验证码重置交易密码
- **文件**: `app/api/controller/User.php`
- **接口**: `POST /api/User/resetPayPasswordBySms`
- **参数**:
  - `mobile`: 手机号
  - `captcha`: 短信验证码（支持 888888）
  - `new_pay_password`: 新交易密码
- **说明**: 用于忘记交易密码的情况，可通过短信验证码重置

### 3. 验证码登录账号检测
- **文件**: `app/api/controller/User.php`
- **说明**: 已有检测，未注册账号不能发送登录验证码

### 4. 短信发送账号检测  
- **文件**: `app/api/controller/Sms.php`
- **说明**: 已有检测：
  - `user_register`: 手机号已注册时拒绝发送
  - `user_retrieve_pwd` / `user_mobile_verify`: 手机号未注册时拒绝发送

---

## 14:56 更新 - 藏品表与详情接口修改

### 1. 藏品表结构修改 (`ba_collection_item`)
- **新增字段**:
  - `asset_code` VARCHAR(50) - 确权编号 (格式: 37-DATA-COLLECTION-00000001)
  - `tx_hash` VARCHAR(64) - 存证指纹 (MD5)
  - `owner_id` INT - 当前持有人 (0=系统)
- **删除字段**:
  - `fingerprint` - 已废弃，功能由 `tx_hash` 替代
- **前端是否需要更新**: ⚠️ 需要（字段名变更）

### 2. 商品详情接口修改
- **接口**: `GET /api/CollectionItem/detail`
- **接口**: `GET /api/CollectionItem/originalDetail`
- **新增返回字段**:
  | 字段 | 类型 | 说明 |
  |------|------|------|
  | `supplier_name` | string | 供应商名称（固定值：山东**供应链管理有限公司(核心企业)）|
  | `tx_hash` | string | 存证指纹 MD5（首次访问时自动生成并存库）|
  | `asset_code` | string | 确权编号（格式：37-DATA-COLLECTION-00000001）|
- **删除返回字段**: `fingerprint`
- **前端是否需要更新**: ⚠️ 需要（`fingerprint` → `tx_hash`）

---

## 完整 API 接口汇总

### 前端API接口（需要H5/App更新）

| 接口 | 类型 | 说明 | 状态 |
|------|------|------|------|
| `POST /api/User/resetPayPasswordBySms` | **新增** | 短信验证码重置交易密码 | ✅ 完成 |
| `GET /api/CollectionItem/detail` | 修改 | 新增 `supplier_name`, `tx_hash`, `asset_code`；删除 `fingerprint` | ✅ 完成 |
| `GET /api/CollectionItem/originalDetail` | 修改 | 同上 | ✅ 完成 |
| `POST /api/collectionItem/bidBuy` | **重大修改** | 新增盲盒预约模式，废弃旧版 `item_id + extra_hashrate` | ✅ 完成 |
| `POST /api/collectionItem/consign` | 修改 | 新增资产包归类（`package_id`, `package_name`）| ✅ 完成 |
| `GET /api/collectionItem/matchingPool` | 修改 | 修复状态显示 | ✅ 完成 |
| `GET /api/collectionItem/consignmentCheck` | 修改 | 支持 `consignment_unlock_hours=0` | ✅ 完成 |

### 后台管理API接口（新增）

| 接口 | 类型 | 说明 | 状态 |
|------|------|------|------|
| `GET /admin/collection.AssetPackage/index` | **新增** | 资产包列表 | ✅ 完成 |
| `POST /admin/collection.AssetPackage/add` | **新增** | 添加资产包 | ✅ 完成 |
| `POST /admin/collection.AssetPackage/edit` | **新增** | 编辑资产包 | ✅ 完成 |
| `POST /admin/collection.AssetPackage/del` | **新增** | 删除资产包 | ✅ 完成 |
| `POST /admin/collection.AssetPackage/setDefault` | **新增** | 设为默认资产包 | ✅ 完成 |

### 后台命令行（修改）

| 命令 | 类型 | 说明 | 状态 |
|------|------|------|------|
| `php think collection:matching` | 修改 | 新增盲盒预约撮合逻辑 | ✅ 完成 |

---

## 15:20 更新 - 盲盒预约模式接口改造

### 1. 价格分区配置修改 (`ba_price_zone_config`)
- **规则变更**：每500元一个分区，最低500元
- **新增分区**：
  | 分区名称 | 价格范围 |
  |---------|---------|
  | 500元区 | 0.01 - 500.00 |
  | 1000元区 | 500.01 - 1000.00 |
  | 1500元区 | 1000.01 - 1500.00 |
  | 2000元区 | 1500.01 - 2000.00 |
  | 2500元区 | 2000.01 - 2500.00 |
  | 3000元区 | 2500.01 - 3000.00 |
  | 3500元区 | 3000.01 - 3500.00 |
  | 4000元区 | 3500.01 - 4000.00 |
  | 4500元区 | 4000.01 - 4500.00 |
- **自动创建**：超过4500元会自动创建新分区（如5000元区、5500元区...）

### 2. 预约撮合池表修改 (`ba_trade_reservations`)
- **新增字段**：
  - `zone_id` - 价格分区ID
  - `product_id` - 匹配商品ID（预约时=0，中签后回填）
  - `power_used` - 消耗算力
  - `match_order_id` - 订单ID
  - `match_time` - 撮合时间

### 3. 预约接口修改 (`POST /api/collectionItem/bidBuy`)
- **新增盲盒预约模式**：
  - 参数：`session_id` + `zone_id` + `extra_hashrate`
  - 冻结金额 = 分区最高价
  - 预约时 `product_id=0`，撮合后回填
- **新增返回字段**：
  - `reservation_id` - 预约记录ID
  - `zone_id` - 分区ID
  - `zone_name` - 分区名称
- **兼容旧版**：~~保留 `item_id` + `extra_hashrate` 模式（将被废弃）~~ **已废弃**
- **前端是否需要更新**: ⚠️ 需要（参数和返回字段变更）

### 4. 业务逻辑说明
```
盲盒预约流程：
1. 用户选择 场次(session_id) + 价格分区(zone_id) + 加注算力(extra_hashrate)
2. 系统验证算力和资金是否充足
3. 扣除算力（直接销毁）
4. 冻结资金（分区最高价）写入 ba_trade_reservations
5. 等待撮合引擎匹配商品
6. 中签：回填 product_id，退还差价（冻结金额 - 商品价格）
7. 未中签：全额退还冻结金额
```

### 5. 接口调用模式汇总
| 模式 | 参数 | 状态 |
|------|------|------|
| 盲盒预约 | `session_id` + `zone_id` + `extra_hashrate` | ✅ 推荐 |
| 寄售购买 | `consignment_id` + `power_used` | ❌ 已移除 |
| 寄售竞价 | `item_id` + `power_used` | ❌ 已移除 |
| 旧版预约 | `item_id` + `extra_hashrate` | ❌ 已废弃 |

---

## 15:55 更新 - 资产包功能实现

### 1. 新增资产包表 (`ba_asset_package`)
- **文件**: `database/asset_package.sql`
- **字段**:
  | 字段 | 类型 | 说明 |
  |------|------|------|
  | `session_id` | int | 关联场次ID |
  | `zone_id` | int | 关联分区ID（0=通用包）|
  | `name` | varchar(100) | 资产包名称 |
  | `is_default` | tinyint | 是否为默认包 |
  | `total_count` | int | 包内商品总数 |
  | `sold_count` | int | 已售数量 |

### 2. 寄售表修改 (`ba_collection_consignment`)
- **新增字段**:
  - `package_id` - 归属资产包ID
  - `package_name` - 归属资产包名称（冗余存储）

### 3. 预约表修改 (`ba_trade_reservations`)
- **新增字段**:
  - `package_id` - 匹配资产包ID

### 4. 寄售逻辑修改
- **文件**: `app/api/controller/CollectionItem.php`
- **修改**:
  - 寄售时根据价格自动匹配分区
  - 自动关联当前场次+分区的默认资产包
  - 寄售记录包含 `package_id` 和 `package_name`

### 5. 撮合脚本修改
- **文件**: `app/command/CollectionMatching.php`
- **新增功能**:
  - 盲盒预约撮合（`ba_trade_reservations`）
  - **撮合优先级**：旧资产包 > 老用户寄售 > 系统单 > 新用户单
  - 自动回填 `product_id`
  - 退还差价（冻结金额 - 商品价格）

### 6. 后台配置说明
创建资产包后，需在后台设置：
1. 关联场次和分区
2. 设置 `is_default = 1` 使其成为默认资产包
3. 用户寄售时会自动归入对应资产包

### 7. 后台管理页面
- **控制器**: `app/admin/controller/collection/AssetPackage.php`
- **模型**: `app/admin/model/AssetPackage.php`
- **验证器**: `app/admin/validate/AssetPackage.php`
- **前端**: `web/src/views/backend/collection/assetPackage/`
- **菜单SQL**: `database/add_asset_package_menu.sql`

**功能**:
- 资产包列表（分页、搜索）
- 新增/编辑资产包
- 关联场次和分区
- 设为默认包
- 删除检查（有寄售商品时禁止删除）

## �� 前端接口对接详细说明 (2025-12-26 更新)

### 1. 短信验证码重置交易密码 (新增)
> **接口**: `POST /api/User/resetPayPasswordBySms`
> **场景**: 用户在个人中心忘记支付密码时，通过手机验证码重置。

- **请求参数**:
  | 参数名 | 类型 | 必填 | 说明 |
  |---|---|---|---|
  | `mobile` | `string` | 是 | 手机号 |
  | `captcha` | `string` | 是 | 短信验证码 (测试环境可用 `888888`) |
  | `new_pay_password` | `string` | 是 | 新支付密码 (6-32位，无特殊字符) |

- **响应**: `{ "code": 1, "msg": "支付密码重置成功", "data": null }`

---

### 2. 藏品详情接口 (修改)
> **接口**: `GET /api/CollectionItem/detail` & `GET /api/CollectionItem/originalDetail`
> **场景**: 藏品详情页/原始详情页展示。

- **新增返回字段**:
  | 字段名 | 类型 | 说明 |
  |---|---|---|
  | `supplier_name` | `string` | 供应商名称 (固定显示: 山东**供应链管理有限公司(核心企业)) |
  | `tx_hash` | `string` | 交易哈希 (模拟区块链哈希) |
  | `asset_code` | `string` | 资产编码 (格式: 37-DATA-COLLECTION-0000XXXX) |

- **删除/废弃字段**:
  - `fingerprint` (已移除，请停止使用)

---

### 3. 盲盒预约接口 (重大修改)
> **接口**: `POST /api/collectionItem/bidBuy`
> **场景**: 用户进行盲盒预约，选择场次和价格分区。

**⚠️ 重要变更（2025-12-26 17:26）**: 
- 移除了 `consignment_id` 购买寄售模式
- 移除了 `item_id + power_used` 竞价模式
- **只保留盲盒预约模式**：所有用户必须先预约，然后等待撮合

#### 请求参数
| 参数名 | 类型 | 必填 | 说明 |
|---|---|---|---|
| `session_id` | `int` | 是 | 场次ID |
| `zone_id` | `int` | 是 | 价格分区ID (如 1=500元区, 2=1000元区) |
| `extra_hashrate` | `float` | 否 | 额外加注算力 (0-50，增加权重) |

#### 业务逻辑
1. 验证用户绿色算力 >= 基础消耗(5) + 加注算力
2. 验证用户余额 >= 分区最高价 (`max_price`)
3. 扣除算力、冻结余额
4. 写入 `ba_trade_reservations` 表等待撮合
5. 撮合成功后按资产包匹配商品

#### 返回示例
```json
{
  "code": 1,
  "msg": "盲盒预约成功！等待撮合结果",
  "data": {
    "reservation_id": 123,
    "freeze_amount": 1500.00,
    "power_used": 10.0,
    "weight": 150,
    "zone_id": 2,
    "zone_name": "1000元区",
    "session_id": 5,
    "message": "预约并冻结成功，等待撮合。中签后将匹配1000元区内商品。"
  }
}
```

---

### 4. 寄售申请 (修改)
> **接口**: `POST /api/collectionItem/consign`
> **场景**: 用户将在持藏品上架寄售。

- **后端变更**: 系统会自动根据商品价格和场次，将寄售商品归类到对应的**资产包 (Asset Package)**。
- **前端工作**:
  - 无需传额外参数。
  - 成功响应中 `data` 暂未变化，但后端数据已关联 `package_id`。

---

### 5. 撮合池列表 (修改)
> **接口**: `GET /api/collectionItem/matchingPool`
> **场景**: 用户查看自己的预约/竞价记录。

- **优化**:
  - 修复了 `status` 筛选逻辑，支持 `pending` (匹配中), `matched` (已匹配), `cancelled` (已取消)。
  - 默认按 `weight` (权重) 降序排列。
  - 返回字段增加了关联的 `session_title` 和 `zone_name` (如果是盲盒模式)。

---

### 6. 寄售资格检查 (修改)
> **接口**: `GET /api/collectionItem/consignmentCheck`
> **场景**: 用户点击“寄售”按钮前检查是否满足时间限制。

- **变更**:
  - 支持后台配置 `consignment_unlock_hours = 0`，即购买后可立即寄售。
  - 返回字段 `unlock_hours` 可能为 `0`，前端文案需兼容“0小时”或“立即”的显示。

---

### 7. 藏品管理表单与详情文案 (修改)
- 后台「藏品管理-添加/编辑」表单：移除"艺术家/创作者""藏品描述"，新增"核心企业""关联农户"字段。
- 数据库：`ba_collection_item` 新增 `core_enterprise`、`farmer_info` 列，存储单个藏品的核心企业与关联农户文案。
- 前台/接口：`/api/collectionItem/detail` 优先返回藏品自定义的核心企业、关联农户文案，购买前后展示一致；若未填写则回落到系统配置。

---

## 19:00 更新 - 藏品管理新增场次与价格分区字段

### 1. 藏品表结构修改 (`ba_collection_item`)
- **新增字段**：
  | 字段 | 类型 | 说明 |
  |------|------|------|
  | `session_id` | int | 关联专场ID |
  | `zone_id` | int | 价格分区ID（自动匹配） |

### 2. 后台藏品管理表单修改
- **文件**：`web/src/views/backend/collection/item/popupForm.vue`
- **新增字段**：
  - 专场选择（session_id）：下拉选择关联专场
  - 价格分区（zone_id）：下拉选择，**支持根据价格自动匹配**
- **自动匹配逻辑**：
  - 用户输入价格后，系统自动查找匹配的价格分区
  - 匹配规则：`min_price <= 价格 <= max_price`
  - 若无匹配则选择第一个可用分区

### 3. 后台藏品列表修改
- **文件**：`web/src/views/backend/collection/item/index.vue`
- **新增列**：
  - 专场（显示专场名称 + ID）
  - 价格分区（显示分区名称 + ID）
  - 核心企业
  - 关联农户
- **移除列**：
  - 艺术家/创作者

### 4. 后端验证器修改
- **文件**：`app/admin/validate/CollectionItem.php`
- **修改**：
  - 新增 `session_id`、`zone_id`、`core_enterprise`、`farmer_info` 验证规则
  - 移除 `artist` 验证规则
  - 修复 `Call to a member function has() on null` 错误（注入 Lang 对象）

---

## 19:30 更新 - 强制撮合功能

### 1. 撮合脚本新增 `--force` 参数
- **文件**：`app/command/CollectionMatching.php`
- **命令**：`php think collection:matching --force` 或 `php think collection:matching -f`
- **功能**：强制执行撮合，忽略场次交易时间检查
- **使用场景**：测试环境、紧急撮合、场次结束后补撮

### 2. 后台脚本监控新增"强制撮合"按钮
- **文件**：`web/src/views/backend/finance/scriptMonitor/index.vue`
- **文件**：`app/admin/controller/finance/ScriptMonitor.php`
- **功能**：
  - 在"藏品撮合池撮合"脚本卡片上新增「强制撮合」按钮（橙色警告色）
  - 点击后弹出确认框，提示"强制模式，忽略时间检查"
  - 后端接收 `force=1` 参数，传递 `--force` 给命令行

### 3. 后端控制器修改
- **文件**：`app/admin/controller/finance/ScriptMonitor.php`
- **修改**：`run()` 方法接收 `force` 参数，拼接 `--force` 到命令

---

## 19:45 更新 - 用户金额字段溢出修复

### 1. 问题描述
- **错误**：`SQLSTATE[22003]: Numeric value out of range: 1264 Out of range value for column 'money' at row 1`
- **原因**：`ba_user` 表金额字段类型为 `decimal(10,2)`，最大值为 `99,999,999.99`
- **触发场景**：后台编辑用户时输入超过最大值的金额

### 2. 修复方案
- **文件**：`app/admin/controller/user/User.php`
- **修改**：在 `edit()` 方法中对金额字段进行范围限制
- **受影响字段**：
  | 字段 | 说明 |
  |------|------|
  | `money` | 账户余额 |
  | `withdrawable_money` | 可提现余额 |
  | `balance_available` | 可用余额 |
  | `service_fee_balance` | 服务费余额 |
  | `service_fee_balance` | 确权金 |
  | `pending_activation_gold` | 待激活金 |
- **限制规则**：
  - 最大值：`99,999,999.99`
  - 最小值：`0`（不允许负数）

---

## 20:00 更新 - 盲盒撮合支持官方上架商品

### 1. 问题描述
- **现象**：盲盒预约后撮合显示"无可匹配商品"
- **原因**：撮合脚本只匹配寄售商品（`ba_collection_consignment`），不匹配官方上架商品（`ba_collection_item`）
- **影响**：项目初期官方未上架商品时无法完成撮合

### 2. 撮合逻辑修改
- **文件**：`app/command/CollectionMatching.php`
- **修改**：盲盒预约撮合增加官方商品匹配逻辑
- **撮合优先级**（从高到低）：
  1. 寄售商品（用户挂单）
  2. 官方上架商品（`ba_collection_item` 库存 > 0）

### 3. 官方商品匹配条件
| 条件 | 说明 |
|------|------|
| `status = 1` | 上架中 |
| `stock > 0` | 有库存 |
| `session_id = 预约场次` | 同场次 |
| `zone_id = 预约分区 OR zone_id = 0` | 同分区或通用 |
| `price <= 冻结金额` | 价格不超过冻结金额 |

### 4. 官方商品撮合后处理
- 扣减 `ba_collection_item.stock`
- 库存变为 0 时自动下架（`status = 0`）
- 生成订单并关联到对应资产包

### 5. 代码示例
```php
// 若无寄售商品，尝试匹配官方上架商品
$officialItem = Db::name('collection_item')
    ->alias('ci')
    ->leftJoin('asset_package ap', 'ap.session_id = ci.session_id AND (ap.zone_id = ci.zone_id OR ap.zone_id = 0)')
    ->where('ci.status', 1)
    ->where('ci.stock', '>', 0)
    ->where('ci.session_id', $sessionId)
    ->where(function($query) use ($zoneId) {
        $query->where('ci.zone_id', $zoneId)
              ->whereOr('ci.zone_id', 0);
    })
    ->where('ci.price', '<=', $freezeAmount)
    ->field('ci.*, ap.id as package_id')
    ->order('ci.id', 'asc')
    ->lock(true)
    ->find();
```

---

## 完整修改文件清单 (2025-12-26)

### 后端 PHP 文件
| 文件 | 修改类型 | 说明 |
|------|---------|------|
| `app/api/controller/CollectionItem.php` | 修改 | 详情双场景、寄售限制、交易时间校验 |
| `app/command/CollectionMatching.php` | 修改 | 新增 `--force` 参数、官方商品撮合 |
| `app/admin/controller/finance/ScriptMonitor.php` | 修改 | 接收 `force` 参数 |
| `app/admin/controller/user/User.php` | 修改 | 金额字段溢出修复 |
| `app/admin/controller/collection/Item.php` | 修改 | 快速搜索字段更新 |
| `app/admin/model/CollectionItem.php` | 修改 | 新增属性定义 |
| `app/admin/validate/CollectionItem.php` | 修改 | 验证规则更新、Lang 注入 |

### 前端 Vue 文件
| 文件 | 修改类型 | 说明 |
|------|---------|------|
| `web/src/views/backend/collection/item/index.vue` | 修改 | 列表列更新 |
| `web/src/views/backend/collection/item/popupForm.vue` | 修改 | 表单字段更新、价格自动分区 |
| `web/src/views/backend/finance/scriptMonitor/index.vue` | 修改 | 新增强制撮合按钮 |
| `web/src/api/common.ts` | 修改 | 新增 `custom` 方法 |

### 数据库变更
| 表 | 字段 | 类型 | 说明 |
|------|------|------|------|
| `ba_collection_item` | `session_id` | int | 关联专场ID |
| `ba_collection_item` | `zone_id` | int | 价格分区ID |
| `ba_collection_item` | `core_enterprise` | varchar(255) | 核心企业 |
| `ba_collection_item` | `farmer_info` | varchar(255) | 关联农户 |


## 20:30 更新 - 用户升级与寄售功能增强

### 1. 用户升级与寄售券发放规则
- **文件**: `app/common/service/UserService.php`
- **升级规则**:
  - 第1次购买完成：升级为 **普通用户** (`user_type` 0 → 1)
  - 第2次购买完成：升级为 **交易用户** (`user_type` 1 → 2)
- **寄售券奖励**:
  - **首次升级**为交易用户时，赠送一张寄售券
  - **交易用户**每次购买藏品，额外赠送一张寄售券
  - **绑定属性**: 寄售券绑定购买时的 **场次(session_id)** 和 **价格分区(zone_id)**
  - **使用限制**: 寄售时只能在 **同一场次**，**同一分区或跨一个分区** 使用

### 2. 寄售订单自动清退机制
- **文件**: `app/command/CollectionMatching.php`
- **文件**: `app/common/service/UserService.php`
- **功能**:
  - 场次撮合结束后，系统自动检查该场次未成交的寄售订单
  - **自动清退**: 将寄售状态改为 `cancelled` (3)
  - **不退费**: **不退还**使用的寄售券和手续费
  - **补偿机制**: 自动给该藏品增加一次 **免费寄售次数** (`free_consign_attempts + 1`)

### 3. 寄售体验优化
- **文件**: `app/api/controller/CollectionItem.php`
- **优先使用免费次数**:
  - 能够检测 `free_consign_attempts`，若大于0则本次寄售 **免费** (无需券，免手续费)
  - 优先消耗免费次数，不扣除寄售券
- **严格校验**:
  - 正常寄售时，严格校验寄售券的场次和分区匹配
  - 必须匹配 `session_id` 且 `zone_id` 符合要求

### 4. 数据库变更
- **表**: `ba_user_consignment_coupon`
  - 新增 `session_id` (int) - 绑定场次
  - 新增 `zone_id` (int) - 绑定分区
- **表**: `ba_user_collection`
  - 确认已有 `free_consign_attempts` (int) - 免费寄售次数

---

## 2025-12-27 更新 - 寄售券接口与后台管理

### 1. 后台用户管理寄售券显示修复
- **文件**: `app/admin/controller/user/User.php`
- **文件**: `web/src/views/backend/user/user/index.vue`
- **问题**: 后台用户列表"寄售卷"列显示不正确
- **修复**: 
  - 后端从 `ba_user_consignment_coupon` 表统计用户可用寄售券数量
  - 前端字段映射从 `consignment_coupon` 改为 `available_coupon_count`
  - 只统计状态为可用（status=1）且未过期（expire_time > now）的寄售券

### 2. 寄售券 API 接口文档

#### 2.1 寄售券数据表结构 (`ba_user_consignment_coupon`)
| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | int | 主键 |
| `user_id` | int | 用户ID |
| `session_id` | int | 绑定场次ID |
| `zone_id` | int | 绑定价格区间ID |
| `price_zone` | varchar | 价格区间名称 |
| `expire_time` | int | 过期时间戳 |
| `status` | tinyint | 状态（1=可用, 0=已使用） |
| `create_time` / `update_time` | int | 时间戳 |

#### 2.2 获取用户寄售券数量
> **接口**: `GET /api/collectionItem/purchaseRecords`
> **返回字段**: `consignment_coupon` - 用户可用寄售券总数

#### 2.3 寄售券发放规则
- **交易用户（user_type >= 2）**：每次购买藏品都会获得一张绑定到**场次+价格区间**的寄售券
- **普通用户升级**：首次升级为交易用户时，赠送一张寄售券
- **有效期**：默认30天

#### 2.4 寄售券使用规则
- 寄售时系统自动匹配可用寄售券
- 必须匹配 `session_id`（场次）
- `zone_id` 可以是同一区间或相邻区间（允许跨一个区间寄售）
- 优先使用快过期的寄售券

### 3. 后台管理变更
- **用户列表**: `available_coupon_count` 字段 - 用户可用寄售券数量（从新表统计）
- **搜索功能**: 移除寄售卷数量搜索（因为现在是动态统计值）

### 4. 新增寄售卷明细管理页面
- **后端控制器**: `app/admin/controller/user/ConsignmentCoupon.php`
- **后端模型**: `app/admin/model/UserConsignmentCoupon.php`
- **前端页面**: `web/src/views/backend/user/consignmentCoupon/index.vue`
- **菜单 SQL**: `database/add_consignment_coupon_menu.sql`
- **功能**:
  - 查看所有用户的寄售券明细
  - 显示用户信息、场次、价格分区
  - 状态筛选（可用/已使用/已过期）
  - 过期时间显示
  - 支持快速搜索（用户名/昵称/手机号）

### 5. 新增用户端寄售券列表 API

#### GET /api/user/consignmentCoupons

获取当前登录用户的寄售券列表

**请求参数**
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| page | int | 否 | 页码，默认1 |
| limit | int | 否 | 每页数量，默认50，最大100 |
| status | int | 否 | 状态过滤：1=可用，0=已使用 |

**返回字段**
```json
{
  "code": 1,
  "msg": "",
  "data": {
    "list": [
      {
        "id": 1,
        "session_id": 5,
        "zone_id": 2,
        "price_zone": "1000-2000",
        "expire_time": 1735344000,
        "expire_time_text": "2024-12-28 00:00:00",
        "status": 1,
        "status_text": "可用",
        "create_time_text": "2024-12-27 10:00:00",
        "session_title": "第5场",
        "zone_name": "1000-2000元区"
      }
    ],
    "total": 10,
    "page": 1,
    "limit": 50,
    "available_count": 5
  }
}
```


