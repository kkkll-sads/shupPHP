# API接口变更清单 - 2025年12月27日（晚间更新）

**更新时间**：2025-12-27 21:00  
**更新类型**：功能增强、数据完整性优化  
**影响范围**：寄售订单、用户成本统计

---

## 一、更新接口列表

### 1.1 GET /api/collectionItem/myConsignmentList
**功能**：查询我的寄售列表

**变更类型**：🔄 更新（新增返回字段）

**接口地址**：`GET /api/collectionItem/myConsignmentList`

**请求参数**：（无变化）
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| page | int | 否 | 页码，默认1 |
| limit | int | 否 | 每页数量，默认10，最大50 |
| status | int | 否 | 寄售状态：0=全部, 1=寄售中, 2=已售出, 3=已取消 |

**返回参数变更**：

#### 新增字段

| 字段名 | 类型 | 状态 | 说明 | 示例 |
|--------|------|------|------|------|
| `list[].service_fee` | float | 🆕 新增 | 服务费（从确权金扣除） | `15.00` |
| `list[].total_cost` | float | 🆕 新增 | 用户实际成本（寄售价格+服务费） | `515.00` |

#### 保留字段（无变化）
- `list[].consignment_id` - 寄售记录ID
- `list[].consignment_price` - 寄售价格
- `list[].consignment_status` - 寄售状态
- `list[].consignment_status_text` - 寄售状态文字
- `list[].title` - 藏品标题
- `list[].image` - 藏品图片
- ... 其他字段

**返回数据示例（更新前）**：
```json
{
  "code": 1,
  "msg": "success",
  "data": {
    "list": [
      {
        "consignment_id": 123,
        "user_id": 456,
        "consignment_price": 500.00,
        "consignment_status": 1,
        "consignment_status_text": "寄售中",
        "title": "富春山居图",
        "image": "https://xxx.com/xxx.jpg",
        "create_time": 1735308000,
        "create_time_text": "2025-12-27 20:00:00"
      }
    ],
    "total": 10,
    "per_page": 10,
    "current_page": 1
  }
}
```

**返回数据示例（更新后）**：
```json
{
  "code": 1,
  "msg": "success",
  "data": {
    "list": [
      {
        "consignment_id": 123,
        "user_id": 456,
        "consignment_price": 500.00,
        "service_fee": 15.00,           // ✅ 新增：服务费
        "total_cost": 515.00,            // ✅ 新增：实际成本 = 寄售价格 + 服务费
        "consignment_status": 1,
        "consignment_status_text": "寄售中",
        "title": "富春山居图",
        "image": "https://xxx.com/xxx.jpg",
        "create_time": 1735308000,
        "create_time_text": "2025-12-27 20:00:00"
      }
    ],
    "total": 10,
    "per_page": 10,
    "current_page": 1
  }
}
```

**兼容性**：✅ 完全向下兼容（只新增字段，不删除或修改现有字段）

**前端影响**：
1. **必须更新**：在寄售列表中展示服务费和实际成本
2. **UI优化建议**：
   ```
   寄售价格：¥500.00
   服务费：  ¥15.00
   ──────────────────
   实际成本：¥515.00
   ```
3. **历史数据处理**：旧的寄售记录 `service_fee` 为 `0.00`

**业务说明**：
- **服务费来源**：用户提交寄售时从确权金扣除的手续费
- **计算规则**：
  - 正常寄售：`service_fee = consignment_price × 3%`
  - 代理优惠：`service_fee = consignment_price × 3% × 折扣率`
  - 免费重发：`service_fee = 0`（流拍后重新上架）
- **实际成本**：`total_cost = consignment_price + service_fee`

---

## 二、数据库变更

### 2.1 ba_collection_consignment 表新增字段

| 字段名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `service_fee` | decimal(12,2) | 0.00 | 服务费（从确权金扣除） |

**SQL 脚本**：
```sql
ALTER TABLE `ba_collection_consignment`
ADD COLUMN `service_fee` decimal(12,2) NOT NULL DEFAULT '0.00' 
COMMENT '服务费（从确权金扣除）' AFTER `price`;
```

**字段位置**：紧跟在 `price` 字段之后

**数据一致性**：
- ✅ 新创建的寄售记录自动记录服务费
- ✅ 历史寄售记录的 `service_fee` 默认为 `0.00`
- ✅ 服务费与 `user_activity_log` 中的记录相互印证

---

## 三、内部逻辑变更（无接口变化）

### 3.1 POST /api/collectionItem/consign
**功能**：提交藏品寄售

**变更类型**：🔧 内部逻辑增强（记录服务费）

**变更内容**：
- 寄售创建时，将计算出的服务费写入 `ba_collection_consignment.service_fee` 字段
- 服务费金额与扣除确权金的金额一致
- 免费重发时，`service_fee = 0`

**对外接口**：无变化（提交参数和返回值均无变化）

**前端影响**：无（内部逻辑，前端无感知）

---

## 四、API文档更新

### 4.1 Apidoc 注解更新

**文件**：`app/api/controller/CollectionItem.php`

**新增注解**：
```php
Apidoc\Returned("list[].service_fee", type: "float", desc: "服务费（从确权金扣除）"),
Apidoc\Returned("list[].total_cost", type: "float", desc: "用户实际成本（寄售价格+服务费）"),
```

**位置**：`myConsignmentList` 方法的 Apidoc 注解部分

---

## 五、前端对接指南

### 5.1 代码示例

#### JavaScript 示例
```javascript
// 获取寄售列表
async function getMyConsignmentList() {
  const response = await fetch('/api/collectionItem/myConsignmentList', {
    headers: {
      'batoken': userToken
    }
  });
  
  const data = await response.json();
  
  data.data.list.forEach(item => {
    console.log('寄售价格:', item.consignment_price);
    console.log('服务费:', item.service_fee);         // ✅ 新增字段
    console.log('实际成本:', item.total_cost);         // ✅ 新增字段
    console.log('状态:', item.consignment_status_text);
  });
}
```

#### Vue3 示例
```vue
<template>
  <div class="consignment-list">
    <div v-for="item in list" :key="item.consignment_id" class="consignment-item">
      <div class="item-info">
        <img :src="item.image" :alt="item.title" />
        <h3>{{ item.title }}</h3>
        <span class="status">{{ item.consignment_status_text }}</span>
      </div>
      
      <div class="cost-detail">
        <div class="cost-row">
          <span>寄售价格：</span>
          <span>¥{{ item.consignment_price.toFixed(2) }}</span>
        </div>
        <div class="cost-row">
          <span>服务费：</span>
          <span>¥{{ item.service_fee.toFixed(2) }}</span>
        </div>
        <div class="cost-row total">
          <span>实际成本：</span>
          <span>¥{{ item.total_cost.toFixed(2) }}</span>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { getMyConsignmentList } from '@/api/collection';

const list = ref([]);

onMounted(async () => {
  const res = await getMyConsignmentList();
  list.value = res.data.list;
});
</script>
```

### 5.2 UI 展示建议

#### 方案1：列表展示
```
┌─────────────────────────────────┐
│ 富春山居图                      │
│ 寄售中                          │
├─────────────────────────────────┤
│ 寄售价格    ¥500.00             │
│ 服务费      ¥15.00              │
│ ─────────────────────────────── │
│ 实际成本    ¥515.00             │
└─────────────────────────────────┘
```

#### 方案2：折叠展示（默认只显示实际成本）
```
┌─────────────────────────────────┐
│ 富春山居图        实际成本 ¥515 │
│ 寄售中              [详情 ▼]    │
│                                 │
│ 【展开后】                      │
│ • 寄售价格：¥500.00             │
│ • 服务费：¥15.00 (3%)           │
└─────────────────────────────────┘
```

### 5.3 特殊情况处理

#### 历史数据（service_fee = 0）
```javascript
// 对于旧的寄售记录，service_fee 可能为 0
// 需要判断是否为历史数据
if (item.service_fee === 0 && item.create_time < 1735308000) {
  // 历史数据，可能没有记录服务费
  console.log('历史寄售记录（未记录服务费）');
} else if (item.service_fee === 0) {
  // 免费重发（流拍后重新上架）
  console.log('免费重发，无服务费');
}
```

#### 服务费计算验证（前端校验）
```javascript
// 验证服务费是否合理（3%左右）
const expectedFee = item.consignment_price * 0.03;
const diff = Math.abs(item.service_fee - expectedFee);

if (diff > 1 && item.service_fee !== 0) {
  console.warn('服务费异常，可能享受了代理优惠');
}
```

---

## 六、测试验证

### 6.1 接口测试

#### 测试用例1：正常寄售
```bash
# 1. 提交寄售（价格500元）
curl -X POST "https://your-domain.com/api/collectionItem/consign" \
  -H "batoken: user_token" \
  -d "user_collection_id=123&consignment_price=500"

# 2. 查看寄售列表
curl -X GET "https://your-domain.com/api/collectionItem/myConsignmentList" \
  -H "batoken: user_token"
```

**预期返回**：
- `service_fee`: `15.00` （500 × 0.03）
- `total_cost`: `515.00` （500 + 15）

#### 测试用例2：免费重发
```bash
# 流拍后重新上架
curl -X POST "https://your-domain.com/api/collectionItem/consign" \
  -H "batoken: user_token" \
  -d "user_collection_id=124&consignment_price=500"
```

**预期返回**：
- `service_fee`: `0.00`
- `total_cost`: `500.00`

#### 测试用例3：代理优惠
```bash
# 代理用户寄售（假设折扣率0.8）
curl -X POST "https://your-domain.com/api/collectionItem/consign" \
  -H "batoken: agent_token" \
  -d "user_collection_id=125&consignment_price=500"
```

**预期返回**：
- `service_fee`: `12.00` （500 × 0.03 × 0.8）
- `total_cost`: `512.00`

### 6.2 数据验证

#### SQL 验证
```sql
-- 验证寄售记录的服务费
SELECT 
    id,
    user_id,
    price AS 寄售价格,
    service_fee AS 服务费,
    (price + service_fee) AS 实际成本,
    CASE 
        WHEN service_fee = 0 THEN '免费重发或历史数据'
        WHEN service_fee = price * 0.03 THEN '正常寄售'
        ELSE '代理优惠'
    END AS 服务费类型,
    status AS 状态,
    FROM_UNIXTIME(create_time) AS 创建时间
FROM ba_collection_consignment
ORDER BY id DESC
LIMIT 20;
```

#### 一致性检查
```sql
-- 验证服务费是否与活动日志一致
SELECT 
    c.id AS 寄售ID,
    c.price AS 寄售价格,
    c.service_fee AS 记录的服务费,
    JSON_UNQUOTE(JSON_EXTRACT(al.extra, '$.service_fee')) AS 日志中的服务费,
    CASE 
        WHEN c.service_fee = JSON_UNQUOTE(JSON_EXTRACT(al.extra, '$.service_fee')) THEN '一致'
        ELSE '不一致'
    END AS 一致性
FROM ba_collection_consignment c
LEFT JOIN ba_user_activity_log al 
    ON al.user_id = c.user_id 
    AND al.action_type = 'consignment_fee'
    AND JSON_EXTRACT(al.extra, '$.user_collection_id') = c.user_collection_id
WHERE c.create_time > UNIX_TIMESTAMP('2025-12-27 21:00:00')
ORDER BY c.id DESC;
```

---

## 七、常见问题

### Q1: 历史寄售记录的 service_fee 为什么是 0？
**A**: 在本次更新之前创建的寄售记录，数据库中 `service_fee` 字段默认为 `0.00`。这些历史记录的服务费信息可以从 `user_activity_log` 表中查询，但不影响新的寄售记录。

### Q2: 如何判断是"历史数据"还是"免费重发"？
**A**: 
- **历史数据**：`service_fee = 0` 且 `create_time < 1735308000`（2025-12-27 21:00之前）
- **免费重发**：`service_fee = 0` 且 `create_time >= 1735308000`，且该藏品有流拍记录

### Q3: 前端如何处理不同的服务费场景？
**A**: 建议按以下优先级处理：
1. 如果 `service_fee > 0`，正常显示服务费和实际成本
2. 如果 `service_fee = 0` 且是新记录，显示"免费重发"标签
3. 如果 `service_fee = 0` 且是历史记录，显示"历史记录"或不显示服务费

### Q4: 服务费可以退还吗？
**A**: 不可以。服务费是用户提交寄售时从确权金中扣除的手续费，无论寄售是否成功都不退还。流拍后系统会给予"免费重发"资格，下次寄售时不收取服务费。

### Q5: 代理用户的服务费折扣如何查询？
**A**: 代理用户的服务费折扣率存储在系统配置中（`agent_service_discount`），前端无法直接查询。但可以通过 `service_fee` 字段反推：
```javascript
const discountRate = item.service_fee / (item.consignment_price * 0.03);
// discountRate < 1 表示享受了折扣
```

---

## 八、升级建议

### 8.1 前端升级优先级
- 🔴 **高优先级**（必须升级）：寄售列表页面需要展示服务费和实际成本
- 🟡 **中优先级**（建议升级）：寄售详情页面、用户成本统计页面
- 🟢 **低优先级**（可选升级）：历史数据提示、代理优惠标识

### 8.2 升级步骤
1. **接口适配**：更新寄售列表 API 调用，处理新增字段
2. **UI调整**：设计并实现服务费和实际成本的展示界面
3. **测试验证**：测试正常寄售、免费重发、历史数据等场景
4. **灰度发布**：先在测试环境验证，再逐步发布到生产环境

### 8.3 兼容性保障
- ✅ 旧版前端继续使用不受影响（只是看不到新字段）
- ✅ 新版前端对历史数据兼容（service_fee = 0 时优雅降级）
- ✅ 接口完全向下兼容（只新增字段，不修改现有字段）

---

## 九、相关文档

| 文档名称 | 路径 | 说明 |
|---------|------|------|
| 修复说明文档 | `docs/修复_寄售订单服务费记录.md` | 详细的技术实现和修复说明 |
| 数据库迁移脚本 | `database/add_service_fee_to_consignment.sql` | 数据库结构变更SQL |
| 寄售业务逻辑文档 | `docs/寄售业务逻辑说明.md` | 寄售业务的完整流程说明 |
| 财务架构文档 | `docs/财务架构与资金流向分析.md` | 资金流向和账户体系说明 |

---

## 十、更新历史

| 版本 | 日期 | 更新内容 | 负责人 |
|------|------|----------|--------|
| v1.0 | 2025-12-27 21:00 | 初版发布，新增寄售服务费字段 | AI Assistant |

---

## 十一、联系方式

如有疑问或建议，请联系：
- **技术负责人**：[待补充]
- **产品负责人**：[待补充]
- **紧急联系**：[待补充]

---

**文档状态**：✅ 已发布  
**最后更新**：2025-12-27 21:00  
**审核状态**：待审核

