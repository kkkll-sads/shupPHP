# 修复定时任务配置

## 🔴 问题确认

根据日志显示，定时任务配置使用了**错误的命令**：

```bash
php think collection:matching  # ❌ 错误 - 项目中没有 think 文件
```

## ✅ 正确的配置方式

### 方案1：使用包装脚本（最简单）

```bash
cd /www/wwwroot/23.248.226.82 && bash run_matching.sh >> /tmp/collection_matching.log 2>&1
```

### 方案2：使用完整的 PHP 命令

```bash
cd /www/wwwroot/23.248.226.82 && php -r "require 'vendor/autoload.php'; \$app = new think\App(); \$app->console->run();" collection:matching >> /tmp/collection_matching.log 2>&1
```

## 📋 修复步骤

### 如果使用宝塔面板

1. 登录宝塔面板
2. 进入 **计划任务**
3. 找到撮合相关的任务
4. 修改执行脚本为以下内容：

```bash
cd /www/wwwroot/23.248.226.82 && bash run_matching.sh
```

5. 保存并测试执行

### 如果使用系统 Crontab

1. 编辑 crontab：
```bash
crontab -e
```

2. 找到并修改撮合任务：

**错误的配置**（删除或修改）：
```cron
* * * * * cd /www/wwwroot/23.248.226.82 && php think collection:matching
```

**正确的配置**（使用以下之一）：
```cron
# 方式1：使用包装脚本（推荐）
* * * * * cd /www/wwwroot/23.248.226.82 && bash run_matching.sh >> /tmp/collection_matching.log 2>&1

# 方式2：使用完整命令
* * * * * cd /www/wwwroot/23.248.226.82 && php -r "require 'vendor/autoload.php'; \$app = new think\App(); \$app->console->run();" collection:matching >> /tmp/collection_matching.log 2>&1
```

3. 保存退出（vim: `:wq`）

4. 验证配置：
```bash
crontab -l | grep collection
```

## 🧪 测试验证

### 1. 立即手动测试

```bash
cd /www/wwwroot/23.248.226.82
bash run_matching.sh
```

应该看到类似输出：
```
================================================================================
[2026-01-14 21:XX:XX] 🤖 开始处理撮合池撮合（轮盘赌机制）- 自动运行
================================================================================
...
✓ 撮合任务完成 - 自动运行
```

### 2. 查看定时任务日志

```bash
tail -f /tmp/collection_matching.log
```

### 3. 等待下一次自动执行

如果配置为每分钟执行一次，等待1-2分钟后查看日志：
```bash
tail -20 /tmp/collection_matching.log
```

应该看到新的执行记录，不再出现 "Could not open input file: think" 错误。

## 📊 时间线对比

### 修复前（错误）
```
21:10:14 - Could not open input file: think ❌
21:10:43 - Could not open input file: think ❌
21:10:47 - Could not open input file: think ❌
21:13:04 - Could not open input file: think ❌
21:18:10 - Could not open input file: think ❌
```

### 修复后（正确）
```
21:XX:XX - 🤖 开始处理撮合池撮合 ✅
21:XX:XX - 【盲盒预约撮合结果】总预约: X | 中签: Y ✅
21:XX:XX - ✓ 撮合任务完成 ✅
```

## 🎯 总结

**问题原因**：
- 定时任务配置使用了 `php think collection:matching` 命令
- 项目使用 ThinkPHP 6+，没有 `think` 命令行工具文件
- 需要使用完整的 PHP 命令或包装脚本

**解决方案**：
- 使用 `bash run_matching.sh` 包装脚本（推荐）
- 或使用完整的 PHP 命令调用

**验证成功标志**：
- 日志中不再出现 "Could not open input file: think"
- 看到正常的撮合执行日志
- 盲盒预约正常处理

---

**修复完成后，请通知我，我会帮你验证配置是否正确！**
