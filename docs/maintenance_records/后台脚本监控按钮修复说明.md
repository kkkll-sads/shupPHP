# 后台脚本监控按钮修复说明

## 问题描述

用户反馈："理财管理 > 脚本监控"页面中的撮合脚本启动按钮点击后无法正常执行。

## 问题原因

本项目使用 **ThinkPHP 6+**，该版本不支持直接使用 `php think <command>` 命令。

### 技术背景

- ThinkPHP 5.x：支持 `php think <command>`
- ThinkPHP 6.x+：需要使用 PHP 代码启动 Console 应用

### 错误表现

当后台点击"立即运行"或"强制撮合"按钮时，系统执行的命令为：
```bash
php think collection:matching
```

这会导致错误：
```
Could not open input file: think
```

## 解决方案

### 修改配置文件：`config/terminal.php`

将所有自定义命令的执行方式从 `php think <command>` 改为：
```bash
php -r "require 'vendor/autoload.php'; \$app = new think\App(); \$app->console->run();" <command>
```

### 具体修改内容

#### 1. 理财自动化脚本（finance）
```php
'finance' => [
    'daily'  => [
        'cwd'     => '',
        'command' => 'php -r "require \'vendor/autoload.php\'; \$app = new think\App(); \$app->console->run();" finance:income:daily',
        'notes'   => '执行每日返息脚本',
    ],
    // ... 其他理财命令
],
```

#### 2. 寄售自动化脚本（consignment）
```php
'consignment' => [
    'expire' => [
        'cwd'     => '',
        'command' => 'php -r "require \'vendor/autoload.php\'; \$app = new think\App(); \$app->console->run();" consignment:expire',
        'notes'   => '执行寄售过期流拍脚本',
    ],
],
```

#### 3. 藏品矿机自动化脚本（collection）
```php
'collection' => [
    'mining' => [
        'check'    => [
            'cwd'     => '',
            'command' => 'php -r "require \'vendor/autoload.php\'; \$app = new think\App(); \$app->console->run();" collection:mining:check',
            'notes'   => '执行藏品强制锁仓检查脚本',
        ],
        'dividend' => [
            'cwd'     => '',
            'command' => 'php -r "require \'vendor/autoload.php\'; \$app = new think\App(); \$app->console->run();" collection:mining:dividend',
            'notes'   => '执行矿机每日分红脚本',
        ],
    ],
    'matching' => [
        'cwd'     => '',
        'command' => 'php -r "require \'vendor/autoload.php\'; \$app = new think\App(); \$app->console->run();" collection:matching',
        'notes'   => '执行藏品撮合池自动撮合脚本',
    ],
    'daily_dividend' => [
        'cwd'     => '',
        'command' => 'php -r "require \'vendor/autoload.php\'; \$app = new think\App(); \$app->console->run();" collection:daily:dividend',
        'notes'   => '执行每日分红结算并处理次日自动上架',
    ],
],
```

## 验证修复

修复后，执行以下命令验证：
```bash
cd /www/wwwroot/23.248.226.82
php -r "require 'vendor/autoload.php'; \$app = new think\App(); \$app->console->run();" collection:matching
```

预期输出：
```
================================================================================
[2026-01-14 21:27:32] 🤖 开始处理撮合池撮合（轮盘赌机制）- 自动运行
================================================================================
...
[2026-01-14 21:27:32] 🤖 撮合任务完成 - 自动运行
================================================================================
```

## 后台操作说明

### 访问路径
后台管理 → 理财管理 → 脚本监控

### 按钮功能

1. **立即运行**：执行一次撮合任务（遵守场次时间检查）
2. **强制撮合**：强制执行撮合任务（忽略场次时间检查）
3. **停止运行**：终止正在运行的脚本
4. **查看日志**：查看脚本执行日志
5. **刷新状态**：刷新脚本运行状态

### 日志文件位置
```
/tmp/collection_matching.log
```

## 相关文件

- `config/terminal.php` - 终端命令配置文件
- `app/admin/controller/finance/ScriptMonitor.php` - 后台脚本监控控制器
- `web/src/views/backend/finance/scriptMonitor/index.vue` - 前端脚本监控页面
- `app/command/CollectionMatching.php` - 撮合命令实现
- `run_matching.sh` - 撮合命令包装脚本（用于定时任务）

## 注意事项

1. **定时任务不受影响**：宝塔面板的定时任务使用 `run_matching.sh` 包装脚本，该脚本已经使用正确的执行方式，不受此问题影响。

2. **所有脚本已修复**：此次修复不仅包括撮合脚本，还包括所有理财、寄售、矿机、分红等自定义脚本。

3. **后台按钮已恢复正常**：修复后，后台"脚本监控"页面的所有按钮均可正常使用。

## 修复时间
2026-01-14 21:27

## 问题溯源

此问题的根本原因是：项目从 ThinkPHP 5.x 升级到 6.x 后，旧的命令执行方式 `php think` 不再有效，但 `config/terminal.php` 配置文件中的命令格式未及时更新。

宝塔定时任务使用的是 `run_matching.sh` 包装脚本，该脚本使用了正确的 PHP 代码启动方式，因此定时任务一直正常运行。但后台按钮直接读取 `config/terminal.php` 配置，导致按钮失效。
