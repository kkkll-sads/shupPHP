# 日志写入权限问题说明

## 问题症状
```
error_log(/www/wwwroot/23.248.226.82/runtime/log/202601/15.log): Failed to open stream: Permission denied
```

## 问题原因

### 1. 根本原因
日志文件被 **root 用户创建**，但 PHP 进程以 **www 用户**运行，导致无法写入。

### 2. 可能的触发场景
1. ❌ 以 root 身份运行 PHP 脚本：
   ```bash
   php think collection:mining:dividend  # root 执行
   ```

2. ❌ 以 root 身份运行定时任务：
   ```bash
   # crontab -e (root 用户)
   0 2 * * * cd /www/wwwroot/23.248.226.82 && php think xxx
   ```

3. ❌ sudo 执行脚本：
   ```bash
   sudo php xxx.php
   ```

### 3. 正确做法
1. ✅ 以 www 用户身份运行：
   ```bash
   su - www -s /bin/bash -c "cd /www/wwwroot/23.248.226.82 && php think collection:mining:dividend"
   ```

2. ✅ 使用 www 用户的定时任务：
   ```bash
   crontab -u www -e
   ```

3. ✅ 通过后台管理页面的"脚本监控"运行（自动使用正确权限）

## 快速修复

### 方法1：运行修复脚本
```bash
cd /www/wwwroot/23.248.226.82
bash scripts/fix_runtime_permissions.sh
```

### 方法2：手动修复
```bash
cd /www/wwwroot/23.248.226.82
chown -R www:www runtime/
chmod -R 755 runtime/
find runtime/ -type f -name "*.log" -exec chmod 644 {} \;
```

## 预防措施

### 1. 检查文件所有者
```bash
ls -la runtime/log/202601/
```

正确的输出：
```
-rw-r--r-- 1 www www 1546 Jan 15 11:47 15.log  ✓
```

错误的输出：
```
-rw-r--r-- 1 root root 1546 Jan 15 11:47 15.log  ✗
```

### 2. 定期检查权限
将以下脚本加入 www 用户的定时任务：
```bash
# 每天检查并修复权限
0 1 * * * /www/wwwroot/23.248.226.82/scripts/fix_runtime_permissions.sh
```

### 3. 避免以 root 身份运行 PHP
- 不要用 root 运行 `php think` 命令
- 不要用 root 的 crontab 运行 PHP 脚本
- 不要用 `sudo` 运行 PHP 脚本

## 影响范围
- **日志文件**: 无法写入错误日志、调试日志
- **缓存文件**: 可能无法写入缓存
- **临时文件**: 可能无法创建临时文件
- **业务功能**: 盲盒撮合、矿机分红等功能失败

## 解决时间
立即执行修复脚本后，问题会立即解决。

## 本次修复记录
- **日期**: 2026-01-15
- **问题**: `15.log` 被 root 创建，www 用户无法写入
- **修复**: `chown -R www:www runtime/log/`
- **验证**: ✅ 日志写入测试成功
