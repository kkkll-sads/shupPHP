# 菜单结构调整说明

## 变更内容

在后台管理侧边栏新增"藏品管理"菜单，并将原来在"商城管理"下的藏品相关页面移动到新菜单下。

---

## 一、变更前结构

```
商城管理 (menu_dir)
├── 资产包管理
├── 藏品商品管理
├── 藏品订单管理
├── 用户藏品管理
├── 场次管理
├── 盲盒预约管理
├── 撮合池订单管理
├── 商城订单管理
└── 商城商品管理
```

---

## 二、变更后结构

```
商城管理 (menu_dir)
├── 商城订单管理
└── 商城商品管理

藏品管理 (menu_dir) [新增]
├── 资产包管理
├── 藏品商品管理
├── 藏品订单管理
├── 用户藏品管理
├── 场次管理
├── 盲盒预约管理
├── 时间区间配置 [从商城管理移动]
├── 价格分区配置 [从商城管理移动]
└── 撮合池订单管理 [已禁用，不再使用]
```

---

## 三、执行步骤

### 1. 执行 SQL 脚本

```bash
mysql -u root -p ba < database/create_collection_menu_and_move.sql
```

或直接在数据库中执行 `database/create_collection_menu_and_move.sql` 文件。

### 2. 验证结果

执行 SQL 后，脚本会自动显示：
- 新创建的"藏品管理"菜单目录ID
- 移动到新菜单下的所有菜单项
- 商城管理下剩余的菜单项

### 3. 清除缓存（如需要）

如果菜单没有立即更新，可以：
- 刷新浏览器页面
- 清除浏览器缓存
- 重新登录后台

---

## 四、移动的菜单项

以下菜单项将从"商城管理"移动到"藏品管理"：

| 菜单名称 | 菜单标识 (name) | 说明 |
|---------|----------------|------|
| 资产包管理 | `collection/assetPackage` | 资产包配置管理 |
| 藏品商品管理 | `collection/item` | 藏品商品列表和管理 |
| 藏品订单管理 | `collection/order` | 藏品订单列表和管理 |
| 用户藏品管理 | `collection/userCollection` | 用户持有的藏品管理 |
| 场次管理 | `collection/session` | 交易场次配置 |
| 盲盒预约管理 | `collection/tradeReservation` | 盲盒预约记录管理 |
| 时间区间配置 | `config/tradingTimeConfig` | 交易时间区间配置 |
| 价格分区配置 | `config/priceZoneConfig` | 价格分区配置 |
| 撮合池订单管理 | `collection/matchingPool` | 撮合池订单管理（已禁用） |

**注意**：所有相关的按钮权限（button类型）也会自动移动。

---

## 五、保留在商城管理的菜单

以下菜单项保留在"商城管理"下：

| 菜单名称 | 菜单标识 (name) | 说明 |
|---------|----------------|------|
| 商城订单管理 | `shop/order` | 商城订单列表和管理 |
| 商城商品管理 | `shop/product` | 商城商品列表和管理 |

---

## 六、SQL 脚本说明

### 脚本位置
- `database/create_collection_menu_and_move.sql` - 初始菜单创建和移动
- `database/update_collection_menu.sql` - 后续更新（移动时间区间、价格分区，禁用撮合池）

### 脚本功能
1. **自动查找商城管理菜单**：通过 `title = '商城管理'` 或 `name LIKE '%shop%'` 查找
2. **创建藏品管理菜单目录**：如果不存在则创建，如果已存在则使用现有ID
3. **移动藏品相关菜单**：根据 `name` 和 `title` 匹配，将藏品相关菜单移动到新菜单下
4. **移动配置菜单**：将时间区间配置和价格分区配置移动到藏品管理
5. **禁用废弃菜单**：禁用撮合池订单管理菜单（已不使用）
6. **显示移动结果**：执行后显示移动的菜单项和剩余菜单项

### 安全性
- 使用 `WHERE` 条件精确匹配，避免误移动
- 排除 `shop/` 开头的菜单，确保商城相关菜单不被移动
- 只移动 `menu` 和 `button` 类型的菜单项

---

## 七、注意事项

1. **执行前备份**：建议先备份 `ba_admin_rule` 表
   ```sql
   CREATE TABLE ba_admin_rule_backup AS SELECT * FROM ba_admin_rule;
   ```

2. **菜单ID可能不同**：如果系统中商城管理的菜单ID不是161，脚本会自动查找

3. **权限检查**：移动后，需要检查管理员权限是否正常，确保有权限访问新菜单

4. **路由不变**：菜单移动不影响前端路由，页面路径保持不变

---

## 八、回滚方案

如果执行后需要回滚，可以执行以下SQL：

```sql
-- 查找藏品管理菜单ID
SET @collection_menu_id = (SELECT id FROM ba_admin_rule WHERE title = '藏品管理' AND type = 'menu_dir' LIMIT 1);
SET @shop_menu_id = (SELECT id FROM ba_admin_rule WHERE title = '商城管理' AND type = 'menu_dir' LIMIT 1);

-- 将藏品相关菜单移回商城管理
UPDATE ba_admin_rule 
SET pid = @shop_menu_id,
    update_time = UNIX_TIMESTAMP()
WHERE pid = @collection_menu_id
  AND name LIKE 'collection/%';

-- 删除藏品管理菜单目录（可选）
-- DELETE FROM ba_admin_rule WHERE id = @collection_menu_id;
```

---

## 九、相关文件

- **SQL脚本**：`database/create_collection_menu_and_move.sql`
- **菜单模型**：`app/admin/model/AdminRule.php`
- **菜单控制器**：`app/admin/controller/auth/Rule.php`
- **前端路由**：`web/src/router/static/adminBase.ts`

---

## 十、完成检查清单

- [ ] 执行 SQL 脚本
- [ ] 验证"藏品管理"菜单已创建
- [ ] 验证藏品相关菜单已移动到新菜单下
- [ ] 验证商城管理下只保留商城相关菜单
- [ ] 测试菜单访问权限
- [ ] 清除缓存并刷新页面
- [ ] 验证所有功能正常

---

**执行时间**：2026-01-02  
**影响范围**：后台管理菜单结构  
**风险等级**：低（仅调整菜单结构，不影响功能）

