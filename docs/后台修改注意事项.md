# 后台管理系统修改注意事项

## 概述
本项目基于 ThinkPHP 8 + Vue 3 + Element Plus 构建，包含前后端分离的管理后台。

---

## 数据库注意事项

### 1. 表名规范
- 所有表使用 `ba_` 前缀
- 查询时使用 `Db::name('表名')` 会自动添加前缀
- **常见表名（需注意复数形式）：**

| 功能 | 实际表名 |
|------|----------|
| 预约记录 | `ba_trade_reservations` (复数) |
| 寄售记录 | `ba_collection_consignment` |
| 用户藏品 | `ba_user_collection` |
| 专场 | `ba_collection_session` |
| 价格分区 | `ba_price_zone_config` |
| 藏品 | `ba_collection_item` |

### 2. 检查表名
```bash
mysql -h 10.10.100.3 -u waibao -pweHPjtkrbAPSMCNm waibao -e "SHOW TABLES LIKE '%关键词%'"
```

---

## 前端修改注意事项

### 1. 表格筛选器配置

**正确配置下拉选择筛选器：**
```typescript
{
    label: '状态',
    prop: 'status',
    operator: '=',                    // 必须使用 '=' 而非 'select'
    comSearchRender: 'select',        // 渲染为下拉框
    comSearchOptions: [               // 选项列表
        { label: '全部', value: '' },
        { label: '选项1', value: 1 },
    ],
    render: 'tag',
    replaceValue: { 1: '选项1' },
}
```

**❌ 错误示例：**
```typescript
operator: 'select' as any,    // 后端不识别 'select'
operatorOptions: [...]        // 无效属性
```

### 2. 支持的 operator 类型
| operator | 说明 |
|----------|------|
| `=` | 等于 |
| `LIKE` | 模糊匹配 |
| `RANGE` | 范围查询 |
| `BETWEEN` | 区间查询 |
| `IN` | 多值匹配 |
| `false` | 禁用搜索 |

### 3. 构建和部署
```bash
cd web && npm run build   # 构建前端
./deploy-frontend.sh      # 部署到生产目录
```

---

## 后端修改注意事项

### 1. 控制器继承
所有管理后台控制器继承 `app\common\controller\Backend`

### 2. 添加统计接口
```php
public function stats(): void
{
    $stats = [];
    // 使用正确的表名
    $stats['total'] = Db::name('正确的表名')->count();
    $this->success('', ['stats' => $stats]);
}
```

### 3. 清除缓存
修改后端代码后建议清除缓存：
```bash
rm -rf runtime/cache/*
```

### 4. 接收前端 POST 数据

**❌ 错误方式（方法参数绑定不适用于 POST body）：**
```php
public function cancel($ids = []): void  // 无法接收 POST 中的 ids
```

**✅ 正确方式：**
```php
public function cancel(): void
{
    $ids = $this->request->param('ids/a', []);  // 接收数组类型
    $id = $this->request->param('id/d', 0);     // 接收整数类型
}
```

**参数类型后缀：**
| 后缀 | 类型 |
|------|------|
| `/s` | 字符串 |
| `/d` | 整数 |
| `/a` | 数组 |
| `/f` | 浮点数 |
| `/b` | 布尔值 |

---

## 常见问题

### 1. 500 错误
- 检查表名是否正确（注意复数形式）
- 查看日志：`tail -50 runtime/log/$(date +%Y%m)/$(date +%d).log`

### 2. 筛选不生效
- 检查 operator 是否使用有效值（'='、'LIKE' 等）
- 确认使用 `comSearchRender` 和 `comSearchOptions`

### 3. 统计数据不显示
- 确认调用了 `fetchStats()` 方法
- 检查 API 响应结构是否匹配

### 4. "参数错误" 提示
- 检查后端是否使用 `$this->request->param()` 接收参数
- 方法参数绑定仅适用于 URL 参数，不适用于 POST body

### 5. 新增接口返回401/无权限
**原因：** Backend 对每个方法做权限检查

**解决：** 在控制器中添加 noNeedPermission：
```php
class YourController extends Backend
{
    // 无需鉴权的方法（仍需登录，只是跳过细粒度权限检查）
    protected array $noNeedPermission = ['stats', 'globalStats'];
}
```

### 6. try-catch 捕获导致接口异常

**问题：** ThinkPHP 的 `$this->success()` 通过抛出 `HttpResponseException` 返回响应，若被 `catch(Throwable)` 捕获会导致接口异常。

**✅ 正确写法：**
```php
try {
    // 业务逻辑...
    $this->success('', ['data' => $result]);
} catch (\think\exception\HttpResponseException $e) {
    throw $e; // 必须重新抛出！
} catch (Throwable $e) {
    $this->error('失败: ' . $e->getMessage());
}
```

### 7. 可选模块错误隔离

复杂统计中某个子查询失败不应影响整体，使用嵌套 try-catch：
```php
$stats['sessions'] = [];
try {
    $stats['sessions'] = Db::name('xxx')->select()->toArray();
} catch (\Throwable $e) {
    Log::warning('专场统计跳过: ' . $e->getMessage());
}
```

