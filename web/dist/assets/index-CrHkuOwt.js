import{y as _,u as g,c as d,f as x,j as i,S as D,r as C}from"./index-DNBbsmjl.js";import{a as v,z as y}from"./vue-_nkvHh4F.js";import{u}from"./index-BDXvJVtn.js";import{u as w,t as M}from"./terminal-tb2obPtt.js";const e=v({loading:{buy:!1,table:!0,common:!1,install:!1,goodsInfo:!1},dialog:{buy:!1,pay:!1,common:!1,goodsInfo:!1,baAccount:!1},table:{remark:"",modules:[],modulesEbak:[],category:[],onlyLocal:!1,indexLoaded:!1,params:{quickSearch:"",activeTab:"all"}},payInfo:{},goodsInfo:{},buy:{info:{},renew:!1,agreement:!0},common:{uid:"",moduleState:0,quickClose:!1,type:"loading",dialogTitle:"",fileConflict:[],dependConflict:[],loadingTitle:"init",loadingComponentKey:_(),waitInstallDepend:[],dependInstallState:"none",disableConflictFile:[],disableDependConflict:[],disableParams:{},payType:"wx",update:!1,versions:[]},sysVersion:"",nuxtVersion:"",installedModule:[],installedModuleUids:[],installedModuleVersions:[]});var s=(o=>(o[o.UNINSTALLED=0]="UNINSTALLED",o[o.INSTALLED=1]="INSTALLED",o[o.WAIT_INSTALL=2]="WAIT_INSTALL",o[o.CONFLICT_PENDING=3]="CONFLICT_PENDING",o[o.DEPENDENT_WAIT_INSTALL=4]="DEPENDENT_WAIT_INSTALL",o[o.DIRECTORY_OCCUPIED=5]="DIRECTORY_OCCUPIED",o[o.DISABLE=6]="DISABLE",o))(s||{});const h="/api/v7.store/",r="/admin/module/";function P(o={}){return d({url:r+"index",method:"get",params:o})}function U(o={}){const a=g();return d({url:a.apiUrl+h+"modules",method:"get",params:o})}function V(o){const a=u(),n=g();return d({url:n.apiUrl+h+"info",method:"get",params:o},{anotherToken:a.getToken("auth")})}function O(o={}){const a=u(),n=g();return d({url:n.apiUrl+h+"order",method:"post",params:o},{anotherToken:a.getToken("auth")})}function B(o,a){const n=u(),t=g();return d({url:t.apiUrl+h+"pay",method:"post",params:{order_id:o,pay_type:a}},{anotherToken:n.getToken("auth"),showSuccessMessage:!0})}function F(o){const a=u(),n=g();return d({url:n.apiUrl+"/api/pay/check",method:"get",params:{sn:o}},{anotherToken:a.getToken("auth"),showCodeMessage:!1})}function R(o){const a=u(),n=g();return d({url:n.apiUrl+h+"preDownload",method:"POST",data:o},{anotherToken:a.getToken("auth")})}function W(o){return d({url:r+"state",method:"get",params:{uid:o}})}function z(o,a,n,t,c={}){const l=u();return d({url:r+"install",method:"POST",data:{uid:o,update:t,version:n,orderId:a,token:l.getToken("auth"),extend:c},timeout:3e3*10},{showCodeMessage:!1})}function J(o){return d({url:r+"uninstall",method:"post",params:{uid:o}},{showSuccessMessage:!0})}function k(o){return d({url:r+"changeState",method:"post",data:o},{showCodeMessage:!1})}function Q(o){return d({url:r+"dependentInstallComplete",method:"post",params:{uid:o}})}function $(o){const a=u();return d({url:r+"upload",method:"post",params:{file:o,token:a.getToken("auth")}})}const q=()=>{e.loading.table=!0,e.table.indexLoaded?S():Y().then(()=>{S()})},f=()=>{e.table.indexLoaded=!1;for(const o in e.table.modulesEbak)e.table.modulesEbak[o]=void 0;q()},Y=()=>P().then(o=>{e.table.indexLoaded=!0,e.sysVersion=o.data.sysVersion,e.nuxtVersion=o.data.nuxtVersion,e.installedModule=o.data.installed;const a=[],n=[];o.data.installed&&(e.installedModule.forEach(t=>{a.push(t.uid),n.push({uid:t.uid,version:t.version})}),e.installedModuleUids=a,e.installedModuleVersions=n)}),S=()=>{if(typeof e.table.modulesEbak[e.table.params.activeTab]<"u"){e.table.modules[e.table.params.activeTab]=A(e.table.modulesEbak[e.table.params.activeTab]),e.loading.table=!1;return}const o={};for(const n in e.table.params)e.table.params[n]!=""&&(o[n]=e.table.params[n]);const a=[];o.installed=e.installedModuleVersions,o.sysVersion=e.sysVersion,U(o).then(n=>{o.activeTab=="all"&&(n.data.rows.forEach(t=>{a.push(t.uid)}),e.installedModule.forEach(t=>{a.indexOf(t.uid)===-1&&(e.table.params.quickSearch?t.title.includes(e.table.params.quickSearch)&&n.data.rows.push(t):n.data.rows.push(t))})),e.table.remark=n.data.remark,e.table.modulesEbak[o.activeTab]=n.data.rows.map(t=>{const c=e.installedModuleUids.indexOf(t.uid);return c!==-1?(t.state=e.installedModule[c].state,t.version=e.installedModule[c].version,t.website=e.installedModule[c].website,t.stateTag=j(t.state)):t.state=0,t.new_version&&t.tags&&t.tags.push({name:i.global.t("module.New version"),type:"danger"}),t}),e.table.modules[o.activeTab]=A(e.table.modulesEbak[o.activeTab]),e.table.category=n.data.category}).finally(()=>{e.loading.table=!1})},E=o=>{e.dialog.goodsInfo=!0,e.loading.goodsInfo=!0;const a=e.installedModule.find(n=>n.uid==o);V({uid:o,localVersion:a==null?void 0:a.version,sysVersion:e.sysVersion}).then(n=>{a?(n.data.info.type=="local"?(n.data.info=a,n.data.info.images=[x("/static/images/local-module-logo.png")],n.data.info.type="local"):(n.data.info.type="online",n.data.info.state=a.state,n.data.info.version=a.version),n.data.info.enable=a.state!==s.DISABLE):(n.data.info.state=0,n.data.info.type="online"),e.goodsInfo=n.data.info}).catch(n=>{I(n)&&(e.dialog.goodsInfo=!1)}).finally(()=>{e.loading.goodsInfo=!1})},ee=(o=!1)=>{e.dialog.buy=!0,e.loading.buy=!0,O({goods_id:e.goodsInfo.id}).then(a=>{e.loading.buy=!1,e.buy.renew=o,e.buy.info=a.data.info}).catch(a=>{e.dialog.buy=!1,e.loading.buy=!1,I(a)})},oe=o=>{e.common.payType=o,e.loading.common=!0,B(e.buy.info.id,o).then(a=>{if(e.dialog.buy=!1,e.dialog.goodsInfo=!1,o=="wx"||o=="zfb"){e.dialog.pay=!0,e.payInfo=a.data;const n=setInterval(()=>{F(e.payInfo.info.sn).then(()=>{e.payInfo.pay.status="success",clearInterval(n),e.buy.renew?E(a.data.info.uid):L(a.data.info.uid,a.data.info.id,!0),e.dialog.pay=!1}).catch(()=>{})},3e3)}else e.buy.renew?E(a.data.info.uid):L(a.data.info.uid,a.data.info.id,!0)}).catch(a=>{I(a)}).finally(()=>{e.loading.common=!1})},T=o=>{e.common.type="loading",e.common.loadingTitle=o,e.common.loadingComponentKey=_()},L=(o,a,n,t=!1)=>{e.dialog.common=!0,T("init"),e.common.dialogTitle=i.global.t("module.Install");const c=l=>{n?(T("getInstallableVersion"),R({uid:o,orderId:a,sysVersion:e.sysVersion,nuxtVersion:e.nuxtVersion,installed:e.installedModuleUids}).then(m=>{e.common.uid=o,e.common.update=t,e.common.type="selectVersion",e.common.dialogTitle=i.global.t("module.Select Version"),e.common.versions=m.data.versions,e.dialog.baAccount=!1,e.dialog.buy=!1,e.dialog.goodsInfo=!1}).catch(m=>{I(m)||(e.dialog.common=!1)})):(T(l===s.UNINSTALLED?"download":"install"),N(o,a,"",t),e.dialog.baAccount=!1,e.dialog.buy=!1,e.dialog.goodsInfo=!1)};t?c(s.DISABLE):W(o).then(l=>{if(l.data.state===s.INSTALLED||l.data.state===s.DISABLE||l.data.state===s.DIRECTORY_OCCUPIED){y({type:"error",message:l.data.state===s.INSTALLED||l.data.state===s.DISABLE?i.global.t("module.Installation cancelled because module already exists!"):i.global.t("module.Installation cancelled because the directory required by the module is occupied!")}),e.dialog.common=!1;return}c(l.data.state)})},N=(o,a,n="",t=!1,c={})=>{z(o,a,n,t,c).then(()=>{e.common.dialogTitle=i.global.t("module.Installation complete"),e.common.moduleState=s.INSTALLED,e.common.type="done",f()}).catch(l=>{if(!I(l))if(l.code==-1)e.common.uid=l.data.uid,e.common.type="installConflict",e.common.dialogTitle=i.global.t("module.A conflict is found Please handle it manually"),e.common.fileConflict=l.data.fileConflict,e.common.dependConflict=l.data.dependConflict;else if(l.code==-2){e.common.type="done",e.common.uid=l.data.uid,e.common.dialogTitle=i.global.t("module.Wait for dependent installation"),e.common.moduleState=s.DEPENDENT_WAIT_INSTALL,e.common.waitInstallDepend=l.data.wait_install,e.common.dependInstallState="executing";const m=w();l.data.wait_install.includes("npm_dependent_wait_install")&&m.addTaskPM("web-install",!0,"module-install:"+l.data.uid,p=>{b(p,"npm_dependent_wait_install")}),l.data.wait_install.includes("nuxt_npm_dependent_wait_install")&&m.addTaskPM("nuxt-install",!0,"module-install:"+l.data.uid,p=>{b(p,"nuxt_npm_dependent_wait_install")}),l.data.wait_install.includes("composer_dependent_wait_install")&&m.addTask("composer.update",!0,"module-install:"+l.data.uid,p=>{b(p,"composer_dependent_wait_install")})}else l.code==0&&(y({type:"error",message:l.msg,zIndex:D}),e.dialog.common=!1,f())}).finally(()=>{e.loading.common=!1})},b=(o,a)=>{o==M.Success?(e.common.waitInstallDepend=e.common.waitInstallDepend.filter(n=>n!=a),e.common.waitInstallDepend.length==0&&(e.common.dependInstallState="success",C.currentRoute.value.name==="moduleStore/moduleStore"&&f())):(w().toggle(!0),e.common.dependInstallState="fail",C.currentRoute.value.name==="moduleStore/moduleStore"&&f()),C.currentRoute.value.name},ae=(o=!1)=>{if(e.loading.common=!0,o){const a={};for(const n in e.common.disableDependConflict)e.common.disableDependConflict[n].solution=="delete"&&(typeof a[e.common.disableDependConflict[n].env]>"u"&&(a[e.common.disableDependConflict[n].env]=[]),a[e.common.disableDependConflict[n].env].push(e.common.disableDependConflict[n].depend));e.common.disableParams.confirmConflict=1,e.common.disableParams.dependConflictSolution=a}k(e.common.disableParams).then(()=>{y({type:"success",message:i.global.t("module.The operation succeeds Please clear the system cache and refresh the browser ~"),zIndex:D}),e.dialog.common=!1,f()}).catch(a=>{if(a.code==-1){if(e.dialog.common=!0,e.common.dialogTitle=i.global.t("module.Deal with conflict"),e.common.type="disableConfirmConflict",e.common.disableDependConflict=a.data.dependConflict,a.data.conflictFile&&a.data.conflictFile.length){const n=[];for(const t in a.data.conflictFile)n.push({file:a.data.conflictFile[t]});e.common.disableConflictFile=n}}else if(a.code==-2){e.dialog.common=!0;const n={commands:a.data.wait_install};e.common.uid=e.goodsInfo.uid,G(n)}else a.code==-3?L(e.goodsInfo.uid,e.goodsInfo.purchased,!0,!0):(y({type:"error",message:a.msg,zIndex:D}),e.common.disableParams&&e.common.disableParams.uid?E(e.common.disableParams.uid):f())}).finally(()=>{e.loading.common=!1})},ne=o=>{e.loading.common=!0,k({uid:o,state:1}).then(()=>{e.dialog.common=!0,T("init"),e.common.dialogTitle=i.global.t("Enable"),N(o,0),e.dialog.goodsInfo=!1}).catch(a=>{y({type:"error",message:a.msg,zIndex:D}),e.loading.common=!1})},I=o=>{const a=u();return o.code==301||o.code==408?(a.removeToken(),e.dialog.baAccount=!0,!0):!1},A=o=>e.table.onlyLocal?o.filter(a=>a.state>s.UNINSTALLED):o,G=o=>{{e.dialog.common=!0,e.common.type="done",e.common.dialogTitle=i.global.t("module.Wait for dependent installation"),e.common.moduleState=s.DISABLE,e.common.dependInstallState="executing";const a=w();o.commands.forEach(n=>{e.common.waitInstallDepend.push(n.type),n.pm?(n.command=="web-install",a.addTaskPM(n.command,!0,"",t=>{b(t,n.type),n.command=="web-install"})):a.addTask(n.command,!0,"",t=>{b(t,n.type)})})}},te=o=>o.nickname+"（"+(o.email||o.mobile||"ID:"+o.id)+"）",le=(o,a)=>typeof o>"u"||typeof a>"u"?"-":a==0?parseInt(o.toString())+i.global.t("Integral"):"￥"+o,j=o=>{switch(o){case s.INSTALLED:return{type:"",text:i.global.t("module.installed")};case s.WAIT_INSTALL:return{type:"success",text:i.global.t("module.Wait for installation")};case s.CONFLICT_PENDING:return{type:"danger",text:i.global.t("module.Conflict pending")};case s.DEPENDENT_WAIT_INSTALL:return{type:"warning",text:i.global.t("module.Dependency to be installed")};case s.DISABLE:return{type:"warning",text:i.global.t("Disable")};default:return{type:"info",text:i.global.t("Unknown")}}};export{te as a,L as b,le as c,Q as d,f as e,ee as f,T as g,N as h,ae as i,E as j,ne as k,W as l,s as m,q as n,oe as o,J as p,e as s,$ as u};
