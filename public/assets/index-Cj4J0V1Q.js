import{v as H,c as B,_ as O}from"./index-BR6nH71S.js";import{B as P,b as y,o as R,I as c,C as v,D as d,H as s,P as n,G as o,V as W,W as X,O as k,X as l,U as x,$ as i,u as w,aR as D,aS as q,aT as J,aK as Q,ai as M,a1 as u}from"./vue-DnSQgQf0.js";const Y={class:"default-main ba-table-box"},Z={class:"card-header"},ee={class:"script-name"},te={class:"script-info"},ae={class:"info-item"},ne={class:"value"},se={class:"info-item"},oe={class:"value"},le={class:"info-item"},ie={class:"value"},re={class:"info-item"},de={class:"value"},ue={key:0,class:"info-item"},ce={class:"value"},_e={key:1,class:"info-item"},fe={class:"script-actions"},me={key:0,class:"log-content"},ye={class:"log-info"},ge={class:"log-text"},pe=P({name:"finance/scriptMonitor",__name:"index",setup(ve){const{t:ke}=H.useI18n(),V=y([]),b=y({}),$=y({}),C=y(!1),g=y(null),f=y(null),E=t=>({normal:"success",warning:"warning",error:"danger",running:"warning"})[t]||"info",S=async()=>{try{const t=await B({url:"/admin/finance.ScriptMonitor/index",method:"get"});t.code===1&&(V.value=t.data.list||[])}catch(t){console.error("加载脚本列表失败:",t)}},T=async(t,e=!1)=>{try{await M.confirm(e?`确定强制执行 "${t.name}" 吗？（忽略场次时间检查）`:`确定要立即执行 "${t.name}" 脚本吗？`,e?"确认强制执行":"确认执行",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const _=e?`${t.key}_force`:t.key;b.value[_]=!0;const r=await B({url:"/admin/finance.ScriptMonitor/run",method:"post",data:{key:t.key,force:e?1:0}});r.code===1?(u.success("脚本执行成功"),r.data.output&&M.alert(r.data.output,"执行结果",{confirmButtonText:"确定",type:"success"}),await S()):u.error(r.msg||"执行失败")}catch(_){_!=="cancel"&&u.error(_.msg||"执行失败")}finally{const _=e?`${t.key}_force`:t.key;b.value[_]=!1}},I=async t=>{g.value=t,C.value=!0,await z()},z=async()=>{if(g.value)try{const t=await B({url:"/admin/finance.ScriptMonitor/log",method:"get",params:{key:g.value.key}});t.code===1?f.value=t.data:u.error(t.msg||"获取日志失败")}catch{u.error("获取日志失败")}},N=async t=>{try{await M.confirm(`确定要停止 "${t.name}" 脚本吗？`,"确认停止",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),$.value[t.key]=!0;const e=await B({url:"/admin/finance.ScriptMonitor/stop",method:"post",data:{key:t.key}});e.code===1?(u.success("脚本已停止"),await S()):u.error(e.msg||"停止失败")}catch(e){e!=="cancel"&&u.error(e.msg||"停止失败")}finally{$.value[t.key]=!1}},K=async()=>{u.info("正在刷新状态..."),await S(),u.success("状态已刷新")};return R(()=>{S()}),(t,e)=>{var L;const _=c("el-alert"),r=c("el-tag"),p=c("el-icon"),m=c("el-button"),U=c("el-card"),j=c("el-col"),A=c("el-row"),F=c("el-scrollbar"),G=c("el-dialog");return d(),v("div",Y,[s(_,{class:"ba-table-alert",title:"自动化脚本监控",type:"info","show-icon":""},{default:n(()=>e[2]||(e[2]=[o("div",null,"监控以下自动化脚本的运行状态，支持手动执行脚本",-1)])),_:1}),s(A,{gutter:20,class:"script-cards"},{default:n(()=>[(d(!0),v(W,null,X(V.value,a=>(d(),k(j,{span:12,key:a.key,style:{"margin-bottom":"20px"}},{default:n(()=>[s(U,{shadow:"hover",class:"script-card"},{header:n(()=>[o("div",Z,[o("span",ee,l(a.name),1),s(r,{type:E(a.status),size:"small"},{default:n(()=>[i(l(a.status_text),1)]),_:2},1032,["type"])])]),default:n(()=>[o("div",te,[o("div",ae,[e[3]||(e[3]=o("span",{class:"label"},"执行命令：",-1)),o("span",ne,l(a.command),1)]),o("div",se,[e[4]||(e[4]=o("span",{class:"label"},"定时计划：",-1)),o("span",oe,l(a.cron),1)]),o("div",le,[e[5]||(e[5]=o("span",{class:"label"},"说明：",-1)),o("span",ie,l(a.description),1)]),o("div",re,[e[6]||(e[6]=o("span",{class:"label"},"最后运行：",-1)),o("span",de,l(a.last_run_time_text),1)]),a.log_exists?(d(),v("div",ue,[e[7]||(e[7]=o("span",{class:"label"},"日志文件：",-1)),o("span",ce,l(a.log_file)+" ("+l(a.log_size_text)+")",1)])):(d(),v("div",_e,e[8]||(e[8]=[o("span",{class:"label"},"日志文件：",-1),o("span",{class:"value text-danger"},"文件不存在",-1)])))]),o("div",fe,[s(m,{type:"primary",onClick:h=>T(a),loading:b.value[a.key],disabled:a.status==="running"||a.is_running},{default:n(()=>[s(p,null,{default:n(()=>[s(w(D))]),_:1}),e[9]||(e[9]=i(" 立即运行 "))]),_:2},1032,["onClick","loading","disabled"]),a.key==="collection_matching"?(d(),k(m,{key:0,type:"warning",plain:"",onClick:h=>T(a,!0),loading:b.value[a.key+"_force"]},{default:n(()=>[s(p,null,{default:n(()=>[s(w(D))]),_:1}),e[10]||(e[10]=i(" 强制撮合 "))]),_:2},1032,["onClick","loading"])):x("",!0),a.status==="running"||a.is_running?(d(),k(m,{key:1,type:"danger",onClick:h=>N(a),loading:$.value[a.key]},{default:n(()=>[s(p,null,{default:n(()=>[s(w(q))]),_:1}),e[11]||(e[11]=i(" 停止运行 "))]),_:2},1032,["onClick","loading"])):x("",!0),a.log_exists?(d(),k(m,{key:2,type:"info",onClick:h=>I(a)},{default:n(()=>[s(p,null,{default:n(()=>[s(w(J))]),_:1}),e[12]||(e[12]=i(" 查看日志 "))]),_:2},1032,["onClick"])):x("",!0),s(m,{onClick:K},{default:n(()=>[s(p,null,{default:n(()=>[s(w(Q))]),_:1}),e[13]||(e[13]=i(" 刷新状态 "))]),_:1})])]),_:2},1024)]),_:2},1024))),128))]),_:1}),s(G,{modelValue:C.value,"onUpdate:modelValue":e[1]||(e[1]=a=>C.value=a),title:"查看日志 - "+((L=g.value)==null?void 0:L.name),width:"80%","destroy-on-close":""},{footer:n(()=>[s(m,{onClick:e[0]||(e[0]=a=>C.value=!1)},{default:n(()=>e[14]||(e[14]=[i("关闭")])),_:1}),g.value?(d(),k(m,{key:0,type:"primary",onClick:z},{default:n(()=>e[15]||(e[15]=[i("刷新日志")])),_:1})):x("",!0)]),default:n(()=>[f.value?(d(),v("div",me,[o("div",ye,[s(r,{size:"small"},{default:n(()=>[i("总行数："+l(f.value.total_lines),1)]),_:1}),s(r,{size:"small"},{default:n(()=>[i("显示行数："+l(f.value.show_lines),1)]),_:1}),s(r,{size:"small"},{default:n(()=>[i("文件大小："+l(f.value.file_size_text),1)]),_:1}),s(r,{size:"small"},{default:n(()=>[i("最后修改："+l(f.value.last_modified_text),1)]),_:1})]),s(F,{height:"500px",class:"log-scrollbar"},{default:n(()=>[o("pre",ge,l(f.value.content),1)]),_:1})])):x("",!0)]),_:1},8,["modelValue","title"])])}}}),be=O(pe,[["__scopeId","data-v-b51027d0"]]);export{be as default};
