import{B as re,am as se,b as v,l as ne,w as h,I as d,Z as A,O as g,D as u,P as r,_ as $,G as p,F as me,u as o,a0 as de,U as N,a9 as ue,H as i,C as x,V as q,W as F,$ as b,X as k}from"./vue-DnSQgQf0.js";import{v as pe,e as fe,a5 as z}from"./index-BR6nH71S.js";import{F as R}from"./index-Ch43UxRl.js";const ce={class:"title"},ge={style:{display:"flex",gap:"8px",width:"100%","align-items":"flex-start"}},_e={class:"dialog-footer"},ke=re({__name:"popupForm",setup(be){const t=se("baTable"),{t:y}=pe.useI18n(),P=fe(),w=v(),S=v([]),Z=v([]),f=v([]),V=v([]),j=new z("/admin/collection.Session/"),W=new z("/admin/collection.AssetPackage/"),G=new z("/admin/PriceZoneConfig/"),B=a=>{if(!f.value.length||!t.form.items)return;const e=Number(a);if(Number.isNaN(e))return;const n=f.value.find(m=>{const _=Number(m.min_price??0),c=Number(m.max_price??0);return c>0?e>=_&&e<=c:e>=_})??f.value[0];t.form.items.zone_id=(n==null?void 0:n.id)??0},D=()=>{var e;const a=new Uint8Array(16);if((e=window.crypto)!=null&&e.getRandomValues)window.crypto.getRandomValues(a);else for(let s=0;s<a.length;s++)a[s]=Math.floor(Math.random()*256);return"0x"+Array.from(a,s=>s.toString(16).padStart(2,"0")).join("")},K=()=>{t.form.items.fingerprint=D()},M=async()=>{var e;const a=await j.index({select:1,limit:999});a.code===1&&((e=a.data)!=null&&e.list)&&(S.value=a.data.list)},H=async()=>{var e;const a=await G.index({select:1,limit:999});a.code===1&&((e=a.data)!=null&&e.list)&&(f.value=a.data.list,t.form.items&&(t.form.items.price?B(t.form.items.price):!t.form.items.zone_id&&f.value.length>0&&(t.form.items.zone_id=f.value[0].id)))},L=async()=>{var e;const a=await W.index({select:1,limit:999});if(a.code===1&&((e=a.data)!=null&&e.list)){V.value=a.data.list.map(n=>({id:n.id,name:n.name,session_id:n.session_id}));const s=new Set;for(const n of a.data.list)n.name&&s.add(n.name);Z.value=Array.from(s).sort()}},X=ne(()=>{var e;const a=(e=t.form.items)==null?void 0:e.session_id;return a?V.value.filter(s=>s.session_id===a):V.value}),J=a=>{const e=V.value.find(s=>s.id===a);e&&t.form.items&&(t.form.items.package_name=e.name)};h(()=>t.form.operate,a=>{var e;["Add","Edit"].includes(a)&&(M(),H(),L(),a==="Add"&&!((e=t.form.items)!=null&&e.fingerprint)&&(t.form.items.fingerprint=D()),a==="Add"&&(t.form.items.quantity=1,t.form.items.stock||(t.form.items.stock=1)))},{immediate:!0}),h(()=>{var a;return(a=t.form.items)==null?void 0:a.price},a=>{B(a)}),h(()=>{var a;return(a=t.form.items)==null?void 0:a.session_id},(a,e)=>{if(a!==e&&t.form.items){const s=t.form.items.package_id;if(s){const n=V.value.find(m=>m.id===s);n&&n.session_id!==a&&(t.form.items.package_id=0,t.form.items.package_name="")}}});const Q={session_id:[{required:!0,message:"请选择专场",trigger:"change"}],package_id:[{required:!0,message:"请选择资产包",trigger:"change"}],zone_id:[{required:!0,message:"请选择价格分区",trigger:"change"}],title:[{required:!0,message:"藏品标题不能为空",trigger:"blur"}],price:[{required:!0,message:"价格不能为空",trigger:"change"}],stock:[{required:!0,message:"库存数量不能为空",trigger:"change"}],status:[{required:!0,message:"状态不能为空",trigger:"change"}]};return(a,e)=>{const s=d("el-option"),n=d("el-select"),m=d("el-form-item"),_=d("el-input"),c=d("el-input-number"),C=d("el-button"),I=d("el-radio"),Y=d("el-radio-group"),ee=d("el-form"),te=d("el-scrollbar"),oe=d("el-dialog"),le=A("drag"),ae=A("zoom"),ie=A("loading");return u(),g(oe,{class:"ba-operate-dialog","close-on-click-modal":!1,"destroy-on-close":!0,"model-value":["Add","Edit"].includes(o(t).form.operate),onClose:o(t).toggleForm},{header:r(()=>[$((u(),x("div",ce,[b(k(o(t).form.operate?o(y)(String(o(t).form.operate)):""),1)])),[[le,[".ba-operate-dialog",".el-dialog__header"]],[ae,".ba-operate-dialog"]])]),footer:r(()=>[p("div",_e,[i(C,{onClick:o(t).toggleForm},{default:r(()=>[b(k(o(y)("Cancel")),1)]),_:1},8,["onClick"]),i(C,{type:"primary",onClick:e[15]||(e[15]=U=>o(t).onSubmit(w.value))},{default:r(()=>[b(k(o(y)("Confirm")),1)]),_:1})])]),default:r(()=>[$((u(),g(te,{class:"ba-table-form-scrollbar"},{default:r(()=>{var U,O,T,E;return[p("div",{class:de(["ba-operate-form","ba-"+o(t).form.operate+"-form"]),style:me((O=(U=o(P))==null?void 0:U.layout)!=null&&O.shrink?"":"width: calc(100% - "+(o(t).form.labelWidth||160)/2+"px)")},[o(t).form.loading?N("",!0):(u(),g(ee,{key:0,ref_key:"formRef",ref:w,onKeyup:e[14]||(e[14]=ue(l=>o(t).onSubmit(w.value),["enter"])),model:o(t).form.items,"label-position":(E=(T=o(P))==null?void 0:T.layout)!=null&&E.shrink?"top":"right","label-width":(o(t).form.labelWidth||160)+"px",rules:Q},{default:r(()=>[i(m,{prop:"session_id",label:"专场"},{default:r(()=>[i(n,{modelValue:o(t).form.items.session_id,"onUpdate:modelValue":e[0]||(e[0]=l=>o(t).form.items.session_id=l),placeholder:"请选择专场",style:{width:"100%"}},{default:r(()=>[(u(!0),x(q,null,F(S.value,l=>(u(),g(s,{key:l.id,label:l.title+"（ID："+l.id+"）",value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),i(m,{prop:"package_id",label:"资产包"},{default:r(()=>[i(n,{modelValue:o(t).form.items.package_id,"onUpdate:modelValue":e[1]||(e[1]=l=>o(t).form.items.package_id=l),placeholder:"请选择资产包（撮合时按此归类）",filterable:"",style:{width:"100%"},onChange:J},{default:r(()=>[(u(!0),x(q,null,F(X.value,l=>(u(),g(s,{key:l.id,label:l.name+"（ID："+l.id+"）",value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),e[16]||(e[16]=p("span",{style:{"margin-left":"10px",color:"#999"}},"同资产包的藏品在同一撮合池",-1))]),_:1}),N("",!0),i(m,{prop:"zone_id",label:"价格分区"},{default:r(()=>[i(n,{modelValue:o(t).form.items.zone_id,"onUpdate:modelValue":e[3]||(e[3]=l=>o(t).form.items.zone_id=l),placeholder:"请选择价格分区",filterable:"",style:{width:"100%"}},{default:r(()=>[(u(!0),x(q,null,F(f.value,l=>(u(),g(s,{key:l.id,label:l.name+"（ID："+l.id+"）",value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),i(m,{prop:"title",label:"藏品标题"},{default:r(()=>[i(_,{modelValue:o(t).form.items.title,"onUpdate:modelValue":e[4]||(e[4]=l=>o(t).form.items.title=l),type:"string",placeholder:"请输入藏品标题"},null,8,["modelValue"])]),_:1}),i(R,{label:"藏品图片",type:"image",modelValue:o(t).form.items.image,"onUpdate:modelValue":e[5]||(e[5]=l=>o(t).form.items.image=l),prop:"image","input-attr":{returnFullUrl:!0,limit:1}},null,8,["modelValue"]),i(R,{label:"藏品详情图片",type:"image",modelValue:o(t).form.items.images,"onUpdate:modelValue":e[6]||(e[6]=l=>o(t).form.items.images=l),prop:"images","input-attr":{returnFullUrl:!0,limit:9}},null,8,["modelValue"]),i(m,{prop:"price",label:"价格"},{default:r(()=>[i(c,{modelValue:o(t).form.items.price,"onUpdate:modelValue":e[7]||(e[7]=l=>o(t).form.items.price=l),min:0,step:.01,precision:2,"controls-position":"right",placeholder:"请输入价格"},null,8,["modelValue"]),e[17]||(e[17]=p("span",{style:{"margin-left":"10px",color:"#999"}},"元",-1))]),_:1}),i(m,{prop:"asset_anchor",label:"资产锚定"},{default:r(()=>[i(_,{modelValue:o(t).form.items.asset_anchor,"onUpdate:modelValue":e[8]||(e[8]=l=>o(t).form.items.asset_anchor=l),type:"string",placeholder:"请输入资产锚定信息（如：古董、艺术品、茶等）"},null,8,["modelValue"])]),_:1}),i(m,{prop:"fingerprint",label:"存证指纹"},{default:r(()=>[p("div",ge,[i(_,{modelValue:o(t).form.items.fingerprint,"onUpdate:modelValue":e[9]||(e[9]=l=>o(t).form.items.fingerprint=l),type:"textarea",rows:2,placeholder:"请输入链上/存证指纹哈希（示例：0x****）","show-word-limit":"",maxlength:"255"},null,8,["modelValue"]),i(C,{type:"primary",plain:"",onClick:K},{default:r(()=>e[18]||(e[18]=[b("生成")])),_:1})]),e[19]||(e[19]=p("span",{style:{"margin-left":"10px",color:"#999"}},"保存链上哈希或第三方存证编号，未填写自动生成",-1))]),_:1}),i(m,{prop:"stock",label:"库存数量"},{default:r(()=>[i(c,{modelValue:o(t).form.items.stock,"onUpdate:modelValue":e[10]||(e[10]=l=>o(t).form.items.stock=l),min:0,max:99999,step:1,"controls-position":"right",placeholder:"请输入库存数量"},null,8,["modelValue"]),e[20]||(e[20]=p("span",{style:{"margin-left":"10px",color:"#999"}},"批量添加时会自动设置为1",-1))]),_:1}),i(m,{prop:"status",label:"状态"},{default:r(()=>[i(Y,{modelValue:o(t).form.items.status,"onUpdate:modelValue":e[11]||(e[11]=l=>o(t).form.items.status=l)},{default:r(()=>[i(I,{label:1},{default:r(()=>[b(k(o(y)("Enable")),1)]),_:1}),i(I,{label:0},{default:r(()=>[b(k(o(y)("Disable")),1)]),_:1})]),_:1},8,["modelValue"])]),_:1}),i(m,{prop:"sort",label:"排序"},{default:r(()=>[i(c,{modelValue:o(t).form.items.sort,"onUpdate:modelValue":e[12]||(e[12]=l=>o(t).form.items.sort=l),min:0,max:9999,"controls-position":"right",placeholder:"请输入排序值"},null,8,["modelValue"]),e[21]||(e[21]=p("span",{style:{"margin-left":"10px",color:"#999"}},"数值越大越靠前",-1))]),_:1}),o(t).form.operate==="Add"?(u(),g(m,{key:1,prop:"quantity",label:"添加数量"},{default:r(()=>[i(c,{modelValue:o(t).form.items.quantity,"onUpdate:modelValue":e[13]||(e[13]=l=>o(t).form.items.quantity=l),min:1,max:100,step:1,"controls-position":"right",placeholder:"批量添加数量"},null,8,["modelValue"]),e[22]||(e[22]=p("span",{style:{"margin-left":"10px",color:"#999"}},"每个藏品自动生成唯一编号和存证指纹",-1))]),_:1})):N("",!0)]),_:1},8,["model","label-position","label-width"]))],6)]}),_:1})),[[ie,o(t).form.loading]])]),_:1},8,["model-value","onClose"])}}});export{ke as _};
