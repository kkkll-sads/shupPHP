import{B as L,aa as j,a as O,o as H,aG as Q,aN as W,ad as X,I as p,Z,C as _,D as r,_ as J,O as f,U as y,P as d,H as m,a9 as b,a8 as v,V as C,W as U,G as D,u as g,p as Y,X as T,$ as A,z as ee,ai as te}from"./vue-DnSQgQf0.js";import{v as oe,u as ne,y as F,z as I,_ as ae}from"./index-BR6nH71S.js";import{_ as re,i as le,p as ie,d as se,a as ue}from"./add.vue_vue_type_script_setup_true_lang-DwT2ZLI9.js";import{F as $}from"./index-Ch43UxRl.js";import{r as de}from"./router-Op2AwQek.js";import{b as ce}from"./validate-B0Iw1M_R.js";import"./index-B5mnDXNW.js";import"./baTable-CpxZN4RR.js";import"./index-DGD6GkL-.js";const fe={class:"default-main"},pe={class:"config-form-item-name"},me={class:"del-config-form-item"},ge={key:0,class:"send-test-mail"},_e=["onClick"],ye=L({name:"routine/config",__name:"index",setup(be){const{t:s}=oe.useI18n(),B=ne(),E=j("formRef"),e=O({loading:!0,config:[],remark:"",configGroup:{},activeTab:"",showAddForm:!1,rules:{},form:{},quickEntrance:{},formKey:F()}),K=()=>{le().then(i=>{e.config=i.data.list,e.remark=i.data.remark,e.configGroup=i.data.configGroup,e.quickEntrance=i.data.quickEntrance,e.loading=!1;for(const n in e.configGroup){e.activeTab=n;break}let o={},a={};for(const n in e.config)for(const l in e.config[n].list){if(e.config[n].list[l].rule){let x=e.config[n].list[l].rule.split(","),V=[];x.forEach(h=>{V.push(ce({name:h,title:e.config[n].list[l].title}))}),a=Object.assign(a,{[e.config[n].list[l].name]:V})}o[e.config[n].list[l].name]=e.config[n].list[l].type=="number"?parseFloat(e.config[n].list[l].value):e.config[n].list[l].value}e.form=o,e.rules=a,e.formKey=F()}).catch(()=>{e.loading=!1})},G=i=>{if(i=="add_config")return e.showAddForm=!0,!1},k=()=>{var i;(i=E.value)==null||i.validate(o=>{if(o){const a={};for(const n in e.config)if(n==e.activeTab)for(const l in e.config[n].list)a[e.config[n].list[l].name]=e.form[e.config[n].list[l].name]??"";ie("edit",a).then(()=>{for(const n in B.$state)a[n]&&B.$state[n]!=a[n]&&(B.$state[n]=a[n]);a.backend_entrance&&a.backend_entrance!=I&&(window.open(window.location.href.replace(I,a.backend_entrance)),window.close())})}})},N=i=>{se([i.id]).then(()=>{K()})},P=()=>{if(!e.form.smtp_server||!e.form.smtp_port||!e.form.smtp_user||!e.form.smtp_pass||!e.form.smtp_sender_mail)return ee({type:"error",message:s("routine.config.Please enter the correct mail configuration")}),!1;te.prompt(s("routine.config.Please enter the recipient email address"),s("routine.config.Test mail sending"),{confirmButtonText:s("routine.config.send out"),cancelButtonText:s("Cancel"),inputPattern:/[\w!#$%&'*+/=?^_`{|}~-]+(?:\.[\w!#$%&'*+/=?^_`{|}~-]+)*@(?:[\w](?:[\w-]*[\w])?\.)+[\w](?:[\w-]*[\w])?/,inputErrorMessage:s("routine.config.Please enter the correct email address"),beforeClose:(i,o,a)=>{i==="confirm"?(o.confirmButtonLoading=!0,o.confirmButtonText=s("routine.config.Sending"),ue(e.form,o.inputValue).then(()=>{a()}).catch(()=>{a()})):a()}})};return H(()=>{K()}),Q(()=>{}),W(()=>{}),X(()=>{}),(i,o)=>{const a=p("Icon"),n=p("el-popconfirm"),l=p("el-button"),x=p("el-tab-pane"),V=p("el-tabs"),h=p("el-form"),S=p("el-col"),M=p("el-card"),q=p("el-row"),R=Z("loading");return r(),_("div",fe,[J((r(),f(q,{gutter:20},{default:d(()=>[m(S,{class:"xs-mb-20",xs:24,sm:16},{default:d(()=>[e.loading?y("",!0):(r(),f(h,{ref_key:"formRef",ref:E,onSubmit:o[7]||(o[7]=v(()=>{},["prevent"])),onKeyup:o[8]||(o[8]=b(u=>k(),["enter"])),model:e.form,rules:e.rules,"label-position":"top",key:e.formKey},{default:d(()=>[m(V,{modelValue:e.activeTab,"onUpdate:modelValue":o[6]||(o[6]=u=>e.activeTab=u),type:"border-card","before-leave":G},{default:d(()=>[(r(!0),_(C,null,U(e.config,(u,w)=>(r(),f(x,{class:"config-tab-pane",key:w,name:w,label:u.title},{default:d(()=>[(r(!0),_(C,null,U(u.list,(t,z)=>(r(),_("div",{class:"config-form-item",key:z},[t.group==e.activeTab?(r(),_(C,{key:0},[t.type=="number"?(r(),f($,{label:t.title,type:t.type,modelValue:e.form[t.name],"onUpdate:modelValue":c=>e.form[t.name]=c,attr:{prop:t.name,...t.extend},"input-attr":{...t.input_extend},tip:t.tip,key:"number-"+t.id},null,8,["label","type","modelValue","onUpdate:modelValue","attr","input-attr","tip"])):t.type=="editor"?(r(),f($,{label:t.title,type:t.type,onKeyup:[o[0]||(o[0]=b(v(()=>{},["stop"]),["enter"])),o[1]||(o[1]=b(v(c=>k(),["ctrl"]),["enter"]))],modelValue:e.form[t.name],"onUpdate:modelValue":c=>e.form[t.name]=c,attr:{prop:t.name,...t.extend},"input-attr":{style:{zIndex:99},...t.input_extend},tip:t.tip,key:"editor-"+t.id},null,8,["label","type","modelValue","onUpdate:modelValue","attr","input-attr","tip"])):t.type=="textarea"?(r(),f($,{label:t.title,type:t.type,onKeyup:[o[2]||(o[2]=b(v(()=>{},["stop"]),["enter"])),o[3]||(o[3]=b(v(c=>k(),["ctrl"]),["enter"]))],modelValue:e.form[t.name],"onUpdate:modelValue":c=>e.form[t.name]=c,attr:{prop:t.name,...t.extend},"input-attr":{rows:3,...t.input_extend},tip:t.tip,key:"textarea-"+t.id},null,8,["label","type","modelValue","onUpdate:modelValue","attr","input-attr","tip"])):(r(),f($,{label:t.title,type:t.type,modelValue:e.form[t.name],"onUpdate:modelValue":c=>e.form[t.name]=c,attr:{prop:t.name,...t.extend},"input-attr":g(Y)(t.content)?t.input_extend:{content:t.content,...t.input_extend},tip:t.tip,key:"other-"+t.id},null,8,["label","type","modelValue","onUpdate:modelValue","attr","input-attr","tip"])),D("div",pe,"$"+T(t.name),1),D("div",me,[t.allow_del?(r(),f(n,{key:0,onConfirm:c=>N(t),confirmButtonText:g(s)("Delete"),title:g(s)("routine.config.Are you sure to delete the configuration item?")},{reference:d(()=>[m(a,{class:"close-icon",size:"15",name:"el-icon-Close"})]),_:2},1032,["onConfirm","confirmButtonText","title"])):y("",!0)])],64)):y("",!0)]))),128)),u.name=="mail"?(r(),_("div",ge,[m(l,{onClick:o[4]||(o[4]=t=>P())},{default:d(()=>[A(T(g(s)("routine.config.Test mail sending")),1)]),_:1})])):y("",!0),m(l,{type:"primary",onClick:o[5]||(o[5]=t=>k())},{default:d(()=>[A(T(g(s)("Save")),1)]),_:1})]),_:2},1032,["name","label"]))),128)),m(x,{name:"add_config",class:"config-tab-pane config-tab-pane-add",label:g(s)("routine.config.Add configuration item")},null,8,["label"])]),_:1},8,["modelValue"])]),_:1},8,["model","rules"]))]),_:1}),m(S,{xs:24,sm:8},{default:d(()=>[m(M,{header:g(s)("routine.config.Quick configuration entry")},{default:d(()=>[(r(!0),_(C,null,U(e.quickEntrance,(u,w)=>(r(),f(l,{class:"config_quick_entrance",key:w},{default:d(()=>[D("div",{onClick:t=>g(de)({name:u.value})},T(u.key),9,_e)]),_:2},1024))),128))]),_:1},8,["header"])]),_:1})]),_:1})),[[R,e.loading]]),e.loading?y("",!0):(r(),f(re,{key:0,modelValue:e.showAddForm,"onUpdate:modelValue":o[9]||(o[9]=u=>e.showAddForm=u),"config-group":e.configGroup},null,8,["modelValue","config-group"]))])}}}),he=ae(ye,[["__scopeId","data-v-b622c3f8"]]);export{he as default};
